
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>ChefFirstImpression - Gosuke Miyashita</title>
  <meta name="author" content="Gosuke Miyashita">

  
  <meta name="description" content="Puppet 作者 Luke Kanies 氏のブログエントリ にて、Puppet の競合となる Chef というソフトウェアについて触れられていた。 ソフトウェアのポジション的にも、使われている用語的にも、かなり Puppet を意識している模様。開発言語が Ruby という点も Puppet &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mizzy.org/blog/2009/05/05/ChefFirstImpression">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Gosuke Miyashita" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-53984-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Gosuke Miyashita</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mizzy.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">ChefFirstImpression</h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-05-05T14:45:58+09:00" pubdate>May 5<span>th</span>, 2009</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Puppet 作者 <a href="http://madstop.com/2009/01/16/opscode-announces-chef-a-puppet-competitor/">Luke Kanies 氏のブログエントリ</a> にて、Puppet の競合となる <a href="http://wiki.opscode.com/display/chef/Home">Chef</a> というソフトウェアについて触れられていた。</p>

<p>ソフトウェアのポジション的にも、使われている用語的にも、かなり Puppet を意識している模様。開発言語が Ruby という点も Puppet と同じ。</p>

<p>Luke 氏としては、Puppet を散々使っていながらあまりコードに貢献することなしに、新しいプロジェクトを立ち上げるってどうなのよ、とか、競合が存在するのはいいことなんだけど、 そんなたくさん競合がある分野じゃないんだから、もっと色々話してくれてもいいのに、といった不満があるみたい。</p>

<p>また、名前が SEO 的にまずいよね、自分もそれで苦労した、といったことや、Puppet が外部 DSL なのに対し、Chef は内部 DSL なんだけどそれってどうなのよ、的なことも書いてますね。自分も外部 DSL の方が、制限があるけどわかりやすくていいんじゃないかとは思ってます。</p>

<p>で、&#8221;I’m not afraid of competition.&#8221; と言っていて、Puppet の競合なんて笑わせるぜ、的なことを言ってる（実際にこういうニュアンスかはよくわからないけど）わけですが、やはり気にはなるので試してみました。</p>

<p>最初は CentOS 5.2 で環境作ろうとしてたんですが、あまりにも面倒で挫折したので、<a href="http://wiki.opscode.com/display/chef/Installation">インストールガイド</a> で対象としてる Ubuntu で試してみました。</p>

<h1>インストール手順</h1>

<p>今回はひとつの Ubuntu 8.10 VM 上で、サーバ/クライアント両方を兼ねる形でセットアップしました。基本的には <a href="http://wiki.opscode.com/display/chef/Installation">インストールガイド</a> にある通りなんですが、いくつか説明通りではうまくいかなかった点があるので、その点をここで補足しておきます。</p>

<p>「Install Ruby and Rubygems」では、libhttp-access2-ruby も合わせてインストールしておく必要があります。</p>

<pre><code>$ sudo apt-get install ruby ruby1.8-dev rubygems build-essential libhttp-access2-ruby
</code></pre>

<p>また、「Bring up the Chef Server」にある、</p>

<pre><code>$ sudo chef-solo -r http://wiki.opscode.com/download/attachments/1179839/chef-server-install-solo.tar.gz
</code></pre>

<p>ですが、これをそのまま実行しても、エラーが出て途中で止まってしまいました。この手順では、chef-solo というスタンドアローンな chef クライアントを使って、chef に必要となるパッケージをインストールし、初期化等を行っているのですが、runit パッケージと couchdb パッケージのインストール部分でこけてました。なので、まずは一度上記コマンドを実行してエラーが出た後に、この2つのパッケージを手動でインストールしておきます。</p>

<pre><code>$ sudo apt-get install runit couchdb
</code></pre>

<p>それから、http://wiki.opscode.com/download/attachments/1179839/chef-server-install-solo.tar.gz の展開先にある二つのファイルを修正し、runit と couchdb をインストールしている部分をコメントアウトします。</p>

<p>/tmp/chef-solo/cookbooks/runit/recipes/default.rb</p>

<pre><code>#  package "runit" do
#    action :install
#    notifies :run, resources(:execute =&gt; "start-runsvdir")
#  end
</code></pre>

<p>/tmp/chef-solo/cookbooks/chef/recipes/server.rb</p>

<pre><code>#package "couchdb"
</code></pre>

<p>修正後、ファイルを tar.gz で固めます。</p>

<pre><code>$ cd /tmp
$ tar cvf chef-solo.tar chef-solo
$ gzip chef-solo.tar
</code></pre>

<p>その後この tar.gz ファイルを指定して、chef-solo を走らせます。</p>

<pre><code>$ sudo chef-solo -r /tmp/chef-solo.tar.gz
</code></pre>

<p>これでインストールは完了し、ウェブブラウザで 4000 番ポートにアクセスすることができるようになります。</p>

<h1>Chef Repository の作成</h1>

<p>インストールの次に行うのは、<a href="http://wiki.opscode.com/display/chef/Chef+Repository">Chef Repository の作成</a> です。Chef Repository とは、Chef でサーバ管理をするために必要な Cookbooks(Puppet でいうマニフェス）や設定ファイル等を管理するためのリポジトリです。</p>

<p>ここも基本的には <a href="http://wiki.opscode.com/display/chef/Chef+Repository">Wiki の手順書</a> の通りなので、その通りに実行すればいいだけなんですが、いくつか補足を。</p>

<p>リポジトリの雛形を作成するところは、git clone してますので、当然 git が必要となります。なので、あらかじめインストールしておきます。</p>

<pre><code>$ sudo apt-get install git git-core
</code></pre>

<p>rake new_cookbook してる手順ですが、これは cookbook の雛形となるファイルを生成してくれます。</p>

<pre><code>$ rake new_cookbook COOKBOOK=apache
(in /home/mizzy/chef-repo)
</code></pre>

<p>** Creating cookbook apache</p>

<p>を実行すると、以下のようなディレクトリ/ファイルが生成されます。</p>

<pre><code>$ ls -FR cookbooks/apache/
cookbooks/apache/:
attributes/  definitions/  files/  libraries/  recipes/  templates/

cookbooks/apache/attributes:

cookbooks/apache/definitions:

cookbooks/apache/files:
default/

cookbooks/apache/files/default:

cookbooks/apache/libraries:

cookbooks/apache/recipes:
default.rb

cookbooks/apache/templates:
default/

cookbooks/apache/templates/default: 
</code></pre>

<p>例えば、cookbooks/apache/recipes/default.rb の内容は以下のようになってます。</p>

<pre><code>#
# Cookbook Name:: apache
# Recipe:: default
#
# Copyright 2009, Example Com
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
</code></pre>

<p>rake install を実行すると、作成/編集した cookbooks を /var/chef/cookbooks の下に配置してくれたり、cofig/server.rb, client.rb, solo.rb を /etc/chef の下に配置してくれたりします。なので、雛形を git clone したままだと、勝手に設定が書き換えられるので注意が必要です。</p>

<p>実行時には、rake update (upstream リポジトリからの pull) と rake test も合わせて実行してくれ、sudo も自動的に実行してくれます。実行した結果は以下のようになります。</p>

<pre><code>$ rake install
(in /home/mizzy/chef-repo)
</code></pre>

<p>** Updating your repository</p>

<pre><code>Already up-to-date.
</code></pre>

<p>** Testing your cookbooks for syntax errors</p>

<pre><code>Testing recipe /home/mizzy/chef-repo/cookbooks/apache/recipes/default.rb: Syntax OK
</code></pre>

<p>** Installing your cookbooks
* Creating Directories
* Installing new Cookbooks</p>

<pre><code>sending incremental file list
README
          54 100%    0.00kB/s    0:00:00 (xfer#1, to-check=10/12)
apache/
apache/attributes/
apache/definitions/
apache/files/
apache/files/default/
apache/libraries/
apache/recipes/
apache/recipes/default.rb
         628 100%   18.04kB/s    0:00:00 (xfer#2, to-check=1/12)
apache/templates/
apache/templates/default/

sent 1063 bytes  received 86 bytes  2298.00 bytes/sec
total size is 682  speedup is 0.59
</code></pre>

<ul>
<li>Installing new Site Cookbooks
  sending incremental file list
  README

<pre><code>        96 100%    0.00kB/s    0:00:00 (xfer#1, to-check=0/2)
</code></pre>

<p>  sent 178 bytes  received 31 bytes  418.00 bytes/sec
  total size is 96  speedup is 0.46</p></li>
<li>Installing new Chef Server Config</li>
<li>Installing new Chef Client Config</li>
</ul>


<h1>Chef クライアント のサーバへの登録</h1>

<p>Chef クライアントを動作させるためには、まずは Chef サーバへのノード登録が必要となります。手順は http://wiki.opscode.com/display/chef/Nodes#Nodes-RegistrationviatheWebUI の通りで、サーバの 4000 番ポートにブラウザでアクセスし、</p>

<ol>
<li>右上の「Login」をクリックして、OpenID でログインする</li>
<li>上部の「Registration」をクリックする</li>
<li>対象となるノードの「Validation」をクリックする</li>
</ol>


<p>で完了です。</p>

<p>ここで気になるのは、OpenID でログインするので、有効な OpenID アカウントさえ持っていれば、とりあえずログインできちゃうんですよね。なので、デフォルトで誰でもログインできちゃうような状態なんで、これはまずいだろ、と。</p>

<p>それから、<a href="http://wiki.opscode.com/display/chef/Nodes#Nodes-NodeshaveOpenIDs">Nodes have OpenIDs</a> のところを読むと、内部的に Chef サーバがノードを認証するための仕組みとしても OpenID を使っているみたいなんだけど、そのメリットとか意図がさっぱりわからない。</p>

<h1>cookbook を 作成して Chef クライアントに適用する</h1>

<p>サンプル cookbook の作成の仕方は、<a href="http://wiki.opscode.com/display/chef/Quick+Start">Quick Start</a> を参照すれば OK です。ここでは特に補足しません。</p>

<p>わかりにくいのが、作成した cookbook を特定のノードに適用する方法。Puppet だと以下のようなやつ。</p>

<pre><code>node 'client.example.org' {
    include apache
}
</code></pre>

<p>これには <a href="http://wiki.opscode.com/display/chef/Nodes#Nodes-ManagingNodesviatheWebUI">ウェブ UI を利用する方法</a> と <a href="http://wiki.opscode.com/display/chef/Nodes#Nodes-ManagingNodesthroughJSONatthecommandline">chef-client コマンドを利用する方法</a> があります。</p>

<p>ウェブ UI の方では、上部メニューの「Nodes」をクリックし、該当するノードを選択。するとノードに関する詳細情報が表示されるので、適当なところをクリック。すると、テキストエリアに以下のように JSON 形式で内容が表示されて編集可能に。</p>

<pre><code>{
  "name": "ubuntu",
  "_rev": "4279229607",
  "attributes": {
    "kernel": {
      "machine": "i686",
      "name": "Linux",
      "os": "GNU\/Linux",
      "version": "#1 SMP Thu Nov 20 21:57:00 UTC 2008",
      "release": "2.6.27-9-generic"
    },

    ... 中略 ...

    "uptime": "4 hours 56 minutes 03 seconds",
    "platform": "ubuntu",
    "block_device": {
      "ram13": {
        "size": "131072",
        "removable": "0"
      },

      ... 中略 ...

      "ram9": {
        "size": "131072",
        "removable": "0"
      }
    },
    "uptime_seconds": 17763
  },
  "json_class": "Chef::Node",
  "recipes": [

  ],
  "chef_type": "node"
}
</code></pre>

<p>この下のほうにある「recipes」ところに、適用したい cookbook を追加して、save すれば OK らしいのですが、うちの環境ではうまく save ができませんでした。</p>

<p>chef-client コマンドを使う方法では、</p>

<pre><code>$ sudo chef-client -j node.json
</code></pre>

<p>といった形で、JSON ファイルをロードできるようなのですが、この方法でもうまくいかず、結局試すことができませんでした。また後ほど環境作り直して再チャレンジの予定。</p>

<h1>まとめ</h1>

<p>ここまでざっと使ってみた感想をまとめてみます。</p>

<ul>
<li>セットアップがめんどくさい。Puppet は Ruby と Facter があれば OK なのに対し、Chef はいろいろなものが必要。特に CouchDB は、CentOS 5 用のパッケージがなく、パッケージ作るのも大変そうだったので、今回は諦めた。（誰かパッケージの在り処を知っていったら教えてください。）</li>
<li>OpenID をつかってる意味がよくわからない。誰か教えて。</li>
<li>ウェブ UI は必要ない。すべてコマンドラインで完結してくれるほうがうれしい。</li>
<li>Chef Repository の考え方ははよさげ。

<ul>
<li>Rakefile を覗いてみると、git と subversion に対応してるみたい。</li>
<li>rake コマンド で特定のタスクを実行できるのもいい。</li>
<li>git に対応してるのは、外部の人たちと cookbooks を共有するのに良さげ。ただ、システム管理者に git 使わせるのは厳しいかも。</li>
</ul>
</li>
<li>内部 DSL よりも外部 DSL の方が、制限がある分逆に誰が書いても同じような記述になるし、分かりやすいと思うので、特にメンテナンスや他メンバーとの共有を考えると、外部 DSL である Puppet の方が個人的には好き。</li>
</ul>


<p>今のところ、まだ Puppet からの乗換えを検討しようとは思わないけど、今後ウォッチしていこうと思います。</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Gosuke Miyashita</span></span>

      




  

<time datetime="2009-05-05T14:45:58+09:00" pubdate>May 5<span>th</span>, 2009</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://mizzy.org/blog/2009/05/05/ChefFirstImpression/" data-via="" data-counturl="http://mizzy.org/blog/2009/05/05/ChefFirstImpression/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2009/03/21/SoftwareDesign200904/" title="Previous Post: SoftwareDesign200904">&laquo; SoftwareDesign200904</a>
      
      
        <a class="basic-alignment right" href="/blog/2009/05/10/AddModRewriteInternalFunction/" title="next Post: AddModRewriteInternalFunction">AddModRewriteInternalFunction &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/01/13/coderwall-badges-on-the-sidebar/">coderwall badges on the sidebar</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/10/webiblo-web-to-ebook-project-en/">Webiblo - web to ebook project</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/10/webiblo-web-to-ebook-project/">Webiblo - web to ebook project</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/09/web-to-mobi-a-script-for-converting-web-sites-to-mobipocket-format/">Web-to-mobi - A script for converting web sites to mobipocket format</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/06/weechat-script-for-pushing-notification-to-im-dot-kayac-dot-com/">WeeChat script for pushing notification to im.kayac.com</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Coderwall</h1>
  <p>
  <script type="text/javascript">
    function display_coderwall(args) {
        var badges = args["data"]["badges"];
        for ( var i = 0; i < badges.length; i++ ) {
            document.write('<img src="'+ badges[i]["badge"] + '" width="48" height="48" />');
        }
    }
  </script>
  <script src="http://coderwall.com/mizzy.json?callback=display_coderwall"></script>
  </p>
  <p style="text-align: right;"><a href="http://coderwall.com/mizzy">Powered by coderwall.com</a></p>
</section>


<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/mizzy">@mizzy</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'mizzy',
            count: 30,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>




  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Gosuke Miyashita -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mizzyorg';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
