<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>
      least - TerraformコードからIAMポリシーを自動生成するツール - Gosuke Miyashita
    </title>
    <!-- TODO: change name and description -->
    <meta name="author" content="Gosuke Miyashita"/>
    <meta name="description" content="A fantastic blog that is fantastic."/>
    <!-- OGP -->
    <meta property="og:title" content="least - TerraformコードからIAMポリシーを自動生成するツール"/>
    <meta property="og:type" content="article"/>
    <meta property="og:url" content="https://mizzy.org/blog/2026/02/01/1/"/>
    <meta property="og:image" content="https://mizzy.org/blog/2026/02/01/1/ogp.png"/>
    <meta property="og:site_name" content="Gosuke Miyashita"/>
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:title" content="least - TerraformコードからIAMポリシーを自動生成するツール"/>
    <meta name="twitter:image" content="https://mizzy.org/blog/2026/02/01/1/ogp.png"/>
    <link rel="alternate" type="application/rss+xml" href="/atom.xml"/>
    <link rel="stylesheet" href="/css/base.css" type="text/css" media="screen, projection"/>
    <link rel="stylesheet" href="/css/chroma.css" type="text/css"/>
    <link media="only screen and (max-device-width: 480px)" href="/css/iphone.css" type="text/css" rel="stylesheet"/>
    <link media="only screen and (device-width: 768px)" href="/css/iphone.css" type="text/css" rel="stylesheet"/>
    <link href='https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz' rel='stylesheet' type='text/css'>
    <link rel="apple-touch-icon" href="/apple-touch-icon.png"/>
    <link rel="icon" href="/favicon.png" type="image/png"/>
  </head>
  <body>
    <section class="sidebar">
      <a href="/">
        <!-- TODO: change this gravatar URL -->
        <img src="https://s.gravatar.com/avatar/0d5d8fb9cc4c06f581825f5a61d3f5f1?s=150" height="75" width="75"
             class="avatar"/>
      </a>
      <!-- TODO: change name -->
      <section class="name">
        <a href="/">
          <span id="zach">
            Gosuke
          </span>
          <span id="holman">
            Miyashita
          </span>
        </a>
      </section>
      <!-- TODO: change links -->
      <section class="meta">
        <a href="https://github.com/mizzy">
          <img src="/images/github.png"/>
        </a>
        <a href="https://twitter.com/gosukenator">
          <img src="/images/twitter.png">
        </a>
        <a href="/atom.xml">
          <img src="/images/rss.png"/>
        </a>
      </section>
      <!--
    <section class="sections">
      <ul>
        <li><a href="/about.html">about</a></li>
        <li><a href="/">posts</a></li>
      </ul>
    </section>
    -->
    </section>
    <section class="content autopagerize_page_element">
      <h1>
        <a href="/blog/2026/02/01/1">
          least - TerraformコードからIAMポリシーを自動生成するツール
        </a>
      </h1>
      <section class="byline">
        2026-02-01 09:20:53 +0900
      </section>
      <p>
        <a href="https://github.com/mizzy/least">
          least
        </a>
        というツールをつくっている。Terraformのコードをみて、plan/applyに必要な権限を持つIAMポリシーを自動生成するツール。
      </p>
      <hr />
      <h2>
        きっかけ
      </h2>
      <p>
        TerraformでGitHub Actions等から自動plan/applyを実行する際、plan/apply用ロールのIAMポリシーをどうするのが良いのか、いつも悩む。最小権限の原則は理想ではあるが、必要な権限を手動で調べてポリシーを作成するのは非常に面倒で、果たしてその苦労に見合うのか、と常々思っている。
      </p>
      <p>
        最初に大きめの権限を与えておいて、IAM Access Analyzerを利用して後から権限を絞る、というアプローチもあるが、できれば最初から最小権限に近い状態で始めたい。
      </p>
      <p>
        そんなことを考えていたところ、
        <a href="https://github.com/mizzy/carina">
          Carina
        </a>
        のawscc provider開発中に、
        <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/TemplateReference/resource-type-schemas.html">
          CloudFormation resource provider schema
        </a>
        には各リソースタイプの作成・更新・削除に必要なIAMアクションが
        <code>handlers</code>
        という属性で定義されている、ということに気づいた。
      </p>
      <p>
        例えば、S3バケット（
        <code>AWS::S3::Bucket</code>
        ）のスキーマでは
        <code>handlers</code>
        は以下のように定義されている。
      </p>
      <pre class="chroma"><code><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;create&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;permissions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;s3:CreateBucket&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;s3:PutBucketTagging&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;...&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;read&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;permissions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;s3:GetAccelerateConfiguration&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;s3:GetLifecycleConfiguration&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;...&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;update&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;permissions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;s3:PutBucketAcl&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;s3:PutBucketTagging&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;...&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;delete&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;permissions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;s3:DeleteBucket&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;s3:ListBucket&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;list&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;permissions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;s3:ListAllMyBuckets&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre>
      <p>
        この情報を活用すればTerraformコードから必要なIAMポリシーを自動生成でき、労せず最小権限の原則を満たせるのでは、と思いついた。
      </p>
      <p>
        思いついた時は
        <a href="https://2026.srekaigi.net/">
          SRE Kaigi 2026
        </a>
        に参加中でPCを持参していなかったので、
        <a href="https://code.claude.com/docs/ja/claude-code-on-the-web">
          Claude Code on the web
        </a>
        にスマホからアクセスし、こんなのつくって、とお願いしてつくってもらった。
      </p>
      <p>
        ちなみにまだコードは見てないし、動作確認もしてない。
      </p>
      <h2>
        機能
      </h2>
      <p>
        機能的には、TerraformコードでIAMポリシーを生成する
        <code>generate</code>
        コマンドと、既存のIAMポリシーが持つ権限がTerraformコードに対して過不足がないかチェックする
        <code>check</code>
        コマンドを提供している。
        <code>check</code>
        コマンドは主にCIでの利用を想定している。
      </p>
      <h2>
        今後
      </h2>
      <p>
        まだ動作確認すらしてないので、とりあえず動作確認するところから。
      </p>
      <div class="pagination">
        <a href="/blog/2026/01/30/2" rel="next">
          older post ↓
        </a>
      </div>
    </section>
  </body>
</html>