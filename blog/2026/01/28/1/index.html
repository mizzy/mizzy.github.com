<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>
      Carina State Management - Gosuke Miyashita
    </title>
    <!-- TODO: change name and description -->
    <meta name="author" content="Gosuke Miyashita"/>
    <meta name="description" content="A fantastic blog that is fantastic."/>
    <!-- OGP -->
    <meta property="og:title" content="Carina State Management"/>
    <meta property="og:type" content="article"/>
    <meta property="og:url" content="https://mizzy.org/blog/2026/01/28/1/"/>
    <meta property="og:image" content="https://mizzy.org/blog/2026/01/28/1/ogp.png"/>
    <meta property="og:site_name" content="Gosuke Miyashita"/>
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:title" content="Carina State Management"/>
    <meta name="twitter:image" content="https://mizzy.org/blog/2026/01/28/1/ogp.png"/>
    <link rel="alternate" type="application/rss+xml" href="/atom.xml"/>
    <link rel="stylesheet" href="/css/base.css" type="text/css" media="screen, projection"/>
    <link rel="stylesheet" href="/css/chroma.css" type="text/css"/>
    <link media="only screen and (max-device-width: 480px)" href="/css/iphone.css" type="text/css" rel="stylesheet"/>
    <link media="only screen and (device-width: 768px)" href="/css/iphone.css" type="text/css" rel="stylesheet"/>
    <link href='https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz' rel='stylesheet' type='text/css'>
    <link rel="apple-touch-icon" href="/apple-touch-icon.png"/>
    <link rel="icon" href="/favicon.png" type="image/png"/>
  </head>
  <body>
    <section class="sidebar">
      <a href="/">
        <!-- TODO: change this gravatar URL -->
        <img src="https://s.gravatar.com/avatar/0d5d8fb9cc4c06f581825f5a61d3f5f1?s=150" height="75" width="75"
             class="avatar"/>
      </a>
      <!-- TODO: change name -->
      <section class="name">
        <a href="/">
          <span id="zach">
            Gosuke
          </span>
          <span id="holman">
            Miyashita
          </span>
        </a>
      </section>
      <!-- TODO: change links -->
      <section class="meta">
        <a href="https://github.com/mizzy">
          <img src="/images/github.png"/>
        </a>
        <a href="https://twitter.com/gosukenator">
          <img src="/images/twitter.png">
        </a>
        <a href="/atom.xml">
          <img src="/images/rss.png"/>
        </a>
      </section>
      <!--
    <section class="sections">
      <ul>
        <li><a href="/about.html">about</a></li>
        <li><a href="/">posts</a></li>
      </ul>
    </section>
    -->
    </section>
    <section class="content autopagerize_page_element">
      <h1>
        <a href="/blog/2026/01/28/1">
          Carina State Management
        </a>
      </h1>
      <section class="byline">
        2026-01-28 21:40:00 +0900
      </section>
      <p>
        <a href="https://github.com/mizzy/carina">
          Carina
        </a>
        にS3バックエンドによるState管理機能を実装した。
      </p>
      <hr />
      <h2>
        背景
      </h2>
      <p>
        Terraform Stateと同等の機能はやっぱり必要だよね、ということで、CarinaにもState管理機能とS3バックエンドを実装した。
      </p>
      <hr />
      <h2>
        DSL構文
      </h2>
      <p>
        バックエンド設定は以下のように記述する。ほぼTerraformと同じ。
      </p>
      <pre class="chroma"><code><span class="line"><span class="cl"><span class="k">backend</span> <span class="nv">s3</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">bucket</span>      <span class="o">=</span> <span class="s2">&#34;my-carina-state&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">key</span>         <span class="o">=</span> <span class="s2">&#34;prod/carina.crnstate&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">encrypt</span>     <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">  <span class="nv">auto_create</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre>
      <p>
        <code>auto_create = true</code>
        はTerraformにはない機能。Terraformでは、Stateを保存するS3バケットは事前に作成しておく必要がある。Carinaでは
        <code>auto_create</code>
        を有効にすると、初回
        <code>apply</code>
        時にバケットが自動作成され、さらにそのバケットのリソース定義が
        <code>.crn</code>
        ファイルに自動で追加される。
      </p>
      <hr />
      <h2>
        Stateファイル
      </h2>
      <p>
        StateファイルはJSON形式で、以下のような構造になっている。とりあえずClaude Codeに適当に決めてもらった。後で色々変えることになると思う。
      </p>
      <pre class="chroma"><code><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;serial&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;lineage&#34;</span><span class="p">:</span> <span class="s2">&#34;358893ec-5a07-49bf-acbc-940d9563c7f5&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;carina_version&#34;</span><span class="p">:</span> <span class="s2">&#34;0.1.0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;resources&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;resource_type&#34;</span><span class="p">:</span> <span class="s2">&#34;s3.bucket&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;my-bucket&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;provider&#34;</span><span class="p">:</span> <span class="s2">&#34;aws&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;attributes&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;my-bucket&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;region&#34;</span><span class="p">:</span> <span class="s2">&#34;ap-northeast-1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;versioning&#34;</span><span class="p">:</span> <span class="s2">&#34;Enabled&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;protected&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre>
      <ul>
        <li>
          <code>serial</code>
          : 変更のたびにインクリメントされる
        </li>
        <li>
          <code>lineage</code>
          : 状態ファイルの系譜を識別するUUID（誤上書き防止）
        </li>
        <li>
          <code>protected</code>
          : trueの場合、
          <code>destroy</code>
          で削除されない
        </li>
      </ul>
      <hr />
      <h2>
        plan
      </h2>
      <p>
        <code>plan</code>
        実行時に、Stateバケットが作成されることが
        <code>Bootsrap Plan:</code>
        として表示される。
      </p>
      <p>
        <img src="/images/2026/01/carina-state-bootstrap.png" alt="carina plan の出力" />
      </p>
      <hr />
      <h2>
        apply
      </h2>
      <p>
        apply実行時に、Stateバケットが自動作成される。
      </p>
      <p>
        <img src="/images/2026/01/carina-state-apply.png" alt="carina apply の出力" />
      </p>
      <p>
        また、backendが定義されているファイルに、Stateバケットのリソース定義が自動追加される。
      </p>
      <pre class="chroma"><code><span class="line"><span class="cl"><span class="c"># Auto-generated by carina (state bucket)</span>
</span></span><span class="line"><span class="cl"><span class="nc">aws.s3.bucket</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">name</span>       <span class="o">=</span> <span class="s2">&#34;my-carina-state&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">versioning</span> <span class="o">=</span> <span class="s2">&#34;Enabled&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre>
      <hr />
      <h2>
        destroy
      </h2>
      <p>
        StateバケットはState内で
        <code>protected</code>
        フラグが設定されるため、通常の
        <code>destroy</code>
        では削除されない。
      </p>
      <p>
        <img src="/images/2026/01/carina-state-destroy.png" alt="carina destroy の出力" />
      </p>
      <p>
        「⚠ s3.bucket.carina-state-test-mizzy (protected - will be skipped)」と表示され、destroy対象からスキップされる。
      </p>
      <p>
        Stateバケットを削除したい場合は、
        <code>state bucket-delete</code>
        コマンドを使う。
      </p>
      <pre class="chroma"><code><span class="line"><span class="cl">$ carina state bucket-delete &lt;bucket-name&gt; --force
</span></span></code></pre>
      <hr />
      <h2>
        state lock/unlock
      </h2>
      <p>
        チーム開発にはstate lock/unlockは必要だよね、ってことでTerraformのようなstate lock/unlock機能も実装した。
      </p>
      <hr />
      <h2>
        今後
      </h2>
      <p>
        Terraform Stateに関する不満として一番大きいのは、やはりstate refreshの速度だと思う。
        <a href="https://mizzy.org/blog/2022/03/24/1/">
          Terraform State Refreshの高速化手法と実装
        </a>
        という記事で、高速化するための手法や実装をいくつか挙げたが、あくまでもTerraformを前提としたものだった。Carinaではその前提が取っ払えるので、もっとよい形での高速化が実現できるかもしれないし、できないかもしれない。今後の課題として取り組んでいきたい。
      </p>
      <div class="pagination">
        <a href="/blog/2026/01/29/1">
          ↑ newer post
        </a>
        <a href="/blog/2026/01/27/2" rel="next">
          older post ↓
        </a>
      </div>
    </section>
  </body>
</html>