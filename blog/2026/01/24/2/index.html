<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>
      AWS Cloud Control APIは遅い？ - Gosuke Miyashita
    </title>
    <!-- TODO: change name and description -->
    <meta name="author" content="Gosuke Miyashita"/>
    <meta name="description" content="A fantastic blog that is fantastic."/>
    <!-- OGP -->
    <meta property="og:title" content="AWS Cloud Control APIは遅い？"/>
    <meta property="og:type" content="article"/>
    <meta property="og:url" content="https://mizzy.org/blog/2026/01/24/2/"/>
    <meta property="og:image" content="https://mizzy.org/blog/2026/01/24/2/ogp.png"/>
    <meta property="og:site_name" content="Gosuke Miyashita"/>
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:title" content="AWS Cloud Control APIは遅い？"/>
    <meta name="twitter:image" content="https://mizzy.org/blog/2026/01/24/2/ogp.png"/>
    <link rel="alternate" type="application/rss+xml" href="/atom.xml"/>
    <link rel="stylesheet" href="/css/base.css" type="text/css" media="screen, projection"/>
    <link rel="stylesheet" href="/css/chroma.css" type="text/css"/>
    <link media="only screen and (max-device-width: 480px)" href="/css/iphone.css" type="text/css" rel="stylesheet"/>
    <link media="only screen and (device-width: 768px)" href="/css/iphone.css" type="text/css" rel="stylesheet"/>
    <link href='https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz' rel='stylesheet' type='text/css'>
    <link rel="apple-touch-icon" href="/apple-touch-icon.png"/>
    <link rel="icon" href="/favicon.png" type="image/png"/>
  </head>
  <body>
    <section class="sidebar">
      <a href="/">
        <!-- TODO: change this gravatar URL -->
        <img src="https://s.gravatar.com/avatar/0d5d8fb9cc4c06f581825f5a61d3f5f1?s=150" height="75" width="75"
             class="avatar"/>
      </a>
      <!-- TODO: change name -->
      <section class="name">
        <a href="/">
          <span id="zach">
            Gosuke
          </span>
          <span id="holman">
            Miyashita
          </span>
        </a>
      </section>
      <!-- TODO: change links -->
      <section class="meta">
        <a href="https://github.com/mizzy">
          <img src="/images/github.png"/>
        </a>
        <a href="https://twitter.com/gosukenator">
          <img src="/images/twitter.png">
        </a>
        <a href="/atom.xml">
          <img src="/images/rss.png"/>
        </a>
      </section>
      <!--
    <section class="sections">
      <ul>
        <li><a href="/about.html">about</a></li>
        <li><a href="/">posts</a></li>
      </ul>
    </section>
    -->
    </section>
    <section class="content autopagerize_page_element">
      <h1>
        <a href="/blog/2026/01/24/2">
          AWS Cloud Control APIは遅い？
        </a>
      </h1>
      <section class="byline">
        2026-01-24 18:40:23 +0900
      </section>
      <p>
        <a href="https://github.com/mizzy/carina">
          Carina
        </a>
        の開発中に、AWS Cloud Control APIが遅いことに気づいた。
      </p>
      <hr />
      <h2>
        Cloud Control APIを試した背景
      </h2>
      <p>
        CarinaでAWSリソースを扱うにあたり、最初はaws-sdk-s3を使ってS3バケットの操作を実装していた。ただ、この方法だとリソースタイプごとに個別実装が必要になる。S3、EC2、IAM...とAWSのサービスは膨大にあるので、全部個別に実装するのは大変だ。生成AIがあるとはいえ、もっと楽にできないかと考えた。
      </p>
      <p>
        そこで
        <a href="https://docs.aws.amazon.com/cloudcontrolapi/latest/userguide/what-is-cloudcontrolapi.html">
          Cloud Control API
        </a>
        を使うことを考えた。Cloud Control APIは、CloudFormationと同じリソースハンドラーを使った統一的なAPIで、様々なAWSリソースをCRUD操作できる。
      </p>
      <p>
        Cloud Control APIを使う大きなメリットとして、CloudFormationのJSON Schemaが公開されていることがある。例えばS3バケットのスキーマは以下のコマンドで取得できる。
      </p>
      <pre class="chroma"><code><span class="line"><span class="cl">aws cloudformation describe-type --type RESOURCE <span class="se">\
</span></span></span><span class="line"><span class="cl">  --type-name AWS::S3::Bucket --query <span class="s1">&#39;Schema&#39;</span> --output text
</span></span></code></pre>
      <p>
        このスキーマを使えば、
        <a href="https://github.com/oxidecomputer/typify">
          typify
        </a>
        でRustの型を自動生成できる。生成した型を使ってバリデーションすれば、リソースごとに手動でバリデーションロジックを書く必要がなくなる。
      </p>
      <p>
        というわけで、Cloud Control APIを使うよう
        <a href="https://github.com/mizzy/carina/pull/2">
          実装してみた
        </a>
        。
      </p>
      <hr />
      <h2>
        問題発覚
      </h2>
      <p>
        S3バケットの
        <code>versioning_configuration</code>
        を変更する
        <code>apply</code>
        を実行したところ、完了までに20秒以上かかった。単純なプロパティ変更なのに遅すぎるのでは、と思って調べてみた。
      </p>
      <hr />
      <h2>
        計測結果
      </h2>
      <p>
        直接S3 APIを叩いた場合と、Cloud Control APIを叩いた場合で比較してみた。
      </p>
      <h3>
        直接S3 API
      </h3>
      <pre class="chroma"><code><span class="line"><span class="cl">$ <span class="nb">time</span> aws s3api put-bucket-versioning <span class="se">\
</span></span></span><span class="line"><span class="cl">  --bucket carina-test-logs-mizzy-2026 <span class="se">\
</span></span></span><span class="line"><span class="cl">  --versioning-configuration <span class="nv">Status</span><span class="o">=</span>Suspended
</span></span></code></pre>
      <p>
        所要時間:
        <strong>
          約0.4〜0.5秒
        </strong>
      </p>
      <h3>
        Cloud Control API
      </h3>
      <pre class="chroma"><code><span class="line"><span class="cl"><span class="nv">RESULT</span><span class="o">=</span><span class="k">$(</span>aws cloudcontrol update-resource <span class="se">\
</span></span></span><span class="line"><span class="cl">  --type-name <span class="s2">&#34;AWS::S3::Bucket&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl">  --identifier <span class="s2">&#34;carina-test-logs-mizzy-2026&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl">  --patch-document <span class="s1">&#39;[{&#34;op&#34;:&#34;replace&#34;,&#34;path&#34;:&#34;/VersioningConfiguration&#34;,&#34;value&#34;:{&#34;Status&#34;:&#34;Enabled&#34;}}]&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">REQUEST_TOKEN</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$RESULT</span><span class="s2">&#34;</span> <span class="p">|</span> jq -r <span class="s1">&#39;.ProgressEvent.RequestToken&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">START</span><span class="o">=</span><span class="k">$(</span>date +%s<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">while</span> true<span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="nv">STATUS</span><span class="o">=</span><span class="k">$(</span>aws cloudcontrol get-resource-request-status <span class="se">\
</span></span></span><span class="line"><span class="cl">    --request-token <span class="s2">&#34;</span><span class="nv">$REQUEST_TOKEN</span><span class="s2">&#34;</span> <span class="p">|</span> jq -r <span class="s1">&#39;.ProgressEvent.OperationStatus&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> <span class="s2">&#34;[</span><span class="k">$((</span> <span class="k">$(</span>date +%s<span class="k">)</span> <span class="o">-</span> START <span class="k">))</span><span class="s2">s] </span><span class="nv">$STATUS</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$STATUS</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;SUCCESS&#34;</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$STATUS</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;FAILED&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>
</span></span><span class="line"><span class="cl">  sleep <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre>
      <p>
        完了までの所要時間:
        <strong>
          約23秒
        </strong>
      </p>
      <hr />
      <h2>
        なぜ遅いのか
      </h2>
      <p>
        Cloud Control APIはCloudFormationと同じリソースハンドラーを使っており、内部的にリソースの整合性チェックや安定化待ち（resource stabilization）を行っているようだ。
      </p>
      <p>
        AWSの公式ブログ
        <a href="https://aws.amazon.com/blogs/devops/how-we-sped-up-aws-cloudformation-deployments-with-optimistic-stabilization/">
          How we sped up AWS CloudFormation deployments with optimistic stabilization
        </a>
        でも、CloudFormationのデプロイが遅い理由として「resource stabilization」に時間がかかることが説明されている。
      </p>
      <hr />
      <h2>
        まとめ
      </h2>
      <table>
        <thead>
          <tr>
            <th>
              方式
            </th>
            <th>
              所要時間
            </th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              直接S3 API
            </td>
            <td>
              約0.5秒
            </td>
          </tr>
          <tr>
            <td>
              Cloud Control API
            </td>
            <td>
              約23秒
            </td>
          </tr>
        </tbody>
      </table>
      <p>
        Cloud Control APIは統一的なインターフェースで様々なリソースを扱えるメリットがあるが、個別のAPIを直接叩くより大幅に遅い。速度が重要な場合は、リソースタイプごとに直接SDKを使う方がよさそう。
      </p>
      <p>
        Carinaでの採用はやめた。
      </p>
      <div class="pagination">
        <a href="/blog/2026/01/25/1">
          ↑ newer post
        </a>
        <a href="/blog/2026/01/24/1" rel="next">
          older post ↓
        </a>
      </div>
    </section>
  </body>
</html>