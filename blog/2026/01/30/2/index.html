<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>
      Carinaにデータソース機能を追加 - Gosuke Miyashita
    </title>
    <!-- TODO: change name and description -->
    <meta name="author" content="Gosuke Miyashita"/>
    <meta name="description" content="A fantastic blog that is fantastic."/>
    <!-- OGP -->
    <meta property="og:title" content="Carinaにデータソース機能を追加"/>
    <meta property="og:type" content="article"/>
    <meta property="og:url" content="https://mizzy.org/blog/2026/01/30/2/"/>
    <meta property="og:image" content="https://mizzy.org/blog/2026/01/30/2/ogp.png"/>
    <meta property="og:site_name" content="Gosuke Miyashita"/>
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:title" content="Carinaにデータソース機能を追加"/>
    <meta name="twitter:image" content="https://mizzy.org/blog/2026/01/30/2/ogp.png"/>
    <link rel="alternate" type="application/rss+xml" href="/atom.xml"/>
    <link rel="stylesheet" href="/css/base.css" type="text/css" media="screen, projection"/>
    <link rel="stylesheet" href="/css/chroma.css" type="text/css"/>
    <link media="only screen and (max-device-width: 480px)" href="/css/iphone.css" type="text/css" rel="stylesheet"/>
    <link media="only screen and (device-width: 768px)" href="/css/iphone.css" type="text/css" rel="stylesheet"/>
    <link href='https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz' rel='stylesheet' type='text/css'>
    <link rel="apple-touch-icon" href="/apple-touch-icon.png"/>
    <link rel="icon" href="/favicon.png" type="image/png"/>
  </head>
  <body>
    <section class="sidebar">
      <a href="/">
        <!-- TODO: change this gravatar URL -->
        <img src="https://s.gravatar.com/avatar/0d5d8fb9cc4c06f581825f5a61d3f5f1?s=150" height="75" width="75"
             class="avatar"/>
      </a>
      <!-- TODO: change name -->
      <section class="name">
        <a href="/">
          <span id="zach">
            Gosuke
          </span>
          <span id="holman">
            Miyashita
          </span>
        </a>
      </section>
      <!-- TODO: change links -->
      <section class="meta">
        <a href="https://github.com/mizzy">
          <img src="/images/github.png"/>
        </a>
        <a href="https://twitter.com/gosukenator">
          <img src="/images/twitter.png">
        </a>
        <a href="/atom.xml">
          <img src="/images/rss.png"/>
        </a>
      </section>
      <!--
    <section class="sections">
      <ul>
        <li><a href="/about.html">about</a></li>
        <li><a href="/">posts</a></li>
      </ul>
    </section>
    -->
    </section>
    <section class="content autopagerize_page_element">
      <h1>
        <a href="/blog/2026/01/30/2">
          Carinaにデータソース機能を追加
        </a>
      </h1>
      <section class="byline">
        2026-01-30 17:39:23 +0900
      </section>
      <p>
        <a href="https://github.com/mizzy/carina">
          Carina
        </a>
        に
        <code>read</code>
        キーワードを追加し、既存のインフラリソースを参照できるようにした。Terraformのdata sourceに相当する機能。
      </p>
      <h2>
        新しい構文
      </h2>
      <p>
        <code>read</code>
        キーワードを使って、既存のリソースを参照できる。
      </p>
      <pre class="chroma"><code><span class="line"><span class="cl"><span class="k">provider</span> <span class="nv">aws</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">region</span> <span class="o">=</span> <span class="no">aws.Region.ap_northeast_1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 既存のVPCを読み取る（データソース）</span>
</span></span><span class="line"><span class="cl"><span class="k">let</span> <span class="nv">existing_vpc</span> <span class="o">=</span> <span class="k">read</span> <span class="nc">aws.vpc</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">name</span> <span class="o">=</span> <span class="s2">&#34;production-vpc&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 既存のVPC内に新しいサブネットを作成</span>
</span></span><span class="line"><span class="cl"><span class="k">let</span> <span class="nv">app_subnet</span> <span class="o">=</span> <span class="nc">aws.subnet</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">name</span>              <span class="o">=</span> <span class="s2">&#34;app-subnet&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">vpc_id</span>            <span class="o">=</span> <span class="nv">existing_vpc</span><span class="p">.</span><span class="nv">id</span>
</span></span><span class="line"><span class="cl">  <span class="nv">cidr_block</span>        <span class="o">=</span> <span class="s2">&#34;10.0.100.0/24&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">availability_zone</span> <span class="o">=</span> <span class="nv">aws</span><span class="p">.</span><span class="err">A</span><span class="nv">vailability</span><span class="err">Z</span><span class="nv">one</span><span class="p">.</span><span class="nv">ap_northeast_1a</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre>
      <p>
        <code>read</code>
        で定義したリソースは、ライフサイクルを管理しない。作成・更新・削除は行わず、現在の状態を読み取るだけ。
      </p>
      <h2>
        プラン表示
      </h2>
      <p>
        <code>+</code>
        （作成）、
        <code>~</code>
        （更新）、
        <code>-</code>
        （削除）に加えて、
        <code>&lt;=</code>
        （読み取り）が表示される。(Ghostty上だと違う文字になってるけど)
      </p>
      <p>
        <img src="/images/2026-01-30-carina-data-source-plan.png" alt="プラン表示" />
      </p>
      <h2>
        実装
      </h2>
      <p>
        内部的には、
        <code>Resource</code>
        構造体に
        <code>read_only</code>
        フィールドを追加した。
      </p>
      <pre class="chroma"><code><span class="line"><span class="cl"><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Resource</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">id</span>: <span class="nc">ResourceId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">attributes</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">read_only</span>: <span class="kt">bool</span><span class="p">,</span><span class="w">  </span><span class="c1">// データソースの場合true
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre>
      <p>
        <code>Effect</code>
        列挙型の
        <code>Read</code>
        バリアントも変更し、リソース全体を保持するようにした。
      </p>
      <pre class="chroma"><code><span class="line"><span class="cl"><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">Effect</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Read</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">resource</span>: <span class="nc">Resource</span><span class="w"> </span><span class="p">},</span><span class="w">  </span><span class="c1">// 変更前: Read(ResourceId)
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Create</span><span class="p">(</span><span class="n">Resource</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Update</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">id</span>: <span class="nc">ResourceId</span><span class="p">,</span><span class="w"> </span><span class="n">from</span>: <span class="nc">State</span><span class="p">,</span><span class="w"> </span><span class="n">to</span>: <span class="nc">Resource</span><span class="w"> </span><span class="p">},</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Delete</span><span class="p">(</span><span class="n">ResourceId</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre>
      <p>
        パーサーは、
        <code>read</code>
        キーワードに続くリソース定義を解析し、
        <code>read_only = true</code>
        のリソースを生成する。プラン生成時、
        <code>read_only</code>
        なリソースは通常のdiff処理をスキップし、常に
        <code>Effect::Read</code>
        を生成する。
      </p>
      <h2>
        関連リンク
      </h2>
      <ul>
        <li>
          <a href="https://github.com/mizzy/carina/pull/35">
            Add read keyword for data sources by mizzy · Pull Request #35 · mizzy/carina
          </a>
        </li>
      </ul>
      <div class="pagination">
        <a href="/blog/2026/01/30/1" rel="next">
          older post ↓
        </a>
      </div>
    </section>
  </body>
</html>