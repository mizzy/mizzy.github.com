<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>
      Carina Modules - Gosuke Miyashita
    </title>
    <!-- TODO: change name and description -->
    <meta name="author" content="Gosuke Miyashita"/>
    <meta name="description" content="A fantastic blog that is fantastic."/>
    <link rel="alternate" type="application/rss+xml" href="/atom.xml"/>
    <link rel="stylesheet" href="/css/base.css" type="text/css" media="screen, projection"/>
    <link rel="stylesheet" href="/css/pygments.css" type="text/css"/>
    <link media="only screen and (max-device-width: 480px)" href="/css/iphone.css" type="text/css" rel="stylesheet"/>
    <link media="only screen and (device-width: 768px)" href="/css/iphone.css" type="text/css" rel="stylesheet"/>
    <link href='https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz' rel='stylesheet' type='text/css'>
    <link rel="apple-touch-icon" href="/apple-touch-icon.png"/>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.1/jquery.min.js"></script>
    <script type="text/javascript" src="/js/application.js"></script>
  </head>
  <body>
    <section class="sidebar">
      <a href="/">
        <!-- TODO: change this gravatar URL -->
        <img src="https://s.gravatar.com/avatar/0d5d8fb9cc4c06f581825f5a61d3f5f1?s=150" height="75" width="75"
             class="avatar"/>
      </a>
      <!-- TODO: change name -->
      <section class="name">
        <a href="/">
          <span id="zach">
            Gosuke
          </span>
          <span id="holman">
            Miyashita
          </span>
        </a>
      </section>
      <!-- TODO: change links -->
      <section class="meta">
        <a href="https://github.com/mizzy">
          <img src="/images/github.png"/>
        </a>
        <a href="https://twitter.com/gosukenator">
          <img src="/images/twitter.png">
        </a>
        <a href="/atom.xml">
          <img src="/images/rss.png"/>
        </a>
      </section>
      <!--
    <section class="sections">
      <ul>
        <li><a href="/about.html">about</a></li>
        <li><a href="/">posts</a></li>
      </ul>
    </section>
    -->
    </section>
    <section class="content autopagerize_page_element">
      <h1>
        <a href="/blog/2026/01/25/1">
          Carina Modules
        </a>
      </h1>
      <section class="byline">
        2026-01-25 12:59:31 +0900
      </section>
      <p>
        <a href="/blog/2026/01/24/1/">
          昨日の記事
        </a>
        で紹介した
        <a href="https://github.com/mizzy/carina">
          Carina
        </a>
        に、モジュール機能を実装した。
      </p>
      <hr />
      <h2>
        背景
      </h2>
      <p>
        <a href="/blog/2025/11/17/1/">
          YAPC::Fukuoka 2025での発表
        </a>
        で、インフラコードのモジュール化の難しさについて話した。
      </p>
      <script defer class="speakerdeck-embed" data-id="facd81a255fb4c32ab2d80c559f1ede1" data-ratio="1.7777777777777777" src="//speakerdeck.com/assets/embed.js"></script>
      <p>
        ここで挙げた問題のひとつが「内部構造の把握と依存関係の追跡が困難」という点。Terraformのモジュールは中身を見ないと何が作られるかわからないし、依存関係も追いづらい。planを実行してみれば、どんなリソースがつくられるかはわかるが、モジュールを呼び出すためのコードを書かないといけなくて面倒。また、つくられるリソースは表示されるが、リソース間の依存関係はplanの出力からはわからない。
      </p>
      <p>
        この問題を解決するために、Carinaには
        <code>
          module info
        </code>
        というコマンドを実装した。
      </p>
      <hr />
      <h2>
        module info コマンド
      </h2>
      <p>
        <code>
          module info
        </code>
        コマンドを実行すると、モジュールの情報が以下のように表示される。
      </p>
      <p>
        <img src="/images/2026/01/carina-module-info.png" alt="module info の出力" />
      </p>
      <p>
        3つのセクションに分かれている。
      </p>
      <h3>
        REQUIRES
      </h3>
      <p>
        モジュールが必要とする入力を表示する。
      </p>
      <pre><code>vpc: ref(aws.vpc)  (required)
cidr_blocks: list(cidr)  (required)
enable_https: bool = true
</code></pre>
      <p>
        型情報と、必須かどうか、デフォルト値があるかどうかがわかる。
      </p>
      <h3>
        CREATES
      </h3>
      <p>
        モジュールが作成するリソースをツリー構造で表示する。
      </p>
      <pre><code>input { vpc: ref(aws.vpc) }
└── web_sg: aws.security_group
    ├── http: aws.security_group.ingress_rule
    └── https: aws.security_group.ingress_rule
</code></pre>
      <p>
        入力として受け取った
        <code>
          vpc
        </code>
        を起点に、どのリソースがどのリソースに依存しているかが視覚的にわかる。
      </p>
      <h3>
        EXPOSES
      </h3>
      <p>
        モジュールが外部に公開する出力を表示する。
      </p>
      <pre><code>security_group: ref(aws.security_group)
  ← from: web_sg
</code></pre>
      <p>
        出力の型と、その出力がモジュール内のどのリソースから来ているかがわかる。
      </p>
      <hr />
      <h2>
        今後
      </h2>
      <p>
        まだ少ないリソース数と単純な依存関係でしか試していないが、モジュールで定義されているリソース構造を把握するのに役立ちそう。リソース数が増えたり、依存関係が複雑になったりするとどうなるか、引き続き試しながら改善していきたい。
      </p>
      <div class="pagination">
        <a href="/blog/2026/01/25/2">
          ↑ newer post
        </a>
        <a href="/blog/2026/01/24/2" rel="next">
          older post ↓
        </a>
      </div>
    </section>
  </body>
</html>