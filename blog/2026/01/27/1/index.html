<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>
      Carinaの型システムについて - Gosuke Miyashita
    </title>
    <!-- TODO: change name and description -->
    <meta name="author" content="Gosuke Miyashita"/>
    <meta name="description" content="A fantastic blog that is fantastic."/>
    <link rel="alternate" type="application/rss+xml" href="/atom.xml"/>
    <link rel="stylesheet" href="/css/base.css" type="text/css" media="screen, projection"/>
    <link rel="stylesheet" href="/css/pygments.css" type="text/css"/>
    <link media="only screen and (max-device-width: 480px)" href="/css/iphone.css" type="text/css" rel="stylesheet"/>
    <link media="only screen and (device-width: 768px)" href="/css/iphone.css" type="text/css" rel="stylesheet"/>
    <link href='https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz' rel='stylesheet' type='text/css'>
    <link rel="apple-touch-icon" href="/apple-touch-icon.png"/>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.1/jquery.min.js"></script>
    <script type="text/javascript" src="/js/application.js"></script>
  </head>
  <body>
    <section class="sidebar">
      <a href="/">
        <!-- TODO: change this gravatar URL -->
        <img src="https://s.gravatar.com/avatar/0d5d8fb9cc4c06f581825f5a61d3f5f1?s=150" height="75" width="75"
             class="avatar"/>
      </a>
      <!-- TODO: change name -->
      <section class="name">
        <a href="/">
          <span id="zach">
            Gosuke
          </span>
          <span id="holman">
            Miyashita
          </span>
        </a>
      </section>
      <!-- TODO: change links -->
      <section class="meta">
        <a href="https://github.com/mizzy">
          <img src="/images/github.png"/>
        </a>
        <a href="https://twitter.com/gosukenator">
          <img src="/images/twitter.png">
        </a>
        <a href="/atom.xml">
          <img src="/images/rss.png"/>
        </a>
      </section>
      <!--
    <section class="sections">
      <ul>
        <li><a href="/about.html">about</a></li>
        <li><a href="/">posts</a></li>
      </ul>
    </section>
    -->
    </section>
    <section class="content autopagerize_page_element">
      <h1>
        <a href="/blog/2026/01/27/1">
          Carinaの型システムについて
        </a>
      </h1>
      <section class="byline">
        2026-01-27 09:54:37 +0900
      </section>
      <p>
        Terraformライクなツール
        <a href="https://github.com/mizzy/carina">
          Carina
        </a>
        をつくりはじめた動機のひとつに、「型システムの強化」がある。
      </p>
      <p>
        Terraformではプリミティブな型（string, number, bool）に加えて、listやmap、objectなどの複合型がサポートされている。しかし、型システム自体はあまり強力ではない。
      </p>
      <p>
        例えば、regionやcidr_blockのような特定のドメインに特化した型は存在しない。そのため、これらの値を扱う際には単なるstring型として扱われ、誤った値が設定される可能性がある。誤った設定をした場合、validateやplanで気づけるのであればまだ良いが、planが通ってしまい、apply時にエラーになってはじめて間違いが発覚することもある。
      </p>
      <p>
        これを防ぐために、Carinaではドメイン固有型の導入を試している。現在実装しているものとして、region型やcidr型がある。これらの型は、それぞれのドメインに特化したバリデーションロジックを持っており、不正な値が設定された場合には即座にエラーを返す。
      </p>
      <p>
        例えば、誤ってリージョンを指定すべきところにアベイラビリティゾーンを指定したとする。
      </p>
      <pre><code class="language-hcl">provider aws {
  region = &quot;ap-northeast-1a&quot;
}
</code></pre>
      <p>
        Terraformではさすがに
        <code>plan</code>
        は通らないが、
        <code>validate</code>
        は通る。
      </p>
      <pre><code class="language-shell">$ terraform validate
Success! The configuration is valid.
</code></pre>
      <p>
        Carinaもproviderの定義はTerraformと同じように記述するが、
        <code>validate</code>
        で以下のようなエラーが返る。
      </p>
      <pre><code class="language-shell">Error: provider aws: Validation failed: Invalid region 'ap-northeast-1a', expected one of: ap-northeast-1, ap-northeast-2, ap-northeast-3, ap-southeast-1, ap-southeast-2, ap-south-1, us-east-1, us-east-2, us-west-1, us-west-2, eu-west-1, eu-west-2, eu-west-3, eu-central-1, eu-north-1, ca-central-1, sa-east-1 or DSL format like aws.Region.ap_northeast_1
</code></pre>
      <p>
        このようにCarinaでは、型システムを強化することで、より早い段階で設定ミスを検出できるようにしたい、と考えている。
      </p>
      <p>
        また、CarinaではAWSリージョンはEnum型として定義されているため、以下のようにリージョンを指定することもできる。
      </p>
      <pre><code>provider aws {
  region = aws.Region.ap_northeast_1
}</code></pre>
      <p>
        更にLSPもサポートしているため、IDE上で補完候補としてリージョンの一覧が表示される。
      </p>
      <p>
        <img src="/images/2026/01/carina-region-completion.png" alt="リージョンの補完候補" />
      </p>
      <p>
        誤った文字列を指定している場合も、IDE上でエラーが表示される。
      </p>
      <p>
        <img src="/images/2026/01/carina-region-error.png" alt="IDEでのエラー表示" />
      </p>
      <p>
        もう一つの例として、cidr型を紹介する。cidr型はCIDR表記のIPアドレスブロックを表す型で、不正なCIDR表記が指定された場合にはエラーを返す。
      </p>
      <p>
        例えば、以下のように不正なプレフィックス長を指定したとする。
      </p>
      <pre><code>let main_vpc = aws.vpc {
    name       = &quot;main-vpc&quot;
    cidr_block = &quot;10.0.0.0/33&quot;
}</code></pre>
      <p>
        <code>carina validate</code>
        を実行すると、以下のようなエラーが返る。
      </p>
      <pre><code>Error: vpc.main-vpc: Validation failed: Invalid prefix length '33': must be 0-32</code></pre>
      <p>
        Terraformでもvalidateで同様のエラーが返るが、IntelliJ IDEAのTerraformプラグインではCIDR表記のフォーマットエラーが検出されない。CarinaのLSPでは、IDE上で以下のようにエラーが表示される。
      </p>
      <p>
        <img src="/images/2026/01/carina-cidr-error.png" alt="cidr_blockのエラー表示" />
      </p>
      <p>
        まったくCIDR表記として成り立っていない場合も、当然ながらIDE上でエラーが表示される。
      </p>
      <p>
        <img src="/images/2026/01/carina-cidr-format-error.png" alt="cidr_blockのフォーマットエラー表示" />
      </p>
      <p>
        cidr型でもregion型と同様に、補完候補として一般的なCIDR表記が表示される。
      </p>
      <p>
        <img src="/images/2026/01/carina-cidr-completion.png" alt="cidr_blockの補完候補" />
      </p>
      <p>
        さらに別の例として、S3バケットの
        <code>versioning_configuration</code>
        属性を紹介する。
        <code>versioning_configuration</code>
        はS3バケットのバージョニング設定を表すオブジェクト型で、
        <code>status</code>
        フィールドには
        <code>Enabled</code>
        または
        <code>Suspended</code>
        のいずれかを文字列で指定する必要がある（
        <code>Disabled</code>
        もあるがこれはちょっと特殊な値）。誤った文字列を指定すると、validateやplanでは不正な値が検出されるが、IDE上ではエラーや補完候補が表示されないため、あれ、Enableだっけ？Enabledだっけ？と迷ったら公式ドキュメントを確認する必要がある。
      </p>
      <pre><code class="language-hcl">resource &quot;aws_s3_bucket_versioning&quot; &quot;versioning_example&quot; {
  bucket = aws_s3_bucket.example.id
  versioning_configuration {
    status = &quot;Enabled&quot;
  }
}
</code></pre>
      <p>
        Carinaでは、このstatusフィールドをEnum型として定義しているため、以下のように補完候補として&quot;Enabled&quot;と&quot;Suspended&quot;が表示される。
      </p>
      <p>
        <img src="/images/2026/01/carina-s3-versioning-completion.png" alt="S3バケットのversioning補完" />
      </p>
      <p>
        エディタ上でのエラー表示や自動補完については、今は生成AIが基本的にコードを書いてくれるのであまり気にする必要はないかもしれない。しかし、型システムが強力であればあるほど、生成AIがより正確なコードを生成できるようになり、早い段階で間違いに気づけるようになるはず。
      </p>
      <p>
        型システムを強化するためには、各リソースの属性やその型情報を正確に把握する必要がある。AWSの場合、CloudFormationのリソースタイプスキーマを利用することで、各リソースの属性情報を取得できる。例えば、以下のコマンドを実行すると、S3バケットリソースのスキーマ情報が取得できる。
      </p>
      <pre><code class="language-shell">aws cloudformation describe-type \
      --type RESOURCE \
      --type-name AWS::S3::Bucket \
      --query &quot;Schema&quot; \
      --output text
</code></pre>
      <p>
        これを元にCarinaで型定義を自動生成するなり、AIに生成させるなりすれば、型システムの強化がより容易になると考えている。
      </p>
      <div class="pagination">
        <a href="/blog/2026/01/25/2" rel="next">
          older post ↓
        </a>
      </div>
    </section>
  </body>
</html>