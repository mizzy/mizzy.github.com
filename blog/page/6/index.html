
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>mizzy.org</title>
  <meta name="author" content="Gosuke Miyashita">

  
  <meta name="description" content="Java言語で学ぶデザインパターン入門 の第6章 Prototype を Scala で書き直してみて、オブジェクトのクローニングでちょっとつまづいたのでメモ。 結論を先に言うと、オブジェクトのクローニングしたい場合には、クラスやトレイトの宣言時に、@cloneable アノテーションを入れると &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mizzy.org/blog/page/6">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="mizzy.org" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-53984-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">mizzy.org</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mizzy.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/10/18/ScalaObjectCloning/">ScalaObjectCloning</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-10-18T11:51:50+09:00" pubdate>Oct 18<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/10/18/ScalaObjectCloning/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.amazon.co.jp/dp/4797327030/">Java言語で学ぶデザインパターン入門</a> の第6章 Prototype を <a href="http://github.com/mizzy/scala-design-patterns/tree/master/Prototype/">Scala で書き直してみて</a>、オブジェクトのクローニングでちょっとつまづいたのでメモ。</p>

<p>結論を先に言うと、オブジェクトのクローニングしたい場合には、クラスやトレイトの宣言時に、@cloneable アノテーションを入れると OK。</p>

<pre><code>@cloneable class Hoge {
  ...
}
</code></pre>

<p>以下、つまづいて調べた経緯。元書籍での Product クラスは以下のように、Cloneable を継承している。</p>

<pre><code>#!java
package framework;

public interface Product extends Cloneable {
    public abstract void use(String s);
    public abstract Product createClone(); 
}
</code></pre>

<p>で、Scala でのクローニングについて、「Scala cloneable」でググると、一番上に出てきた http://www.scala-lang.org/node/110 では、以下のようなコードが載っていた。</p>

<pre><code>trait Cloneable extends java.lang.Cloneable {
  override def clone(): Cloneable = { super.clone(); this }
}
trait Resetable {
  def reset: Unit
}
</code></pre>

<p>これを参考にして、Product クラスを Scala で以下のように書き直してみた。</p>

<pre><code>package framework

trait Product extends java.lang.Cloneable {
  def use(s: String): Unit
  def createClone(): Product
  override def clone(): Cloneable = { super.clone(); this }
}
</code></pre>

<p>これでとりあえずは動いたんだけど、いまいちスッキリしない。そもそも Scala は Java だけではなく、.NET でも動くということなんだけど、java.lang.Cloneable を継承してると、Java でしか動かなくてイマイチ。（まあ、習作用コードでそこまで気にする必要もないんだけど。）</p>

<p>というわけで調べてみたら、@cloneable アノテーションを使えばいいみたい。</p>

<pre><code>package framework

@cloneable trait Product {
  def use(s: String): Unit
  def createClone(): Product
}
</code></pre>

<p>これで意図通りに動いた。</p>

<p>@cloneable を頭に入れないと、実行時に CloneNotSupportedException が発生する。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/10/06/PacSec2009/">PacSec2009</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-10-06T23:16:52+09:00" pubdate>Oct 6<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/10/06/PacSec2009/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>今年も <a href="http://pacsec.jp/">PacSec</a> の季節がやってきました。昨年は二つほどスライドの翻訳をさせて頂いたのですが、残念ながら当日は体調不良で参加できませんでした…</p>

<p>今年も昨年同様、スライド翻訳をお手伝いさせて頂くのですが、一緒にお手伝いしてくださる方を募集しています。興味のある方は、gosukenator at gmail.com までご連絡ください。（無料でカンファレンスに参加できる上に、豪華なお弁当つきです。懇親会も無料で参加できる、はず。）</p>

<p>翻訳に対する考え方なんかは、<a href="http://trombik.mine.nu/~cherry/w/index.php/2008/11/16/1471/pacsec-and-translation">I, newbie の trombik さんのブログをご参照ください</a> 。</p>

<p>また、今年の PacSec の概要や、過去どんな感じだったのかなど、興味がある方は以下のリンクをご参照ください。</p>

<ul>
<li>http://pacsec.jp/speakers.html</li>
<li>http://twitter.com/Pacsecjp</li>
<li>http://gihyo.jp/admin/serial/01/sysadmin-toolbox/0004</li>
<li>http://trac.mizzy.org/public/wiki/PacSec2007</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/10/06/ScalaDesignPatterns/">ScalaDesignPatterns</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-10-06T00:10:45+09:00" pubdate>Oct 6<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/10/06/ScalaDesignPatterns/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.amazon.co.jp/dp/4844327453">Scalaスケーラブルプログラミング</a> をコードを書き写しながらざーっと読んだんだけど、全然身になってない気がするので、結城先生の <a href="http://www.amazon.co.jp/dp/4797327030/">Java言語で学ぶデザインパターン入門</a> のサンプルコードを <a href="http://github.com/mizzy/scala-design-patterns">Scala で実装して github にアップ</a> してみることにした。</p>

<p>とりあえず飽きるまでやります。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/09/15/CanBadge/">CanBadge</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-09-15T00:05:20+09:00" pubdate>Sep 15<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/09/15/CanBadge/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>5歳になる娘の幼稚園帽子。</p>

<p>[[Image(http://trac.mizzy.org/public/attachment/wiki/CanBadge/canbadge.jpg?format=raw)]]</p>

<p>ちなみに小3の長男はPerl Best Practicesの布製バッグを体育用具入れとして使ってる。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/09/11/YapcAsia2009TokyoPresentation/">YapcAsia2009TokyoPresentation</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-09-11T00:21:28+09:00" pubdate>Sep 11<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/09/11/YapcAsia2009TokyoPresentation/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>ひとつ目は <a href="http://conferences.yapcasia.org/ya2009/talk/2166">ペパボでの Perl のつかいかた</a> 。<a href="http://d.hatena.ne.jp/hiboma/">id:hiboma</a> と一緒にプレゼンしました。<a href="http://d.hatena.ne.jp/naoya/">お兄さん</a>、ネタに使わせてもらってすみません＆ありがとうございました。後半のロリポの話は、二人で休日も返上してがっつり取り組んだプロジェクトだったので、ぜひ二人で発表したい、と思い、一緒にやらせてもらいました。資料の最新版は id:hiboma が持ってるので、そのうちアップしてくれると思います。</p>

<p>ふたつ目は <a href="http://conferences.yapcasia.org/ya2009/talk/2220">Danga::Socketの非同期処理の仕組みとPerlbalで非同期処理するプラグインを書く方法</a> 。<a href="http://www.slideshare.net/mizzy/how-dangasocket-handles-asynchronous-processing-and-how-to-write-asynchronous-perlbal-plugins">英語版資料</a> と <a href="http://www.slideshare.net/mizzy/dangasocketperlbal">日本語版資料</a> を slideshare にアップしています。</p>

<p>また、プラグインのコードは、プレゼン中は概要しか紹介できなかったので、実際に動くサンプルを <a href="http://github.com/mizzy/perlbal-async-plugin-example/tree/master">github にアップ</a>しています。Perlbal::ClientProxy のパッチと設定ファイルも合わせて置いてあります。</p>

<p>ただ、プレゼンした手法は、以下の点でとても実用的とは言えません。</p>

<ul>
<li>本体に手を入れなければいけない</li>
<li>特定の hook にしか対応してない</li>
<li>同じフックで複数の非同期処理プラグインを動かすことができない</li>
</ul>


<p>本体に手を入れるのはしかたないとして、特定のフックに依存せずに、同じフックで複数の非同期処理プラグインを動かせるようするにはどうすればいいのか、今のところノーアイデアです。これがすっきりできるように実装できれば、ぜひパッチを送りたいところなのですが、今のところ必要に駆られてないので、たぶんやらないと思います。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/09/02/DeveloperRecruitAtPaperboy/">DeveloperRecruitAtPaperboy</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-09-02T02:16:46+09:00" pubdate>Sep 2<span>nd</span>, 2009</time>
        
         | <a href="/blog/2009/09/02/DeveloperRecruitAtPaperboy/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>ペパボでは以下の2つのサービスで開発者を募集中です。</p>

<ul>
<li><a href="http://www.paperboy.co.jp/recruit/job/090821.php">Color Me Shop!pro</a></li>
<li><a href="http://www.paperboy.co.jp/recruit/job/090806.php">30days Album</a></li>
</ul>


<p>併せて<a href="http://www.paperboy.co.jp/recruit/job/090821b.php">開発アルバイト</a>も募集中です。</p>

<p>詳しくは募集要項をご確認ください。</p>

<p>募集要項にはありませんが、採用された方にはドクターペッパーチェリーを差し上げます。合い言葉は「ドクターペッパーチェリー飲みたい！」です。僕との面接時に必ず声に出して言ってください。</p>

<p>[[Image(http://gyazo.com/37db61b8bd76e406987622d9863fbe5f.png)]]</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/08/13/YapcAsia2009/">YapcAsia2009</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-08-13T01:18:44+09:00" pubdate>Aug 13<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/08/13/YapcAsia2009/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>このところ、ほとんどエントリ更新してませんが、それは、<a href="http://japan.cnet.com/extra/paperboy_0907/story/0,3800098768,20394957,00.htm">ナウでヤングなレンタルサーバー ロリポップ！のインフラ再構築</a> で多忙だったからです。（それだけではないですが。）</p>

<p>というわけで、ブログエントリをほとんど書いてないので細切れにもなりようがないのですが、ロリポ含めて、ペパボが提供するサービスの中で、Perl がどのように使われているのかという話を <a href="http://d.hatena.ne.jp/hiboma/">id:hiboma</a> と一緒に YAPC::Asia 2009 でさせていただくことにしました。</p>

<p>また、それとは別に、以前からの関心事であった、Perlbal で非同期処理するプラグインを書く方法についても、ベースとなる Danga::Socket の説明も含めて、お話したいと思います。</p>

<p>YAPC::Asia 2009 は9月10日(木)と11日(金)の2日間、東京工業大学大岡山キャンパスで開催されます。すでにチケット販売も始まったので、興味のある方はお越しいただければ、と思います。</p>

<ul>
<li><a href="http://conferences.yapcasia.org/ya2009/">YAPC::Asia 2009</a></li>
<li><a href="http://conferences.yapcasia.org/ya2009/talk/2166">ペパボでの Perl のつかいかた</a></li>
<li><a href="http://conferences.yapcasia.org/ya2009/talk/2220">Perlbalで非同期処理するプラグインを書く方法</a></li>
</ul>


<p>【参考文献】</p>

<ul>
<li>http://d.hatena.ne.jp/hirose31/20090807/1249611130</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/08/06/InotifyAndMakuosan/">InotifyAndMakuosan</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-08-06T08:05:40+09:00" pubdate>Aug 6<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/08/06/InotifyAndMakuosan/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>ファイルのミラーリングツールとしては rsync が最も使われていると思いますが、差分チェックの負荷が大きく、できればつかうのやめたいなー、と思っていたところ、<a href="http://gihyo.jp/magazine/SD/archive/2009/200908">Software Design 2009年8月号</a> に <a href="http://code.google.com/p/lsyncd/">lsyncd</a> というツールが載っていて、お、これはと思って見てみたのですが、仕組みとしては inotify + rsync なので、結局は rsync を裏で呼び出していて、差分チェックの呪縛からは逃れられません。</p>

<p>inotify でファイルの更新イベント受け取ってるんだから、さらに rsync で差分チェックする必要はないじゃん、と思うわけですが、なんらかの理由でイベントが受け取れない可能性もあるため、二重チェックした方が安全なんでしょうね。</p>

<p>でもやっぱり余分な負荷はかけたくない、ってことで思いついたのが、inotify で更新イベントを検知したファイルを、<a href="http://lab.klab.org/wiki/Makuosan">makuosan</a> の msync コマンドに渡してミラーリングする方法。（makusan の詳しい解説は、<a href="http://gihyo.jp/magazine/wdpress/archive/2009/vol51">WEB+DB PRESS Vol.51</a> に載ってます。）</p>

<p>そこで以下のようなコードを書いて動かしてみたところ、いい感じでファイルが同期できることを確認しました。</p>

<pre><code>#!perl
#!/usr/bin/perl

use strict;
use warnings;
use File::ChangeNotify;

my $base = '/home/miya/work';
my $watcher = File::ChangeNotify-&gt;instantiate_watcher(
    directories =&gt; [ $base ],
);

while ( my @events = $watcher-&gt;wait_for_events() ) {
    for my $event ( @events ) {
        my $path = $event-&gt;path;
        $path =~ s!$base/!!;
        `msync --sync $path`;
    }
}

exit;
</code></pre>

<p>とは言っても、実運用で使うためには、イベントをとりこぼさない、またはとりこぼしてもリカバーするような仕組みを考えたり、負荷テストをしてみたりとか、色々と考慮しなければいけないことはありますが、それはまあおいおいってことで。</p>

<p>また、<a href="http://search.cpan.org/~drolsky/File-ChangeNotify/">File::ChangeNotify</a> がすべての inotify イベントに対応してるわけではなく、IN_CREATE, IN_MODIFY, IN_DELETE にしか対応してないため、パーミッション変更とかファイルの移動なんかは検知できない、という問題もあります。（パッチ書けばいけそうなので、書いてみるつもりです。）</p>

<p>File::ChangeNotify 自体は inotify だけじゃなく、他の仕組みにも対応できるようになっていて、inotify が使える Linux kernel 2.6.13 以降であれば File::ChangeNotify::Watcher::Inotify が、それ以外であれば File::ChangeNotify::Watcher::Default が自動的に呼ばれるようになってます。なので、Mac OS X の FSEvents に対応した File::ChangeNotify::Watcher::FSEvents とか書けば、Mac では自動的に FSEvents で更新イベントを検知、ってこともできそうです。</p>

<p>ともかく、rsync の負荷には困っているので、今後この辺の方法論は詰めていきたいな、と思っています。</p>

<p><em>追記</em></p>

<p><a href="http://github.com/miyagawa/File-ChangeNotify-Watcher-MacFSEvents/tree">miyagawa さんによる File::ChangeNotify::Watcher::MacFSEvents が github にありました</a>。ただし、FSEventsではファイル名とかイベントの種類はとれないそうです。Wikipedia 見てもそんな感じのことが書いてますね。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/07/21/library-perl-trunk-Net-Amazon-ECS-lib-Net-Amazon-ECS.pm/">library/perl/trunk/Net-Amazon-ECS/lib/Net/Amazon/ECS.pm</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-07-21T00:58:15+09:00" pubdate>Jul 21<span>st</span>, 2009</time>
        
         | <a href="/blog/2009/07/21/library-perl-trunk-Net-Amazon-ECS-lib-Net-Amazon-ECS.pm/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>source:library/perl/trunk/Net-Amazon-ECS/lib/Net/Amazon/ECS.pm</p>

<h1>NAME</h1>

<p>Net::Amazon::ECS - [One line description of module&#8217;s purpose here]</p>

<h1>VERSION</h1>

<p>This document describes Net::Amazon::ECS version 0.0.1</p>

<h1>SYNOPSIS</h1>

<pre><code>    use Net::Amazon::ECS;

    my $ua =  Net::Amazon::ECS-&gt;new(
        access_key_id =&gt; 'YOUR_AWS_ACCESS_KEY_ID',
        associate_tag =&gt; 'YOUR_AFFILIATE_ID',
        locale        =&gt; 'jp',
    );

    my $req = Net::Amazon::Request::Keyword-&gt;new(
        keywords     =&gt; 'SEARCH KEYWORDS',
        search_index =&gt; 'books',
        sort         =&gt; 'daterank',
    );

    my $res = $ua-&gt;request($req);

    croak $res-&gt;message if $res-&gt;is_error;

    my @items = $res-&gt;items;
</code></pre>

<h1>DESCRIPTION</h1>

<h1>INTERFACE</h1>

<h1>DIAGNOSTICS</h1>

<p> <code>Error message here, perhaps with %s placeholders</code>:: [Description of error here]
 <code>Another error message here</code>:: [Description of error here]
[Et cetera, et cetera]</p>

<h1>CONFIGURATION AND ENVIRONMENT</h1>

<p>Net::Amazon::ECS requires no configuration files or environment variables.</p>

<h1>DEPENDENCIES</h1>

<p>None.</p>

<h1>INCOMPATIBILITIES</h1>

<p>None reported.</p>

<h1>BUGS AND LIMITATIONS</h1>

<p>No bugs have been reported.</p>

<p>Please report any bugs or feature requests to <code>bug-net-amazon-ecs@rt.cpan.org</code>, or through the web interface at http://rt.cpan.org.</p>

<h1>AUTHOR</h1>

<p>Gosuke Miyashita <code>&lt;gosukenator@gmail.com&gt;</code></p>

<h1>LICENCE AND COPYRIGHT</h1>

<p>Copyright (c) 2006, Gosuke Miyashita <code>&lt;gosukenator@gmail.com&gt;</code>. All rights reserved.</p>

<p>This module is free software; you can redistribute it and/or modify it under the same terms as Perl itself. See perlartistic.</p>

<h1>DISCLAIMER OF WARRANTY</h1>

<p>BECAUSE THIS SOFTWARE IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY FOR THE SOFTWARE, TO THE EXTENT PERMITTED BY APPLICABLE LAW. EXCEPT WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES PROVIDE THE SOFTWARE &#8220;AS IS&#8221; WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE. THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THE SOFTWARE IS WITH YOU. SHOULD THE SOFTWARE PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING, REPAIR, OR CORRECTION.</p>

<p>IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR REDISTRIBUTE THE SOFTWARE AS PERMITTED BY THE ABOVE LICENCE, BE LIABLE TO YOU FOR DAMAGES, INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES ARISING OUT OF THE USE OR INABILITY TO USE THE SOFTWARE (INCLUDING BUT NOT LIMITED TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY YOU OR THIRD PARTIES OR A FAILURE OF THE SOFTWARE TO OPERATE WITH ANY OTHER SOFTWARE), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGES.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/05/10/AddModRewriteInternalFunction/">AddModRewriteInternalFunction</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-05-10T13:58:43+09:00" pubdate>May 10<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/05/10/AddModRewriteInternalFunction/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Apache モジュール界のスイスアーミーナイフこと mod_rewrite の中でも、最も何でもありな rewrite ができるのが、<a href="http://httpd.apache.org/docs/2.2/ja/mod/mod_rewrite.html#rewritemap">RewriteMap</a> での prg タイプによる外部プログラム実行ですが、こいつは外部プログラムがひとつだけ常駐し、httpd と標準入出力を介してやりとりする、という形なので、並列処理させることができません。これは rewrite 処理するときにデータベースへ問い合わせるなど、I/O ブロッキングが発生するような処理をさせたいときには致命的なパフォーマンス劣化を引き起こすことになります。</p>

<p>これを解決するためには、Apache モジュールの中で望みの rewrite 処理をさせるようにすればいいのでは、と思い、RewriteMap にある int タイプに好きな internal function を追加できればいけるんじゃないないか、と考えたものの、<a href="http://httpd.apache.org/docs/2.2/ja/mod/mod_rewrite.html">mod_rewrite のリファレンス</a> では、「you cannot create your own」とか書かれていて、追加できないっぽい。かと言って mod_rewrite.c に手を入れるのもやだなー、と思っていたところ、<a href="http://code.google.com/p/modicpquery/wiki/Internals">mod_icpquery のドキュメント</a> を見つけた。これを見ると、好きな internal function を独立したモジュールの形で追加できそう、ってことでやってみたらできた。</p>

<p>以下が internal function を追加するためのモジュールテンプレ。rewrite_mapfunc_custom の中で、望みの処理を記述してあげるだけで OK。</p>

<pre><code>#!c
#include "httpd.h"
#include "http_config.h"
#include "apr_optional.h"

/* rewrite map function prototype from mod_rewrite.h */
typedef char *(rewrite_mapfunc_t)(request_rec *r, char *key);

/* optional function declaration from mod_rewrite.h */
APR_DECLARE_OPTIONAL_FN(void, ap_register_rewrite_mapfunc,
                        (char *name, rewrite_mapfunc_t *func));

static char *rewrite_mapfunc_custom(request_rec *req, char *key)
{
    /* key を元にごにょごにょして value を生成 */
    return value;
}

/* from mod_rewrite.c */
static int pre_config(apr_pool_t *pconf,
                      apr_pool_t *plog,
                      apr_pool_t *ptemp)
{
    APR_OPTIONAL_FN_TYPE(ap_register_rewrite_mapfunc) *map_pfn_register;

    /* register int: rewritemap handlers */
    map_pfn_register = APR_RETRIEVE_OPTIONAL_FN(ap_register_rewrite_mapfunc);
    if (map_pfn_register) {
        map_pfn_register("custom", rewrite_mapfunc_custom);
    }
    return OK;
}

static void register_hooks(apr_pool_t *p)
{
    ap_hook_pre_config(pre_config, NULL, NULL, APR_HOOK_MIDDLE);
}

module AP_MODULE_DECLARE_DATA rewrite_mapfunc_custom_module = {
    STANDARD20_MODULE_STUFF,
    NULL,                  /* create per-dir    config structures */
    NULL,                  /* merge  per-dir    config structures */
    NULL,                  /* create per-server config structures */
    NULL,                  /* merge  per-server config structures */
    NULL,                  /* table of config file commands       */
    register_hooks         /* register hooks                      */
};
</code></pre>

<p>追加した internal function を呼び出すための httpd.conf は以下のような感じ。</p>

<pre><code>LoadModule rewrite_mapfunc_custom_module modules/mod_rewrite_mapfunc_custom.so

RewriteEngine On
ProxyPreserveHost On
RewriteMap custom int:custom
RewriteRule ^/(.*)$ http://${custom:%{HTTP_HOST}}/$1 [P,QSA]
</code></pre>

<p>この例では、Host ヘッダの内容を custom function に渡して、ホスト名を変換して proxy するけど、Host ヘッダはオリジナルのままで変換しない、といった処理を想定してます。</p>

<p>例の件はこんな感じで実現できそうだよ。＞<a href="http://d.hatena.ne.jp/hiboma/">id:hiboma</a></p>

<p>*2009/05/10 13:57:00 追記 *</p>

<p>github に Makefile 等も含めてコードアップしました。</p>

<p>http://github.com/mizzy/mod_rewrite_mapfunc_custom/tree/master</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/7/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/5/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2011/11/05/maglica-web/">Maglica Web</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/10/30/vimeo-tag-plugin/">Vimeo tag plugin</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/10/29/typo-to-octopress/">Typo to Octopress</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/10/21/twan-tag-plugin/">TWAN tag plugin for Jekyll</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/10/17/first-post/">自宅サーバが死にました</a>
      </li>
    
  </ul>
</section>




  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011 - Gosuke Miyashita -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mizzyorg';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
