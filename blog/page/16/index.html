
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>mizzy.org</title>
  <meta name="author" content="Gosuke Miyashita">

  
  <meta name="description" content="puppet で ファイルの配布 ができたので、次はファイルが変更されたら特定のコマンドを実行、にチャレンジ。これは FAQ にやり方書いてました。 puppet サーバで管理している /etc/httpd/conf.d/ 以下のファイルが変更されたら、puppet &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mizzy.org/blog/page/16">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="mizzy.org" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-53984-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">mizzy.org</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mizzy.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/03/19/440/">Puppet でファイルが変更されたら指定したコマンドを実行するレシピ</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-03-19T21:02:00+09:00" pubdate>Mar 19<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/03/19/440/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
puppet で <a class="ext-link" href="http://mizzy.org/linux/puppet03.html"><span class="icon"></span>ファイルの配布</a> ができたので、次はファイルが変更されたら特定のコマンドを実行、にチャレンジ。これは <a class="ext-link" href="http://reductivelabs.com/trac/puppet/wiki/FrequentlyAskedQuestions#how-do-i-run-a-command-whenever-a-file-changes"><span class="icon"></span>FAQ</a> にやり方書いてました。
</p>


<p>
puppet サーバで管理している /etc/httpd/conf.d/ 以下のファイルが変更されたら、puppet クライアント上のファイルを更新して httpd を再起動するレシピはこんな感じ。
</p>


<pre class="wiki">
class web {
  define httpd {
    $path = '/etc/httpd/conf.d'
    file { $path:
      source  => 'puppet://mizzy.org/files/etc/httpd/conf.d',
      recurse => 'true',
    }
    exec { 'httpd restart':
      command     => '/etc/init.d/httpd restart',
      subscribe   => File[$path],
      refreshonly => true
    }
  }

  httpd { 'httpd settings': }
}

node 'www.mizzy.org' {
  include web
}
</pre>


<p>
/etc/httpd/cond.d/perl.conf を変更して puppet クライアント上で puppetd &#8211;test を実行するとこんな感じに。
</p>


<pre class="wiki">
$ sudo /usr/sbin/puppetd --server mizzy.org --test
info: Caching configuration at /var/lib/puppet/localconfig.yaml
notice: Starting configuration run
info: //www.mizzy.org/web/httpd[httpd settings]/file=/etc/httpd/conf.d/perl.conf: Removing old backup of type file
notice: //www.mizzy.org/web/httpd[httpd settings]/file=/etc/httpd/conf.d/perl.conf/source: source changed '{md5}b78c3e53dd7fef842c99f105e9e4204f' to '{md5}a28770c2cdfc4c23faa2ea41b2e67397'
info: //www.mizzy.org/web/httpd[httpd settings]/file=/etc/httpd/conf.d/perl.conf: Scheduling refresh of exec[httpd restart]
notice: //www.mizzy.org/web/httpd[httpd settings]/exec=/etc/init.d/httpd restart: Triggering 'refresh' from 1 dependencies
notice: Finished configuration run in 7.42 seconds    
</pre>


<p>
ファイルが更新されてない場合はこうなる。
</p>


<pre class="wiki">
$ sudo /usr/sbin/puppetd --server mizzy.org --test
info: Caching configuration at /var/lib/puppet/localconfig.yaml
notice: Starting configuration run
notice: Finished configuration run in 6.80 second
</pre>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/03/19/319/">Puppet File Server</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-03-19T19:22:00+09:00" pubdate>Mar 19<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/03/19/319/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
puppet サーバ上のファイルをクライアントに配布するには、file server 機能を利用するらしい。というわけで、ドキュメント <a class="ext-link" href="http://reductivelabs.com/trac/puppet/wiki/FileServingConfiguration"><span class="icon"></span>File Serving Configuration</a> から要点を抜き出してみる。
</p>


<h3 id="/etc/puppet/fileserver.confの設定">/etc/puppet/fileserver.conf の設定</h3>


<pre class="wiki">
[module]
    path /path/to/files
    allow *.domain.com
    deny *.wireless.domain.com
</pre>


<p>
こう設定すると、
</p>


<pre class="wiki">
/path/to/files/sudoers
</pre>


<p>
というファイルを
</p>


<pre class="wiki">
puppet://server/module/sudoers
</pre>


<p>
で取得できるようになる。
</p>


<h3 id="manifestの設定">manifest の設定</h3>


<p>
&#8220;the Puppet language&#8221; が記述される設定ファイルを manifest と呼ぶらしい。要は puppet クライアントをどう管理するか、が記述された設定ファイルですね。（上の /etc/puppet/fileserver.conf は manifest ではない。）
</p>


<p>
puppet file server 上のファイルを配布するには、以下の様な設定を manifest に記述。
</p>


<pre class="wiki">
# copy a remote file to /etc/sudoers
file { "/etc/sudoers":
    mode   => 440,
    owner  => root,
    group  => root,
    source => "puppet://server/module/sudoers"
}
</pre>


<p>
source がポイント。
</p>


<p>
詳細は <a class="ext-link" href="http://reductivelabs.com/trac/puppet/wiki/FileServingConfiguration"><span class="icon"></span>File Serving Configuration</a> を参照。
</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/03/19/407/">Puppet の言語構造</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-03-19T13:34:00+09:00" pubdate>Mar 19<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/03/19/407/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
<a class="ext-link" href="http://reductivelabs.com/trac/puppet/wiki/InstallationGuide"><span class="icon"></span>Installation Guide</a> を読めば、とりあえず puppet を動かすことはできるけど、やりたいことをやろうと思ってもすぐにできるわけでもない。というわけで、ドキュメントをちゃんと読んでみることにした。
</p>


<p>
まずは puppet の設定ファイルで使われている内部言語の理解から、ということで、<a class="ext-link" href="http://reductivelabs.com/trac/puppet/wiki/LanguageStructures"><span class="icon"></span>Language Structures</a> を超意訳してみる。
</p>


<h3 id="Types">Types</h3>


<p>
puppet 設定の基本構成単位。管理されるコンピュータ上のオブジェクト（ファイルとかパッケージとか）を表すもので、あらかじめ用意されたビルトインタイプ以外にも、自ら定義することも可能。
</p>


<pre class="wiki">
file { "/etc/passwd": owner => root, mode => 644 } 
package { apache: install => true }
</pre>


<p>
詳しくは <a class="ext-link" href="http://reductivelabs.com/trac/puppet/wiki/TypeReference"><span class="icon"></span>Type Reference</a> を参照。
</p>


<h3 id="Assignment">Assignment</h3>


<p>
変数が利用できる。
</p>


<pre class="wiki">
$variable = value
</pre>


<pre class="wiki">
$x = foo
$y = bar
$z = "$x$y"
</pre>


<h3 id="BringingConfigfilestogether">Bringing Config files together</h3>


<p>
設定ファイルに、別の設定ファイルをインポートできる。
</p>


<pre class="wiki">
import "filename"
</pre>


<p>
正規表現も利用可能。
</p>


<pre class="wiki">
import "classes/*"
import "packages/[a-z]*"
</pre>


<h3 id="Scope">Scope</h3>


<p>
{ } によってスコープが形成される。
</p>


<p>
変数は一度割り当てられると、同一スコープ内では変更できないが、サブスコープ内では同一名の変数を割り当てることができる。
</p>


<pre class="wiki">
$var = value

# override $var
define testing {
    $var = othervalue
}
</pre>


<h3 id="Components">Components</h3>


<p>
ここでいう Components とは、自分で定義する Type のことっぽい。Components の定義と利用は以下の様な感じ。
</p>


<pre class="wiki">
define svnserve($source, $path, $user = false, $password = false) {
    file { $path:
        create => directory,
        owner => root,
        group => root
    }
    $svncmd = $user ? {
        false => "/usr/bin/svn co --non-interactive $source/$name .",
        default => "/usr/bin/svn co --non-interactive --username $user --password '$password' $source/$name ."
    }   
    exec { $svncmd: 
        cwd => $path,
        require => file[$path],
        creates => "$path/.svn"
    }   
}

svnserve { dist:
    source => "https://reductivelabs.com/svn",
    path => "/dist",
    user => "puppet",
    password => "password"
}

svnserve { "dist/config/apps/puppet":
    source => "https://reductivelabs.com/svn",
    path => "/etc/puppet",
    user => "puppet",
    password => "password"
}
</pre>


<p>
利用する時はビルトインタイプと構文上の違いはない。
</p>


<h3 id="ServerClasses">Server Classes</h3>


<p>
Class を定義してインクルードすることができる。
</p>


<pre class="wiki">
class <class_name> [inherits <super_class_name>] { ... }
</pre>


<p>
継承も可能。
</p>


<pre class="wiki">
# really simple example
class solaris {
    file {
        "/etc/passwd": owner => root, group => root, mode => 644;
        "/etc/shadow": owner => root, group => root, mode => 440
    }
}

class solworkstation inherits solaris {
    file {
        "/etc/sudoers": owner => root, group => root, mode => 440;
        "/bin/sudo": owner => root, group => root, mode => 4111
    }
}

include solworkstation
</pre>


<p>
以下の例だと、$operatingsystem の値と同名の Class と、$hostname に応じた Class がインクルードされる。
</p>


<pre class="wiki">
include $operatingsystem, $hostname ? {
    myhost => classA, default => classB
}
</pre>


<p>
$operatingsystem とか $hostname とかは、<a class="ext-link" href="http://reductivelabs.com/projects/facter/"><span class="icon"></span>Facter</a>というライブラリを使ってプリセットされているみたい。
</p>


<h3 id="Classesvs.Components">Classes vs. Components</h3>


<p>
Classes と Components の違いは以下の通り。
</p>


<ul><li>Classes はシングルトンなので、ホスト上でひとつしかないものを定義するのに利用する（OSの種類とか、特定のパッケージとかサービスとか。）</li>
<li>Components はホスト上で複数あるオブジェクト（バーチャルホストなど）を定義するのに利用する。</li></ul>


<p>
あと、Classes は引数を受け取れない、という違いもある。
</p>


<h3 id="Subclssing">Subclssing</h3>


<p>
Class は継承ができる。
</p>


<pre class="wiki">
class unix {
    file { "/etc/sudoers":
        owner => root,
        group => root,
        mode => 440
    }
}

class bsd inherits unix {
    File["/etc/sudoers"] {
        group => wheel
    }
}
</pre>


<h3 id="UsingClassesOutsideofPuppet">Using Classes Outside of Puppet</h3>


<p>
puppet サーバで設定された Class 名が、puppet クライアントの /etc/puppet/classes.txt に保存されるので、それを外部プログラムなどから読み込んで利用したりできるよ、とうことらしい。
</p>


<p>
FC4 で yum insall した puppet の場合は、/var/lib/puppet/classes.txt に保存されていた。
</p>


<h3 id="Nodes">Nodes</h3>


<pre class="wiki">
node <hostname> { ... }
</pre>


<p>
特定のホストに適用する設定を割り当てる。
</p>


<p>
以下の例だと、file type はすべてのホストに割り当てられるけど、webserver class と dbserver class の中に書かれた設定は、それぞれ特定のホストにのみ割り当てられる。
</p>


<pre class="wiki">
class webserver { ... }
class dbserver { ... }

file { "/etc/sudoers": mode => 440 } # apply to everyone

node host1, host2 {
    include webserver
}
node host3, host4 {
    include dbserver
}
</pre>


<p>
node は継承することも可能。
</p>


<pre class="wiki">
node base {
    include $operatingsystem
}

node kirby inherits base {
    include webserver
}
</pre>


<p>
FQDN で指定する時は、シングルクォートで囲む。
</p>


<pre class="wiki">
node 'host.domain.com' {
    ...
}
</pre>


<h3 id="Conditionals">Conditionals</h3>


<p>
条件指定が可能。
</p>


<p>
以下の例は $os が何かによって、 $owner に入る値が変わる。
</p>


<pre class="wiki">
define testing(os) {
    $owner = $os ? {
        sunos => adm,
        redhat => bin,
        default => root
    }
    file { "/some/file": owner => $owner }
}
</pre>


<p>
以下の例は $operatingsystem が何かによって、適用する class が変わる。
</p>


<pre class="wiki">
case $operatingsystem {
    sunos:      { solaris {} } # apply the solaris class
    redhat:     { redhat  {} } # apply the redhat class
    default:    { generic {} } # apply the generic class
}
</pre>


<h3 id="Reservedwords">Reserved words</h3>


<p>
true, define, inherits, class は予約語。
</p>


<h3 id="Comments">Comments</h3>


<p>
sh スタイルのコメントが利用可。
</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/03/18/266/">Puppet の Node 設定ではまる</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-03-18T22:10:00+09:00" pubdate>Mar 18<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/03/18/266/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><ul><li><a class="ext-link" href="http://reductivelabs.com/trac/puppet/wiki/InstallationGuide"><span class="icon"></span>http://reductivelabs.com/trac/puppet/wiki/InstallationGuide</a></li>
<li><a class="ext-link" href="http://reductivelabs.com/trac/puppet/wiki/TestingGuide"><span class="icon"></span>http://reductivelabs.com/trac/puppet/wiki/TestingGuide</a></li>
<li><a class="ext-link" href="http://people.redhat.com/dlutter/puppet-app.html"><span class="icon"></span>http://people.redhat.com/dlutter/puppet-app.html</a></li></ul>


<p>
といったあたりを読みながら puppet を試していたのですが、node の設定ではまったのでメモ。
</p>


<p>
pueppt では、
</p>


<pre class="wiki">
node nag.example.com {
  include yum-rawhide
  include horde-db-pg
  include horde-nag
}
</pre>


<p>
といった設定でターゲットとなるホストと、そのホストでどのようなタスクを実行するかを定義できるのですが、これで puppetmasterd を実行すると、
</p>


<pre class="wiki">
Syntax error at '.' at /etc/puppet/manifests/site.pp:5 
</pre>


<p>
と怒られます。そこで、
</p>


<pre class="wiki">
node 'nag.example.com' {
  include yum-rawhide
  include horde-db-pg
  include horde-nag
}
</pre>


<p>
とクォートしてあげると OK でした。最初に挙げた URL にあるチュートリアルの例ではクォートされておらず、そのままやるとはまりますのでご注意を。
</p>


<p>
<strong>追記</strong><br />
<a class="ext-link" href="http://reductivelabs.com/trac/puppet/wiki/LanguageStructures"><span class="icon"></span>Language Structures</a> を読んだら、「You can specify fully-qualified node names, but you have to single-quote the names:」ってちゃんと書いてあった。
</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/03/18/304/">Cfengine よりも Puppet がよさげ</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-03-18T21:33:00+09:00" pubdate>Mar 18<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/03/18/304/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
<a class="ext-link" href="http://trombik.mine.nu/~cherry/w/index.php/2007/02/06/845/links-roundup-159"><span class="icon"></span>I, newbie &raquo; Links Roundup</a> 経由で puppet というシステム管理ツールを知って以来ずっと気になっていたのですが、このエントリの著者さんが <a class="ext-link" href="http://dev.gentoo.gr.jp/~trombik/pub/OSC2007/OSC2007.pdf"><span class="icon"></span>OSC2007 の発表資料(PDF)</a>で「Puppet is so sexy.」と書かれているのを見て、本気で触ってみることにしました。
</p>


<p>
puppet がどんなものかは、上記資料とか <a class="ext-link" href="http://www.madoro.org/nikki/entry/8"><span class="icon"></span>だ！日記さんのエントリ</a> にも書かれているのですが、<a class="ext-link" href="http://reductivelabs.com/trac/puppet/wiki/CfengineVsPuppet"><span class="icon"></span>本家の Cfengine vs. Puppet</a> というエントリから cfengine との違いを一部適当に意訳してみると、こんな感じです。
</p>


<ul><li>next-generation version of cfengine ということで、cfengine をベースとしながらも、より良いものを目指している。</li>
<li>リソース抽象化レイヤーにより、OS やディストリビューションの違いを意識しなくても良い。</li>
<li>タスクの実行順序を制御できる。（cfengine ではできないor難しいらしい。）</li>
<li>設定ファイルで記述する内部言語が強力になっている。</li>
<li>type の拡張が簡単。</li>
<li>Ruby でできている。</li></ul>


<p>
というわけで、cfengine の導入を検討して、<a class="ext-link" href="http://mizzy.org/linux/cfengine00.html"><span class="icon"></span>こんなエントリ</a> を書いたりしてたのですが、cfengine は捨てて puppet でいこうかな、と思ってます。
</p>


<p>
<a class="ext-link" href="http://reductivelabs.com/trac/puppet/browser/trunk/ext/emacs"><span class="icon"></span>emacs 用のヘルパーモード</a> なんかも提供されているのがさらに好印象です。<a class="ext-link" href="http://reductivelabs.com/trac/puppet/browser/trunk/ext/vim"><span class="icon"></span>vim 用もあるし</a>。
</p>


<p>
それから、まだ Experimental ですが、<a class="ext-link" href="http://reductivelabs.com/trac/puppetshow"><span class="icon"></span>puppetshow</a> という Rails でできたウェブインターフェースもあるようです。
</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/03/14/299/">Plagger について本に書きました</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-03-14T22:51:00+09:00" pubdate>Mar 14<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/03/14/299/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
タイトルは <a class="ext-link" href="http://www.9-ten.co.jp/bookdata/1654.php"><span class="icon"></span>MASHUP++</a> です。その名の通り、マッシュアップを主題とした本なのですが、主に自分でマッシュアップな開発をしてみたい、という方向けの本で、自分は「マッシュアップとプラガブルなフレームワーク」をテーマに、Plagger プラグインの開発方法について書きました。
</p>


<p>
内容としては、プラグイン開発の基礎知識として、
</p>


<ul><li>内部データ形式である Plagger::Feed と Plagger::Entry</li>
<li>フィードデータがどの様に入力、加工、出力されるのか</li>
<li>プラグインの用途と種類にはどんなものがあるのか</li>
<li>各プラグインの関係や実行フェーズ、実行順序</li></ul>


<p>
といったことを解説しています。また、後半は
</p>


<ul><li>各フェーズの実際のプラグインソースコードを引用しながらの解説</li>
<li>プラグインの雛形生成、ドキュメント、テストの書き方といったプラグイン開発の流れ</li></ul>


<p>
といった感じになっています。プラグインを開発してみたいけど、どこから手をつけていいのかわからない、という方に是非ご覧頂きたいです。
</p>


<p>
他にも <a class="ext-link" href="http://vgzh.dtdns.net/"><span class="icon"></span>さうなまん</a> さん、<a class="ext-link" href="http://www.koui.net/"><span class="icon"></span>鹿倉公維</a> さん、<a class="ext-link" href="http://graffiti-web.org/"><span class="icon"></span>セトウナオ</a> さん、<a class="ext-link" href="http://pickles.tv/"><span class="icon"></span>タナカミノル</a> さんといった <a class="ext-link" href="http://www.amazon.co.jp/dp/4872835905"><span class="icon"></span>.fla</a> の執筆陣による Flash を主体としたマッシュアップ（タナカさんは今回は Flash ではないですが）や、<a class="ext-link" href="http://www.catwalk.co.jp/"><span class="icon"></span>CATWALK</a> の三宅涼さん、澤久裕昭さんによる、これぞ正当なマッシュアップ、といった感じの PHP と JavaScript によるマッシュアップ、そして、タナカミノルさんと<a class="ext-link" href="http://www.tsumuji.net"><span class="icon"></span>原央樹</a> さんによる、<a class="ext-link" href="http://gainer.cc/"><span class="icon"></span>Gainer</a>というハードウェアを使ったマッシュアップなど、バリエーション豊かなマッシュアップがソースコードつきで解説されています。必読。
</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/03/10/377/">Assurer 近況</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-03-10T02:53:00+09:00" pubdate>Mar 10<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/03/10/377/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
<a class="ext-link" href="http://assurer.jp/trac"><span class="icon"></span>Assurer</a> の最近の状況など。
</p>


<h3 id="franckが開発に参加">franck が開発に参加</h3>


<p>
Plagger コミッタでもある <a class="ext-link" href="http://search.cpan.org/~franckc/"><span class="icon"></span>franck</a> がジョインしてくれ、プラグインやパッチなどを送ってくれたり、新しいアイデアを提案/実装してくれたりしてます。この週末も素敵な機能を実装してくれるみたいです。
</p>


<h3 id="Notifyフェーズの追加">Notify フェーズの追加</h3>


<p>
Notify フェーズを追加して、Notify::IRC を実装してみました。ほとんど Plagger からのパクリです。
</p>


<h3 id="Kwalifyによるコンフィグバリデーション">Kwalify によるコンフィグバリデーション</h3>


<p>
Assurer::ConfigLoader に、Kwalify によるコンフィグバリデーション処理が追加されました。実行時に設定ファイルのミスをお知らせしてくれます。
</p>


<p>
プラグインの場合は、当然プラグイン毎に設定内容が異なるわけですが、この辺りもちゃんと対応しています。
</p>


<h3 id="シェルモードのブラッシュアップ">シェルモードのブラッシュアップ</h3>


<pre class="wiki">
$ assurer.pl -c config.yaml --role=web
</pre>


<p>
といった形で、シェルモード起動時に、ターゲットとなるロールを指定できるのですが、機能追加により、
</p>


<pre class="wiki">
assurer> !on app1.foo.com app2.foo.com do uptime
assurer> !on /.*.foo.com/ do uptime
assurer> !with web db do uptime
assurer> !with /web|mail/ do uptime
</pre>


<p>
といった形で、シェルモード中にもターゲットホストやロールが指定できるようになっています。正規表現も使えます。
</p>


<p>
また、シェルモードからもテストが実行できるようになっています。こんな感じで。
</p>


<pre class="wiki">
assurer> !test SSH on app1.foo.com
assurer> !test SSH on /.*.foo.com/
assurer> !test SSH with web
assurer> !test SSH with /web|mail/ 
</pre>


<h3 id="並列度のコントロールと分散処理">並列度のコントロールと分散処理</h3>


<p>
テストの実行は assurer_test.pl を POE::Wheel::Run で起動することにより、並列実行させていたのですが、POE::Component::JobQueue を併用することにより、並列度をコントロールできるようにしました。
</p>


<p>
また、
</p>


<pre class="wiki">
exec_on:
  - host: localhost
    priority: 3
  - host: host0.example.com
    priority: 2
  - host: host1.example.cm
    priority: 1
</pre>


<p>
といった設定を行うことにより、複数のマシンで分散してテストを行う、ということができるようになってます。priority は今のところ設定しても意味はなく、ラウンドロビンでテストジョブを割り当ててるのですが、今後は priority に応じて割りてるジョブの数を調整したり、各マシンの負荷状況を見て調整したり、といったことができるようにしたいと考えています。
</p>


<h3 id="Test::WWW::Mechanizeプラグイン">Test::WWW::Mechanize プラグイン</h3>


<p>
Test::WWW::Mechanize をつかったテストも組み込めるようにしました。
</p>


<p>
まあ、こんな感じです。あまり詳しく書くと YAPC で話すネタがなくなるので、この辺で。
</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/02/27/463/">「PlaggerになくてYahoo!pipesにあるもの」は書き方が悪かったのではなく Plagger を理解してないだけ</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-02-27T13:08:00+09:00" pubdate>Feb 27<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/02/27/463/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
<a class="ext-link" href="http://pythonbeginner.blog78.fc2.com/blog-entry-214.html"><span class="icon"></span>「PlaggerになくてYahoo!pipesにあるもの」は書き方が悪かった</a> について。
</p>


<p>
Plagger について理解できてないだけです。書き方の問題じゃありません。まず、
</p>


<blockquote>
<p>
  このときPublish::Gmailがおかしいなと思った。なにがおかしいかというとフィルター機能があることだ。
</p>
</blockquote>


<p>
Publish::Gmail にはフィルタ機能はありません。Plagger に実装されているものを、Publish::Gmail で利用しているだけです。
</p>


<p>
また、Publish::Gmail で利用しているのは、実際はフィルタ機能ではなく、ルール機能だったりします。似たような機能でややこしいかもしれませんが、Plagger では フィルタとルールは別物です。
</p>


<blockquote>
<p>
  本来フィルターの機能はFilterが担うべきで、Publishのプラグインにつけるべき機能ではない。
</p>
</blockquote>


<p>
はい、Plagger はちゃんとそうなってますよ。
</p>


<blockquote>
<p>
  例えばBloglineからフィードを取得し、その中からいくつかのブログのフィードを各ブログごと取り出し各ブログごと異なる条件でフィルタリングしたり、はてなブックマークに登録し、残りのフィードはそのままGmailに送るということは本来的にはできないのでは無いかと考えた。
</p>
</blockquote>


<p>
できます。たとえば、mizzy.org だけローマ字変換して Gmail へ、残りはそのままはてブへ、ということであればこんな感じ。（設定はかなりはしょってますが。）
</p>


<pre class="wiki">
plugins:
  - module: Subscription::Bloglines

  - module: Filter::Romanize::Japanese
    rule:
      expression:  $args->{feed}->title eq 'mizzy.org'

  - module: Publish::Gmail
    rule:
      expression: $args->{feed}->title eq 'mizzy.org'

  - module: Publish::HatenaBookmark
    rule:
      expression: $args->{feed}->title ne 'mizzy.org'
</pre>


<p>
この例では、2つの Publish プラグインの出力対象フィードが別だから、プラグイン毎に rule 設定してるけど、両プラグインが同じフィードを出力するのであれば、Filter::Rule プラグインでフィルタすれば、rule を指定する必要がなくなる。
</p>


<p>
まあ、この辺りは分かりやすくはないから、誤解するのもしょうがいない気がするけれど、設定例だけ見て、そこから推測したものがあたかも実際の Plagger の仕様であるかのように書くのはやめようよ。
</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/02/25/402/">Angerwhale #0</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-02-25T21:07:00+09:00" pubdate>Feb 25<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/02/25/402/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
コメント/トラックバックスパムがうざいので、一時的に受け付けないようにしました。
</p>


<p>
で、blosxom で対策してもいいのですが、これを機会にブログツールを乗り換えようと、<a class="ext-link" href="http://trac.jrock.us/blog_software"><span class="icon"></span>Angerwhale</a> を試すことに。（本当は <a class="ext-link" href="http://catlxom.org/trac/"><span class="icon"></span>Catlxom</a> への乗換えを前々から検討していたのですが、大きく作り変えると typester さんがおっしゃっていたので、ちょっと様子見。）
</p>


<p>
Angerwhale と同様に、Catalyst ベースのブログツールに <a class="ext-link" href="http://typeface-project.org/"><span class="icon"></span>Typeface</a> というのがあるのですが、Angerwhale はエントリをファイルベースで管理するので、blosxom に近いものがあるし、作者の <a class="ext-link" href="http://search.cpan.org/~jrockway/"><span class="icon"></span>jrockway</a> は <a class="ext-link" href="http://tokyo2007.yapcasia.org/blog/"><span class="icon"></span>YAPC::Asia Tokyo 2007</a> にも来るので、もしかしたら話す機会もあるかもしれないので、こちらを使ってみることに。
</p>


<p>
使ってみてちょっと不便だな、と思ったのは、
</p>


<ul><li>エントリタイトルはメタデータとして管理する。</li>
<li>カテゴリ名はディレクトリ名そのまま表示。</li></ul>


<p>
の2点。
</p>


<p>
以下、もう少し詳しく説明します。まずはエントリタイトルの件。
</p>


<p>
Angerwhale ではエントリの作成時間などを、メタデータとして管理します。メタデータは <a class="ext-link" href="http://search.cpan.org/dist/File-Attributes/"><span class="icon"></span>File::Attributes</a> を利用して作られ、.<i>entry_file_name</i>.attributes といったファイルが、エントリファイルと同じディレクトリに作られます。内容は以下のように YAML になってます。
</p>


<pre class="wiki">
---
creation_time: 1172377648
guid: 813B071C-C488-11DB-BB28-6F396B4151C7
</pre>


<p>
このメタデータファイルに、
</p>


<pre class="wiki">
title: エントリタイトル
</pre>


<p>
といった記述があれば、これをエントリのタイトルとみなします。なければ、ファイル名から拡張子を除いたものがエントリのタイトルになります。
</p>


<p>
ファイル名とタイトルが違う、なんてことがよくあるわけですが、そうしたい場合には今の仕様だと、
</p>


<ol start="1"><li>エントリファイルを置く</li>
<li>一度ブラウザでアクセスしてメタデータファイルを作らせる</li>
<li>メタデータファイルを開いてエントリタイトルを記述する</li></ol>


<p>
なんてことをしなければいけない、ということになります。めんどいですね。
</p>


<p>
次にカテゴリ名の問題。
</p>


<p>
Angerwhale は カテゴリ ＝ ディレクトリなんですが、ブラウザ上にはディレクトリ名をそのまま表示しちゃうんですね。ディレクトリは英語で、表示は日本語でしたい、ってのもよくあることなので、これも不便ですね。
</p>


<p>
この辺り、パッチ作ったりして対応したいな、と思ってます。
</p>


<p>
また、以下のバグと思わしき問題もありました。
</p>


<ul><li>ホームにアクセスすると、カテゴリわけされたエントリが表示されない。</li>
<li>カテゴリにアクセスすると、404 エラー。</li></ul>


<p>
これは以下のパッチを書いて、jrockway に送ってみました。
</p>


<pre class="wiki">
Index: lib/Angerwhale/Model/Filesystem.pm
===================================================================
--- lib/Angerwhale/Model/Filesystem.pm  (revision 573)
+++ lib/Angerwhale/Model/Filesystem.pm  (working copy)
@@ -58,7 +58,7 @@
 sub get_article {
     my $self    = shift;
     my $article = shift;
-    my $base    = $self->base;
+    my $base    = shift || $self->base;

     die "article name contains weird characters"
       if $article =~ m{/};
@@ -90,10 +90,14 @@
         my $entry = "$base/$article";
         next if $article =~ m{^[.]};    # hidden files are also ignored
         next if !-r $entry;
-        next if -d $entry;

+        #next if -d $entry;
+        if ( -d $entry ) {
+            push @articles, $self->_ls($entry);
+            next;
+        }
         #entry is acceptable
-        my $article = $self->get_article($article);
+        my $article = $self->get_article($article, $base);
         push @articles, $article;

     }
</pre>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/02/24/418/">Plagger にあって Yahoo!pipes にあるもの</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-02-24T12:06:00+09:00" pubdate>Feb 24<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/02/24/418/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
<a class="ext-link" href="http://mizzy.org/program/plagger-ybooks.html"><span class="icon"></span>前回のエントリ</a> で取り上げた方のブログに、<a class="ext-link" href="http://pythonbeginner.blog78.fc2.com/blog-entry-209.html"><span class="icon"></span>Plagger になくてYahoo!pipesにあるもの</a> というエントリがあったので、それについても釣られて言及してみます。
</p>


<blockquote>
<p>
  基本的に Plagger の処理は一本道であり、複数の基本データを扱うことができなかったはず
</p>
</blockquote>


<p>
それ Plagger でもできるよ。複数の入力から一つの出力もできるし、一つの入力から複数の出力もできるし、複数の入力から複数の出力もできる。
</p>


<blockquote>
<p>
  いってみればPlaggerは一つの入力に一つの出力が対応している直線的な処理しかできない。それに対しYahoo!pipesは複数の入力に一つの出力が対応するという、逆ピラミッド的な処理もできる。これがPlagger になくてYahoo!pipesにあるものだ。（もしかして今はできるのかもしれない。） 
</p>
</blockquote>


<p>
id:otsune さんも<a class="ext-link" href="http://b.hatena.ne.jp/entry/http://pythonbeginner.blog78.fc2.com/blog-entry-209.html"><span class="icon"></span>指摘してる</a>けど、それ smartfeed で。
</p>


<p>
「Plagger の発展をフォローしてないので不正確かもしれない」とか「もしかして今はできるのかもしれない」などと書かれてますが、少なくとも SmartFeed::All は 2006/05/03 には作られているので、複数の入力に対して一つの出力は、かなり前からできます。
</p>


<p>
また、一つの入力から複数の出力、複数の入力から複数の出力は最初からできます。なので、「基本的に Plagger の処理は一本道」というのは完全に間違い。Plagger の発展をフォローしてない、というのは言い訳にならない。「少なくとも自分が使っていた頃のPlagger になくて」と書いてるけど、本当に使ってたの？ 
</p>


<p>
まあ、Yahoo!Books のエントリを見てもわかるように、Plagger が何かをまったくわかっていない人間のたわごとなので、適当に流しておくのが大人の対応なんでしょうが、Plagger ラブな人間としては、間違った情報広められるのは嫌な気分になるので。
</p>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/17/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/15/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2011/10/30/vimeo-tag-plugin/">vimeo tag plugin</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/10/29/typo-to-octopress/">Typo to Octopress</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/10/21/twan-tag-plugin/">TWAN tag plugin for Jekyll</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/10/17/first-post/">自宅サーバが死にました</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/10/05/MyResume/">MyResume</a>
      </li>
    
  </ul>
</section>




  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011 - Gosuke Miyashita -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mizzyorg';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
