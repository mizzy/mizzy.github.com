
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Gosuke Miyashita</title>
  <meta name="author" content="Gosuke Miyashita">

  
  <meta name="description" content="!html &lt;img src="http://covers.oreilly.com/images/0636920020875/lrg.jpg" /&gt; @kdmsnr さん の tweet で、Managing Infrastructure with Puppet と Pro &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mizzy.org/blog/page/3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Gosuke Miyashita" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-53984-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Gosuke Miyashita</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mizzy.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/07/08/ManagingInfrastructureWithPuppet/">ManagingInfrastructureWithPuppet</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2011-07-08T02:36:30+09:00" pubdate>Jul 8<span>th</span>, 2011</time>
        
         | <a href="/blog/2011/07/08/ManagingInfrastructureWithPuppet/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>!html</h1>

<pre><code>&lt;img src="http://covers.oreilly.com/images/0636920020875/lrg.jpg" /&gt;
</code></pre>

<hr />

<p><a href="http://twitter.com/#!/kdmsnr">@kdmsnr さん</a> の tweet で、<a href="http://oreilly.com/catalog/0636920020875">Managing Infrastructure with Puppet</a> と <a href="http://www.apress.com/9781430230571">Pro Puppet</a> が発売されている事を知ったので読んでみた。まずは Managing Infrastructure with Puppet について。</p>

<p>この本はとても薄い。全体で40ページ強くらい。なので、Puppet をまったく知らない人には全体像を知るためには良い本だけど、既に知っている人には物足りないと思う。</p>

<p>とは言っても、自分は最近の Puppet の動向を追えてないので、その辺の知識不足を補ってくれるような内容もあって、そこは良かった。</p>

<p>また、<a href="http://www.puppetlabs.com/mcollective/introduction/">MCollective</a> についても書かれていて、元々は Puppet Labs とは別なところで開発されていたツールなんで、Puppet とは完全に独立したツールだと思ってたんだけど、Puppet Labs 配下になってから統合が進められたようで、その辺の情報が得られたのがよかった。</p>

<p>以下、内容で気になったところなんかのメモ。</p>

<hr />

<h1>puppet コマンド</h1>

<p>0.25 の次は 2.6 という風にバージョン体系が変わり、それまで puppetmasterd や puppetd といった形で独立していたコマンドが puppet コマンドに統一された、ってことは <a href="http://twitter.com/#!/tnmt">ペパボのイケメンインフラエンジニアの tnmt くん</a> が<a href="http://blog.tnmt.info/2010/11/23/puppet-2-6/">既にブログに書いてある</a> んだけど、それに伴い、コマンドオプションも増えて、やれることが増えてる模様。その中で特に気になったオプションを紹介。</p>

<h2>puppet describe</h2>

<p>リソースタイプのリストを表示してくれたり、指定したリソースタイプに関する説明を表示してくれる。</p>

<p><em>リソースタイプのリスト</em></p>

<pre><code>$ puppet describe --list
These are the types known to puppet:
augeas          - Apply the changes (single or array of changes ...
computer        - Computer object management using DirectorySer ...
cron            - Installs and manages cron jobs
exec            - Executes external commands
file            - Manages local files, including setting owners ...
filebucket      - A repository for backing up files
group           - Manage groups
host            - Installs and manages host entries
k5login         - Manage the `
...
</code></pre>

<p><em>package リソースタイプの説明</em></p>

<pre><code>$ puppet describe package

package
=======
Manage packages.  There is a basic dichotomy in package
support right now:  Some package types (e.g., yum and apt) can
retrieve their own package files, while others (e.g., rpm and sun) cannot. 
For those package formats that cannot retrieve
their own files, you can use the `source` parameter to point to
the correct file.

Puppet will automatically guess the packaging format that you are
using based on the platform you are on, but you can override it
using the `provider` parameter; each provider defines what it
requires in order to function, and you must meet those requirements
to use a given provider.
</code></pre>

<p><strong>Autorequires:</strong> If Puppet is managing the files specified as a package&#8217;s</p>

<pre><code>`adminfile`, `responsefile`, or `source`, the package resource will
autorequire
those files.


Parameters
----------

- **adminfile**
    A file containing package defaults for installing packages.
    This is currently only used on Solaris.  The value will be
    validated according to system rules, which in the case of
    Solaris means that it should either be a fully qualified path
    or it should be in `/var/sadm/install/admin`.

...
</code></pre>

<p>詳しくは puppet describe &#8211;help を参照。</p>

<h2>puppet resource</h2>

<p>コマンドを実行してるマシンの指定されたリソースの状態を、Puppet マニフェストで表示してくれる。</p>

<p><em>host リソースの表示</em></p>

<p>/etc/hosts の内容を Puppet マニフェストで表示。</p>

<pre><code>$ puppet resource host
host { 'localhost.localdomain':
  ensure       =&gt; 'present',
  host_aliases =&gt; ['localhost'],
  ip           =&gt; '127.0.0.1',
  target       =&gt; '/etc/hosts',
}
host { 'localhost6.localdomain6':
  ensure       =&gt; 'present',
  host_aliases =&gt; ['localhost6'],
  ip           =&gt; '::1',
  target       =&gt; '/etc/hosts',
}
</code></pre>

<p><em>service リソースの表示</em></p>

<p>サービスの状態を Puppet マニフェストで表示。</p>

<pre><code>$ puppet resource service
service { 'NetworkManager':
  ensure =&gt; 'stopped',
  enable =&gt; 'false',
}
service { 'acpid':
  ensure =&gt; 'stopped',
  enable =&gt; 'true',
}
service { 'anacron':
  ensure =&gt; 'stopped',
  enable =&gt; 'true',
}
service { 'atd':
  ensure =&gt; 'running',
  enable =&gt; 'true',
}
service { 'autofs':
  ensure =&gt; 'stopped',
  enable =&gt; 'true',
}

...
</code></pre>

<p>既に環境構築されたマシンから Puppet マニフェストの雛形を生成する、とかいった目的に使えそう。</p>

<h2>puppet apply</h2>

<p>Puppet マニフェストを即座に適用できる。</p>

<p><em>test.pp 内のマニフェストを適用する</em></p>

<pre><code>$ puppet apply test.pp
</code></pre>

<p><em>直接マニフェストを文字列で指定するが &#8211;noop つけてるので実際には何もしない</em></p>

<pre><code>$ puppet apply --noop -e 'file { "/etc/passwd": mode =&gt; 600 }'
notice: /Stage[main]//File[/etc/passwd]/mode: current_value 644, should be 600 (noop)
notice: Finished catalog run in 0.05 seconds
</code></pre>

<p>ちょっとした動作確認なんかするのに便利そう。</p>

<hr />

<h1>Parameterized Classes</h1>

<p>define でリソース定義して、呼び出すときにパラメータを渡す、なんてことは以前からできてたけど、2.6 からは Class にパラメータを渡すことができるようになったらしい。</p>

<p>クラス定義はこんな感じ。</p>

<pre><code>class ruby ( $version = '1.8.7') {
    package { 'ruby': ensure =&gt; $version }
}
</code></pre>

<p>Parameterized Classes ではない、従来のクラスの呼び出し方。これだと、Ruby 1.8.7 がインストールされる。</p>

<pre><code>node 'test.example.jp' {
    include ruby
}
</code></pre>

<p>パラメータを渡してやると、Ruby 1.9.2 がインストールされる。</p>

<pre><code>node 'test.example.jp' {
    class { 'ruby': version =&gt; '1.9.2' }
}
</code></pre>

<p>便利そうだけど、従来の include とだいぶ書式が変わるので、混乱しそう。</p>

<hr />

<h1>Puppet Forge</h1>

<p>Puppet モジュールを集めた <a href="http://forge.puppetlabs.com/">Puppet Forge</a> なんてサイトができてたんだね。Puppet 版 CPAN といった感じ。<a href="http://github.com/puppetlabs/puppet-module-tool">puppet-module-tool</a> というコマンドラインツールを使って、モジュールのインストールとかパッケージングとか色々できるようなんだけど、この本には詳しい説明がなかった。Pro Puppet には詳しい説明があったので、Pro Puppet についての感想を書くときに、この辺について少し詳しく書くつもり。</p>

<hr />

<h1>MCollective</h1>

<p>MCollective は、複数のホストに対して同じ処理を並列実行するためのもの。<a href="https://fedorahosted.org/func/">Func</a> とか <a href="http://fabfile.org/">Fabric</a> とか <a href="http://www.capify.org/">Capistrano</a> みたいな位置づけ。</p>

<p>こんな感じで実行できる。（apache2 を再起動する例。）</p>

<pre><code>$ mc-service --with-class apache2 apache2 restart
$ mc-service --with-class apache2 --with-fact architecture=x86_64 apache2 restart
</code></pre>

<p>Puppet の特定のクラスを include してるホストでのみ実行とか、特定の fact (facter によって得られる値) にマッチするホストでのみ実行、という感じで Puppet と連動できる。</p>

<p><a href="http://projects.puppetlabs.com/projects/mcollective-plugins/wiki/AgentPuppetd">Puppetd Agent</a> というプラグインもあって、これを使うと、各ホストの puppet agent の操作を MCollective 経由でできる。つまり、puppet kick(古いバージョンだと puppetrun)の代わりに使える。これの何がうれしいのかというと、puppetrun では特定のクラスを include したホストだけを対象にする、ということをやろうと思うと、LDAP Nodes が必須だった（2.6 でもそうなのかは知らん）けど、このプラグインだとそれが不要になりそう、ってあたりかな。</p>

<p>あと、<a href="http://projects.puppetlabs.com/projects/mcollective-plugins/wiki/ToolPuppetcommander">Puppet Commander</a> というプラグインを使うと、puppet agent の同時起動数を制御できて、puppet master へ同時アクセスが集中しないようにコントロールできるらしい。大量にホストがある環境では良さそうですね。</p>

<p>それから、<a href="http://docs.puppetlabs.com/mcollective/simplerpc/agents.html">MCollective プラグインを書くためのドキュメントへのリンク</a> も載ってた。が本では詳しい説明はなし。</p>

<hr />

<p>というわけで、<a href="http://oreilly.com/catalog/0636920020875">Managing Infrastructure with Puppet</a> について気になった点は以上。次は <a href="http://www.apress.com/9781430230571">Pro Puppet</a> について、気が向いたら書きます。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/06/29/SubsonicThroughApacheProxy/">SubsonicThroughApacheProxy</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2011-06-29T22:40:54+09:00" pubdate>Jun 29<span>th</span>, 2011</time>
        
         | <a href="/blog/2011/06/29/SubsonicThroughApacheProxy/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://twitter.com/#!/earlcyborg">@earlcyborg くん</a> に教えてもらった <a href="http://www.subsonic.org/pages/index.jsp">Subsonic</a> がよさげなので、家の中に環境作り、Apache mod_proxy 経由でアクセスしようとしたらはまったのでメモ。</p>

<p>結論: ProxyPreserveHost On を入れないとはまる。</p>

<p>最初、</p>

<pre><code>&lt;VirtualHost *&gt;
ServerName subsonic.mizzy.org
ProxyPass / http://192.168.10.14:4040/
ProxyPassReverse / http://192.168.10.14:4040/
&lt;/VirtualHost&gt;
</code></pre>

<p>という設定で http://subsonic.mizzy.org/ にアクセスしたら、http://192.168.10.14:4040/login.view? にリダイレクトされてしまった。Subsonic にホスト名を設定するところもなさそう。そこで、おそらく Host ヘッダに設定されたホストがリダイレクト先になるんじゃなかろうか、と仮説を立てて、以下のように設定してみた。</p>

<pre><code>&lt;VirtualHost *&gt;
ServerName subsonic.mizzy.org
ProxyPreserveHost On
ProxyPass / http://192.168.10.14:4040/
ProxyPassReverse / http://192.168.10.14:4040/
&lt;/VirtualHost&gt;
</code></pre>

<p>これでうまくいった。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/06/25/ModRuidTestAgain/">ModRuidTestAgain</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2011-06-25T12:30:43+09:00" pubdate>Jun 25<span>th</span>, 2011</time>
        
         | <a href="/blog/2011/06/25/ModRuidTestAgain/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>3,4年ぐらい前に、[wiki:ModSuid2AndModRuidAndLinuxCapability  mod_suid2 とか mod_ruid とか Linux ケーパビリティとか] で、mod_ruid の setuid/setgid は、プロセス単位なのか、それともスレッド単位なのか、という実験をして、スレッド単位で setuid/setgid する、という結果が得られたんですが、Linux kernel 2.4 というだいぶ古い環境での実験だったので、比較的最近の環境で実験してみた。</p>

<p>OS はこんな感じ。</p>

<pre><code>$ uname -a
Linux h026.southpark 2.6.18-164.el5 #1 SMP Thu Sep 3 03:28:30 EDT 2009 x86_64 x86_64 x86_64 GNU/Linux
$ cat /etc/redhat-release
CentOS release 5.4 (Final)
</code></pre>

<p>httpd のバージョン。</p>

<pre><code>$ rpm -q httpd
httpd-2.2.3-45.el5.centos.1
</code></pre>

<p>ps でプロセス/スレッドが見やすいように /etc/httpd/conf/httpd.conf をいじる。</p>

<pre><code>&lt;IfModule worker.c&gt;
StartServers        1
MaxClients          1
MinSpareThreads     1
MaxSpareThreads     1
ThreadsPerChild     1
MaxRequestsPerChild  0
&lt;/IfModule&gt;
</code></pre>

<p>/etc/sysconfig/httpd の以下の行を有効にして worker mpm で動かす。</p>

<pre><code>HTTPD=/usr/sbin/httpd.worker
</code></pre>

<p>mod_ruid は処理が終わるとすぐに元のユーザに戻してしまうので、戻らないようにコメントアウト。</p>

<pre><code>#!diff
diff --git a/mod_ruid.c b/mod_ruid.c
index 5294d32..deed59b 100644
--- a/mod_ruid.c
+++ b/mod_ruid.c
@@ -269,9 +269,9 @@ static int ruid_suidback (request_rec * r)
        }
        cap_free(cap);

-       setgroups(0,NULL);
-       setgid(unixd_config.group_id);
-       setuid(unixd_config.user_id);
+       //setgroups(0,NULL);
+       //setgid(unixd_config.group_id);
+       //setuid(unixd_config.user_id);

        cap=cap_get_proc();
        capval[0]=CAP_SETUID;
</code></pre>

<p>apxs でビルド＆インストール。</p>

<pre><code>$ sudo /usr/sbin/apxs -a -i -l cap -c mod_ruid.c
</code></pre>

<p>/etc/init.d/httpd restart して、プロセスとスレッドの UID を確認。下3つは PID が同じなので、スレッドだと判断できる。UID はすべて apache。</p>

<pre><code>$ ps -eLf
UID        PID  PPID   LWP  C NLWP STIME TTY          TIME CMD
root     13005     1 13005  0    1 23:29 ?        00:00:00 /usr/sbin/httpd.worker
apache   13011 13005 13011  0    3 23:29 ?        00:00:00 /usr/sbin/httpd.worker
apache   13011 13005 13013  0    3 23:29 ?        00:00:00 /usr/sbin/httpd.worker
apache   13011 13005 13014  0    3 23:29 ?        00:00:00 /usr/sbin/httpd.worker
</code></pre>

<p>ここで httpd へアクセスし、再度 ps で確認。</p>

<pre><code>UID        PID  PPID   LWP  C NLWP STIME TTY          TIME CMD
root     13005     1 13005  0    1 23:29 ?        00:00:00 /usr/sbin/httpd.worker
apache   13011 13005 13011  0    3 23:29 ?        00:00:00 /usr/sbin/httpd.worker
100      13011 13005 13013  0    3 23:29 ?        00:00:00 /usr/sbin/httpd.worker
apache   13011 13005 13014  0    3 23:29 ?        00:00:00 /usr/sbin/httpd.worker
</code></pre>

<p>スレッドのひとつだけ UID が 100 になってる。これは mod_ruid.c に以下のようにデフォルトが定義されているから。</p>

<pre><code>#!c
#define SUID_DEFAULT_UID        100
#define SUID_DEFAULT_GID        100
</code></pre>

<p>というわけで、スレッド単位で setuid/setgid される、ということには変わりありませんでした、という結果に。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/06/25/DevOpsConference/">DevOpsConference</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2011-06-25T02:16:22+09:00" pubdate>Jun 25<span>th</span>, 2011</time>
        
         | <a href="/blog/2011/06/25/DevOpsConference/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://partake.in/events/b5472f43-5bc0-42d0-9469-dc70d7d95b24">DevOps カンファレンス</a> に参加してきたので、個人的なまとめ＆補足など。</p>

<p>といっても <a href="http://twitter.com/#!/kuwa_tw">@kuwa_tw さん</a> の <a href="http://togetter.com/li/153695">togetter まとめ</a> が既にあるので、まとめというよりは、自分が話した内容の補足なんかをしてみようかと。</p>

<p>プレゼンに利用したスライドは <a href="http://www.slideshare.net/mizzy/10devops">slideshare にアップ</a> してますが、話すこと前提でスライドの内容は薄いので、togetter と併せてご覧下さい。</p>

<p>カンファレンスの内容が素晴らしかったのは自分が敢えてここで書く必要はないので、個人的に内容以外でよかった点を挙げると、</p>

<ul>
<li><a href="http://twitter.com/#!/kdmsnr">@kdmsnr</a> さんと初めてお会いして、ウェブオペレーションを献本頂いたお礼を直接言うことができた！</li>
<li><a href="http://twitter.com/#!/riywo">@riywo</a> さんとは以前からお会いしたいなー、と思っていたので、ようやくその願いが叶った！</li>
</ul>


<p>といったあたりですかね。</p>

<p>自分の発表では最初に、Dev な人、Ops な人、Dev &amp;&amp; Ops な人、!(Dev &amp;&amp; Ops) な人、それぞれで挙手してもらったんですが、Dev な人が意外と多い印象でした。プレゼンでも話しましたが、元々 Ops 発祥のムーブメントなので、Ops の人の方が圧倒的に多いんじゃないかと思ってましたが、意外な結果でした。</p>

<p>ただし、スピーカー陣は全員 Ops 寄りな人で、Ops の話がメインでしたね。（<a href="http://twitter.com/#!/hiroshi19790209">諸富さん</a> は Dev も Ops も兼ねてらっしゃるようですが、Ops の話がメインでしたしね。）</p>

<p>第2回では Dev な人のお話をぜひ聞いてみたいですね。<a href="http://twitter.com/#!/acotie/status/84302902939750400">@acotie が何かしゃべってくれそうです</a> 。</p>

<p>それから、プレゼンに盛り込もうと思っていたけど、時間の関係で断念したんですが、DevOps に対する批判、というものもあります。</p>

<ul>
<li><a href="http://www.rationalsurvivability.com/blog/?p=1890">Incomplete Thought: The DevOps Disconnect | Rational Survivability</a></li>
<li><a href="http://teddziuba.com/2011/03/devops-scam.html">Devops Is a Poorly Executed Scam</a></li>
</ul>


<p>このうちのひとつめのエントリに対する John Allspaw 氏のコメントをプレゼンでは引用させてもらいました。</p>

<p>まあ、批判する人はどこにでもいるし、批判の内容もわからんでもないんですが、それが何か？という感じですね。</p>

<p>帰り際に <a href="http://twitter.com/#!/marqs">@marqs さん</a> と、みんな同じような問題意識を抱えているんだな、ということ、ただそれを適切に表す言葉がいままでなかったために、お互いの共通認識として情報を共有する場を持てなかった、でも、DevOps という言葉が与えられることによって、それがはっきりと共通認識として浮かび上がり、共有する場を持てるようなった、それって、とても素晴らしいことだよね、なんて事を話して、がっちり握手を交わしてきました。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/05/27/UfwOnCentOS5/">UfwOnCentOS5</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2011-05-27T01:05:06+09:00" pubdate>May 27<span>th</span>, 2011</time>
        
         | <a href="/blog/2011/05/27/UfwOnCentOS5/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://d.hatena.ne.jp/tokuhirom/">tokuhirom</a> さんが IRC で「<a href="https://launchpad.net/ufw">ufw</a> べんり！」「iptables より簡単」っておっしゃっていて、日頃から iptables のコマンドインターフェースは最悪だと思っていたので、お、それは試してみたい、ってことで、ちょろっと触ってみました。</p>

<p>ufw って Ubuntu に標準で付属してるんですね。Ubuntu 使ってないんで知りませんでした。で、ufw の u は Ubuntu の u なのかな、と思ったら、Uncomplicated Firewall の略だそうで、だったら普段一番使ってる CentOS5 でも動くかも、と思って、パッケージ作ったり軽く動かしたりしてみたんで、その記録です。（CentOS の今後については色々言われてますが、まあそこは気にせずに。）</p>

<p>まず RPM パッケージをつくろう、ってことで、ググったら <a href="http://www.openmamba.org/pub/openmamba/devel-ercolinux/specs/ufw.spec">ufw.spec</a> を見つけたので、これを CentOS5 で動くようにカスタマイズして、<a href="http://svn.mizzy.org/public/yum/SRPMS/ufw-0.30.1-1.src.rpm">ソース RPM</a> と <a href="http://svn.mizzy.org/public/yum/RPMS/centos/5/x86_64/RPMS/ufw-0.30.1-1.x86_64.rpm">バイナリ RPM</a> を作成。ufw は python 2.5 以降が必要なんですが、CentOS5 デフォルトは 2.4 なので、python26 パッケージが必要です。あと、spec のカスタマイズも超適当だけど気にしないでください。</p>

<p>で、パッケージインストール後、iptables が動いてない状態から、ufw enable して iptables -L -n してみたら、以下のようにルールが設定されていた。</p>

<pre><code>$ sudo /usr/sbin/ufw enable
Password: 
Command may disrupt existing ssh connections. Proceed with operation (y|n)? y
Firewall is active and enabled on system startup

$ sudo /sbin/iptables -L -n
Chain INPUT (policy DROP)
target     prot opt source               destination         
ufw-before-logging-input  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-before-input  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-after-input  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-after-logging-input  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-reject-input  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-track-input  all  --  0.0.0.0/0            0.0.0.0/0           

Chain FORWARD (policy DROP)
target     prot opt source               destination         
ufw-before-logging-forward  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-before-forward  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-after-forward  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-after-logging-forward  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-reject-forward  all  --  0.0.0.0/0            0.0.0.0/0           

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         
ufw-before-logging-output  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-before-output  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-after-output  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-after-logging-output  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-reject-output  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-track-output  all  --  0.0.0.0/0            0.0.0.0/0           

Chain ufw-after-forward (1 references)
target     prot opt source               destination         

Chain ufw-after-input (1 references)
target     prot opt source               destination         
ufw-skip-to-policy-input  udp  --  0.0.0.0/0            0.0.0.0/0           udp dpt:137 
ufw-skip-to-policy-input  udp  --  0.0.0.0/0            0.0.0.0/0           udp dpt:138 
ufw-skip-to-policy-input  tcp  --  0.0.0.0/0            0.0.0.0/0           tcp dpt:139 
ufw-skip-to-policy-input  tcp  --  0.0.0.0/0            0.0.0.0/0           tcp dpt:445 
ufw-skip-to-policy-input  udp  --  0.0.0.0/0            0.0.0.0/0           udp dpt:67 
ufw-skip-to-policy-input  udp  --  0.0.0.0/0            0.0.0.0/0           udp dpt:68 
ufw-skip-to-policy-input  all  --  0.0.0.0/0            0.0.0.0/0           ADDRTYPE match dst-type BROADCAST 

Chain ufw-after-logging-forward (1 references)
target     prot opt source               destination         
LOG        all  --  0.0.0.0/0            0.0.0.0/0           limit: avg 3/min burst 10 LOG flags 0 level 4 prefix `[UFW BLOCK] ' 

Chain ufw-after-logging-input (1 references)
target     prot opt source               destination         
LOG        all  --  0.0.0.0/0            0.0.0.0/0           limit: avg 3/min burst 10 LOG flags 0 level 4 prefix `[UFW BLOCK] ' 

Chain ufw-after-logging-output (1 references)
target     prot opt source               destination         

Chain ufw-after-output (1 references)
target     prot opt source               destination         

Chain ufw-before-forward (1 references)
target     prot opt source               destination         
ufw-user-forward  all  --  0.0.0.0/0            0.0.0.0/0           

Chain ufw-before-input (1 references)
target     prot opt source               destination         
ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           
ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED 
ufw-logging-deny  all  --  0.0.0.0/0            0.0.0.0/0           state INVALID 
DROP       all  --  0.0.0.0/0            0.0.0.0/0           state INVALID 
ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0           icmp type 3 
ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0           icmp type 4 
ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0           icmp type 11 
ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0           icmp type 12 
ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0           icmp type 8 
ACCEPT     udp  --  0.0.0.0/0            0.0.0.0/0           udp spt:67 dpt:68 
ufw-not-local  all  --  0.0.0.0/0            0.0.0.0/0           
ACCEPT     udp  --  0.0.0.0/0            224.0.0.251         udp dpt:5353 
ufw-user-input  all  --  0.0.0.0/0            0.0.0.0/0           

Chain ufw-before-logging-forward (1 references)
target     prot opt source               destination         

Chain ufw-before-logging-input (1 references)
target     prot opt source               destination         

Chain ufw-before-logging-output (1 references)
target     prot opt source               destination         

Chain ufw-before-output (1 references)
target     prot opt source               destination         
ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           
ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED 
ufw-user-output  all  --  0.0.0.0/0            0.0.0.0/0           

Chain ufw-logging-allow (0 references)
target     prot opt source               destination         
LOG        all  --  0.0.0.0/0            0.0.0.0/0           limit: avg 3/min burst 10 LOG flags 0 level 4 prefix `[UFW ALLOW] ' 

Chain ufw-logging-deny (2 references)
target     prot opt source               destination         
RETURN     all  --  0.0.0.0/0            0.0.0.0/0           state INVALID limit: avg 3/min burst 10 
LOG        all  --  0.0.0.0/0            0.0.0.0/0           limit: avg 3/min burst 10 LOG flags 0 level 4 prefix `[UFW BLOCK] ' 

Chain ufw-not-local (1 references)
target     prot opt source               destination         
RETURN     all  --  0.0.0.0/0            0.0.0.0/0           ADDRTYPE match dst-type LOCAL 
RETURN     all  --  0.0.0.0/0            0.0.0.0/0           ADDRTYPE match dst-type MULTICAST 
RETURN     all  --  0.0.0.0/0            0.0.0.0/0           ADDRTYPE match dst-type BROADCAST 
ufw-logging-deny  all  --  0.0.0.0/0            0.0.0.0/0           limit: avg 3/min burst 10 
DROP       all  --  0.0.0.0/0            0.0.0.0/0           

Chain ufw-reject-forward (1 references)
target     prot opt source               destination         

Chain ufw-reject-input (1 references)
target     prot opt source               destination         

Chain ufw-reject-output (1 references)
target     prot opt source               destination         

Chain ufw-skip-to-policy-forward (0 references)
target     prot opt source               destination         
DROP       all  --  0.0.0.0/0            0.0.0.0/0           

Chain ufw-skip-to-policy-input (7 references)
target     prot opt source               destination         
DROP       all  --  0.0.0.0/0            0.0.0.0/0           

Chain ufw-skip-to-policy-output (0 references)
target     prot opt source               destination         
ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           

Chain ufw-track-input (1 references)
target     prot opt source               destination         

Chain ufw-track-output (1 references)
target     prot opt source               destination         
ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0           state NEW 
ACCEPT     udp  --  0.0.0.0/0            0.0.0.0/0           state NEW 

Chain ufw-user-forward (1 references)
target     prot opt source               destination         

Chain ufw-user-input (1 references)
target     prot opt source               destination         

Chain ufw-user-limit (0 references)
target     prot opt source               destination         
LOG        all  --  0.0.0.0/0            0.0.0.0/0           limit: avg 3/min burst 5 LOG flags 0 level 4 prefix `[UFW LIMIT BLOCK] ' 
REJECT     all  --  0.0.0.0/0            0.0.0.0/0           reject-with icmp-port-unreachable 

Chain ufw-user-limit-accept (0 references)
target     prot opt source               destination         
ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           

Chain ufw-user-logging-forward (0 references)
target     prot opt source               destination         

Chain ufw-user-logging-input (0 references)
target     prot opt source               destination         

Chain ufw-user-logging-output (0 references)
target     prot opt source               destination         

Chain ufw-user-output (1 references)
target     prot opt source               destination         
</code></pre>

<p>で、今度は ufw disable してみたら、以下のようになった。chain は残る模様。</p>

<pre><code>$ sudo /usr/sbin/ufw disable
Firewall stopped and disabled on system startup

$ sudo /sbin/iptables -L -n
Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
ufw-before-logging-input  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-before-input  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-after-input  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-after-logging-input  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-reject-input  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-track-input  all  --  0.0.0.0/0            0.0.0.0/0           

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         
ufw-before-logging-forward  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-before-forward  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-after-forward  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-after-logging-forward  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-reject-forward  all  --  0.0.0.0/0            0.0.0.0/0           

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         
ufw-before-logging-output  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-before-output  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-after-output  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-after-logging-output  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-reject-output  all  --  0.0.0.0/0            0.0.0.0/0           
ufw-track-output  all  --  0.0.0.0/0            0.0.0.0/0           

Chain ufw-after-forward (1 references)
target     prot opt source               destination         

Chain ufw-after-input (1 references)
target     prot opt source               destination         

Chain ufw-after-logging-forward (1 references)
target     prot opt source               destination         

Chain ufw-after-logging-input (1 references)
target     prot opt source               destination         

Chain ufw-after-logging-output (1 references)
target     prot opt source               destination         

Chain ufw-after-output (1 references)
target     prot opt source               destination         

Chain ufw-before-forward (1 references)
target     prot opt source               destination         

Chain ufw-before-input (1 references)
target     prot opt source               destination         

Chain ufw-before-logging-forward (1 references)
target     prot opt source               destination         

Chain ufw-before-logging-input (1 references)
target     prot opt source               destination         

Chain ufw-before-logging-output (1 references)
target     prot opt source               destination         

Chain ufw-before-output (1 references)
target     prot opt source               destination         

Chain ufw-reject-forward (1 references)
target     prot opt source               destination         

Chain ufw-reject-input (1 references)
target     prot opt source               destination         

Chain ufw-reject-output (1 references)
target     prot opt source               destination         

Chain ufw-track-input (1 references)
target     prot opt source               destination         

Chain ufw-track-output (1 references)
target     prot opt source               destination         
</code></pre>

<p>とりあえず CentOS5 でも動くようなんで、色々遊んでみようと思う。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/05/12/WebOperations/">WebOperations</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2011-05-12T02:35:41+09:00" pubdate>May 12<span>th</span>, 2011</time>
        
         | <a href="/blog/2011/05/12/WebOperations/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>!html</h1>

<pre><code>&lt;a href="http://www.oreilly.co.jp/books/9784873114934/"&gt;&lt;img src="http://ec3.images-amazon.com/images/I/51-ThZ6FRfL._SS500_.jpg" /&gt;&lt;/a&gt;
</code></pre>

<p>献本頂きました。<a href="http://www.oreilly.co.jp/">O&#8217;Reilly Japan</a> 様、<a href="http://twitter.com/#!/kdmsnr">@kdmsnr</a> さん、<a href="http://twitter.com/#!/hmsk">@hmsk</a> さん、ありがとうございます！</p>

<p>本書はタイトルにある通り、ウェブの運用に関わる本なんですが、僕が敬愛する John Allspaw 氏と、Chef で有名な Opscode の CEO、Jesse Robbins 氏の監修による、17 + 1 本のエッセイ集で、監修の両氏以外にも様々な方によって書かれています。（+1 は日本語版のみに収録されている、@hmsk さんによるクックパッドのインフラの話です。）</p>

<p>目次は以下の通りとなっています。</p>

<ul>
<li>1章 ウェブオペレーション：キャリア</li>
<li>2章 Picnikにおけるクラウドコンピューティングの利用とその教訓</li>
<li>3章 インフラとアプリケーションのメトリクス</li>
<li>4章 継続的デプロイ</li>
<li>5章 コードとしてのインフラ</li>
<li>6章 監視</li>
<li>7章 いかにして複雑なシステムは失敗するか</li>
<li>8章 コミュニティ管理とウェブオペレーション</li>
<li>9章 予期しないトラフィック急増への対応</li>
<li>10章 開発と運用の協力と連携</li>
<li>11章 訪問者の気持ち：ユーザ対面メトリクス</li>
<li>12章 ウェブにおけるリレーショナルデータベースの戦略と戦術</li>
<li>13章 障害を活用する：ふりかえりの技芸と科学</li>
<li>14章 ストレージ</li>
<li>15章 非リレーショナルデータベース</li>
<li>16章 アジャイルインフラストラクチャ</li>
<li>17章 夜中に聞こえる奇妙な物音（と、ぐっすり眠る方法）</li>
<li>18章 日本の料理のインフラ</li>
</ul>


<p>このように、運用や監視の話、運用者のキャリアに関する話、クラウドに関する話、DevOps に関する話、リレーショナルや非リレーショナルなデータベースの話、ストレージの話、障害対応に関する話、などなど、ウェブの運用に関して多岐にわたった話が掲載されています。</p>

<p>どの話もとても興味深いのですが、特に興味深かったのは、「2章 Picnikにおけるクラウドコンピューティングの利用とその教訓」と「12章 ウェブにおけるリレーショナルデータベースの戦略と戦術」です。</p>

<p>ペパボでは写真サービス <a href="http://30d.jp/">30days Album</a> を提供していて、一時的な高負荷に対応するために、クラウドをいかに活用するかを模索しているところなので、同じ写真サービスである <a href="http://www.picnik.com/">Picnik</a> におけるクラウドの活用に関する話は、とても参考になります。（といってもサービスの性質が違うため、そのまま真似できるわけではありませんが。）</p>

<p>また、12章は、実践ハイパフォーマンスMySQL 第2版の著者の1人である、Baron Schwartz 氏によるもので、最適なデータベースアーキテクチャを選択するためにはどうすれば良いか、ということについて書いてるんですが、「GUID を（主キーに）使うのは、データベースが何であれ、最悪だ！」とか、「みんな平気な顔をしているようだが、もっとシャーディングを怖がるべきだ」「シャーディングはウェブアプリケーションに適したアーキテクチャではない」「まともなハードウェアを購入せずに大量の安いマシンでシャーディングアーキテクチャを構築し、スケーラビリティを確保しようとするのは、私に言わせれば、単なるバカだ」とか、「このプロダクトが、MySQL Cluster と呼ばれているのは残念」とか、小気味よい調子で良いアーキテクチャを選択するための指針を示してくれています。</p>

<p>詳しくはぜひお手元にとって読んでみて下さい。ひとつひとつの章が独立した話でそれほど長くないので、好きなところからさくっと読めるのがいいですね。自分は英語版は一通り読んだので、日本語版ではまずは 18章 のクックパッドさんの話から読んでみようと思います。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/04/27/SupervisorAProcessControlSystem/">SupervisorAProcessControlSystem</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2011-04-27T07:56:24+09:00" pubdate>Apr 27<span>th</span>, 2011</time>
        
         | <a href="/blog/2011/04/27/SupervisorAProcessControlSystem/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>node.js なサーバデーモン＆ログの管理をしようと思い、何を使おうか検討していたのですが、この手のデファクトスタンダードである <a href="http://cr.yp.to/daemontools.html">daemontools</a> は、特定のディレクトリ構造に従わないといけなかったり、run スクリプトや log/run スクリプトを置いたりしきゃいけなかったりで、余計な作業が多くてお手軽じゃない、ってことで <a href="http://smarden.org/runit/">runit</a> を見てみたんですが、ぱっと見 daemontools との違いがよくわからなくて、daemontools とそれほど煩雑さは変わらないように見えたので、もっとお手軽なものがないかと探していたところ見つけたのが <a href="http://supervisord.org/">Supervisor</a> 。（といっても自分が知らなかっただけで以前からあるみたいですが。）</p>

<p>Python 製で easy_install 一発でインストールできる。</p>

<pre><code>$ sudo easy_install supervisor  
</code></pre>

<p>デフォルトの設定ファイルを以下のように生成。</p>

<pre><code>$ sudo echo_supervisord_conf &gt; /etc/supervisord.conf
</code></pre>

<p>あとは実行。とりあえず試しなので、-n をつけてフォアグラウンド起動。</p>

<pre><code>$ sudo supervisord -n
2011-04-26 15:13:11,384 CRIT Supervisor running as root (no user in config file)
2011-04-26 15:13:11,420 INFO RPC interface 'supervisor' initialized
2011-04-26 15:13:11,421 CRIT Server 'unix_http_server' running without any HTTP authentication checking
2011-04-26 15:13:11,421 INFO supervisord started with pid 25859
</code></pre>

<p>この状態ではデーモンを一切管理してない。で、/etc/supervisord.conf を覗くと、以下のような記述があって、どうやらこんな感じで管理するデーモンを設定するらしい。</p>

<pre><code>;[program:theprogramname]
;command=/bin/cat              ; the program (relative uses PATH, can take args)
;process_name=%(program_name)s ; process_name expr (default %(program_name)s)
;numprocs=1                    ; number of processes copies to start (def 1)
;directory=/tmp                ; directory to cwd to before exec (def no cwd)
;umask=022                     ; umask for process (default None)
;priority=999                  ; the relative start priority (default 999)
;autostart=true                ; start at supervisord start (default: true)
;autorestart=true              ; retstart at unexpected quit (default: true)
;startsecs=10                  ; number of secs prog must stay running (def. 1)
;startretries=3                ; max # of serial start failures (default 3)
;exitcodes=0,2                 ; 'expected' exit codes for process (default 0,2)
;stopsignal=QUIT               ; signal used to kill process (default TERM)
;stopwaitsecs=10               ; max num secs to wait b4 SIGKILL (default 10)
;user=chrism                   ; setuid to this UNIX account to run the program
;redirect_stderr=true          ; redirect proc stderr to stdout (default false)
;stdout_logfile=/a/path        ; stdout log path, NONE for none; default AUTO
;stdout_logfile_maxbytes=1MB   ; max # logfile bytes b4 rotation (default 50MB)
;stdout_logfile_backups=10     ; # of stdout logfile backups (default 10)
;stdout_capture_maxbytes=1MB   ; number of bytes in 'capturemode' (default 0)
;stdout_events_enabled=false   ; emit events on stdout writes (default false)
;stderr_logfile=/a/path        ; stderr log path, NONE for none; default AUTO
;stderr_logfile_maxbytes=1MB   ; max # logfile bytes b4 rotation (default 50MB)
;stderr_events_enabled=false   ; emit events on stderr writes (default false)
;environment=A=1,B=2           ; process environment additions (def no adds)
;serverurl=AUTO                ; override serverurl computation (childutils)
</code></pre>

<p>これを真似して、node.js な echo サーバをデーモン化してみた。最低限以下の設定を書けば OK。</p>

<pre><code>[program:echo]
command=/usr/local/bin/node /home/miya/echo.js
stdout_logfile=/var/log/echo.log
stderr_logfile=/var/log/echo.log
</code></pre>

<p>これで起動してみる。</p>

<pre><code>$ sudo supervisord -n
2011-04-26 15:22:05,577 CRIT Supervisor running as root (no user in config file)
2011-04-26 15:22:05,612 INFO RPC interface 'supervisor' initialized
2011-04-26 15:22:05,612 CRIT Server 'unix_http_server' running without any HTTP authentication checking
2011-04-26 15:22:05,613 INFO supervisord started with pid 26078
2011-04-26 15:22:06,621 INFO spawned: 'echo' with pid 26079
2011-04-26 15:22:07,623 INFO success: echo entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
</code></pre>

<p>echo サーバがちゃんと起動した。こんな感じで、特定のディレクトリ構造にしたり、run スクリプト置いたりしなくても、4行ほど設定書くだけでさくっとデーモン化できる。試しに kill してみたら、再起動してくれた。</p>

<pre><code>2011-04-26 15:22:38,714 INFO exited: echo (exit status 1; not expected)
2011-04-26 15:22:39,718 INFO spawned: 'echo' with pid 26122
2011-04-26 15:22:40,720 INFO success: echo entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
</code></pre>

<p>include が使えるので、実運用ではデーモン毎にファイルをわけてやると管理しやすそう。</p>

<pre><code>;[include]
;files = relative/directory/*.ini
</code></pre>

<p>supervisorctl というコマンドラインツールでステータス確認や起動/停止ができる。</p>

<pre><code>$ sudo supervisorctl status echo
echo                             RUNNING    pid 26256, uptime 0:05:41

$ sudo supervisorctl stop echo
echo: stopped

$ sudo supervisorctl start echo
echo: started
</code></pre>

<p>何も引数を指定しなければ、対話型のインターフェースが起動する。</p>

<pre><code>$ sudo supervisorctl
echo                             RUNNING    pid 26161, uptime 0:01:43
supervisor&gt; 
</code></pre>

<p>? で利用できるコマンド表示。</p>

<pre><code>supervisor&gt; ?

default commands (type help &lt;topic&gt;):
=====================================
add    clear  fg        open  quit    remove  restart   start   stop  update 
avail  exit   maintail  pid   reload  reread  shutdown  status  tail  version
</code></pre>

<p>help command で command の説明。</p>

<pre><code>supervisor&gt; help stop
stop &lt;name&gt;     Stop a process
stop &lt;gname&gt;:*      Stop all processes in a group
stop &lt;name&gt; &lt;name&gt;  Stop multiple processes or groups
stop all        Stop all processes
</code></pre>

<p>それから、デフォルトではオフになってるけど、HTTP のインタフェースもある。こんな感じでオンにしてやる。（とりあえず検証目的なのでユーザ名やパスワードは設定しない。）</p>

<pre><code>[inet_http_server]         ; inet (TCP) server disabled by default
port=0.0.0.0:9001          ; (ip_address:port specifier, *:port for all iface)
;username=user             ; (default is no username (open server))
;password=123              ; (default is no password (open server))
</code></pre>

<p>ブラウザからアクセスするとこんな感じ。起動/停止やログの確認ができる。複数のデーモンを管理していれば、それらを一気に停止/起動もできるみたい。</p>

<p>[[Image(http://mizzy.org/img/supervisor.png)]]</p>

<p>supervisord 自体は、daemontools と同様、/etc/inittab とか、Upstart なら /etc/init/* とかで起動してやればいい。</p>

<p>いまいちなところは、multilog と違ってログにタイムスタンプつけてくれなかったり、syslog に吐く機能もなかったりと、ログまわりはちょっと物足りない。</p>

<p>他にも XML-RPC なインターフェースがあったり、色々機能はあるみたいなんだけど、とりあえず今日はこの辺で。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/04/05/NagiosBook/">NagiosBook</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2011-04-05T01:03:02+09:00" pubdate>Apr 5<span>th</span>, 2011</time>
        
         | <a href="/blog/2011/04/05/NagiosBook/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>!html</h1>

<pre><code>&lt;a href="http://www.amazon.co.jp/dp/4774145823"&gt;&lt;img src="http://image.gihyo.co.jp/assets/images/cover/2011/9784774145822.jpg" /&gt;&lt;/a&gt;
</code></pre>

<p>技術評論社様よりご献本頂きました。</p>

<p>タイトルの通り、監視ソフトウェア <a href="http://www.nagios.org/">Nagios</a> のリファレンス本です。日本語の Nagios に関する書籍としては、<a href="http://www.amazon.co.jp/dp/4839920168">Nagios 2.0オープンソースではじめるシステム&amp;ネットワーク監視</a> につづいて2冊目ですかね。（著者は同じ方のようです。）</p>

<p>本書の目次は以下のようになっています。</p>

<ul>
<li>第1章 Nagiosクイックスタート</li>
<li>第2章 Nagios標準プラグイン</li>
<li>第3章 メイン設定ファイル</li>
<li>第4章 CGI設定ファイル</li>
<li>第5章 オブジェクト設定ファイル</li>
<li>Appendix A Nagiosと周辺ツールの導入</li>
<li>Appendix B リソース設定ファイルとNagios標準マクロの概要</li>
</ul>


<p>同じ Software Design plus シリーズの監視ソフトウェアを扱った書籍である [wiki:ZabbixBook Zabbix統合監視「実践」入門 〜障害通知、傾向分析、可視化による省力運用〜] は、タイトルの通り入門書という感じで、はじめて Zabbix に触れる人を対象に、インストールから設定まで丁寧に書かれてるのに対し、こちらは「リファレンス」の名の通り、どちらかというと既に Nagios を利用している人向けのリファレンスとなっています。</p>

<p>第1章ではざっくりと Nagios とは何かの説明がされてますが、第2章以降はすべてプラグインや設定ファイル、設定項目ひとつひとつに関する説明がひたすら続いていきます。（Appendix A でインストールに関する説明があります。）</p>

<p>実際にサービス運用監視で Nagios を利用している人が手元に置いておいて、あれ、このプラグインのパラメータって何をどういう風に渡すんだっけ、とか、この設定項目いじると何がどうなるんだっけ、などといった時にパラパラめくったりするのに良さそうですね。</p>

<p>とは言うものの、<a href="http://www.paperboy.co.jp/">ペパボ</a> では Nagios 使ってるんですが、自分はサービスの運用監視には直接関わっていないため、Nagios にほとんど触れることがないんで、宝の持ち腐れですね。（監視シフトに合わせてウェブ上で timeperiods.cfg を設定するようなツールを作ったことがあるぐらいですね。） 良い機会なので、自宅サーバに Nagios 導入してみようかな。</p>

<p>あとこの本とは関係ないですが、Nagios といえば度々話題になるのは、どう発音するのか、ですよね。FAQ へのリンク貼っておきます。</p>

<ul>
<li><a href="http://support.nagios.com/knowledgebase/faqs/index.php?option=com_content&amp;view=article&amp;id=52&amp;catid=35&amp;faq_id=3&amp;expand=false&amp;showdesc=true">How do you pronounce Nagios?</a></li>
<li><a href="http://community.nagios.org/2007/02/20/nagios-pronunciation/">Nagios pronunciation</a></li>
</ul>


<p>2番目のエントリには以前音声ファイルがあった気がするんですが、今はないみたいですね。（たしか「<em>ナ</em>ギオス」と発音してました。「ナ」にアクセント。）</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/03/02/I4PC/">I4PC</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2011-03-02T08:47:20+09:00" pubdate>Mar 2<span>nd</span>, 2011</time>
        
         | <a href="/blog/2011/03/02/I4PC/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>[[Image(http://distillery.s3.amazonaws.com/media/2011/02/27/719cf326faad469c8a46d4e0148091f1_6.jpg)]]</p>

<p>[wiki:InstagramForPC Instagram for PC について] で書いていたウェブアプリですが、Instagram 公式 API が使えるようになったためようやく公開できるようになりました。（上の画像はデザインしてくださった <a href="http://daiskip.com">daiskip 先生</a> が撮影したもの。）名前を I4PC にあらためて公開しています。</p>

<p><a href="http://www.i4pc.jp/">I4PC</a></p>

<p>つくった人については、 <a href="http://www.i4pc.jp/about">About ページ</a> をご参照ください。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/02/23/TeXPageFilledWithImage/">TeXPageFilledWithImage</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2011-02-23T23:45:53+09:00" pubdate>Feb 23<span>rd</span>, 2011</time>
        
         | <a href="/blog/2011/02/23/TeXPageFilledWithImage/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>TeX で表紙画像的なものが作りたくて色々調べてたら、<a href="https://groups.google.com/group/fj.comp.texhax/browse_thread/thread/0be2662c944adf8f/6a4fdf56cfaeecaa?hl=ja&amp;pli=1">Google グループで見つけた</a> のでメモ。</p>

<pre><code>#!tex
\documentclass[a4paper]{jsbook}
\usepackage[dvipdfmx,hiresbb]{graphicx}
\begin{document}

\enlargethispage{\paperwidth}
\thispagestyle{empty}
\vspace*{-1truein}
\vspace*{-\topmargin}
\vspace*{-\headheight}
\vspace*{-\headsep}
\vspace*{-\topskip}
\noindent\hspace*{-1in}\hspace*{-\oddsidemargin}
\includegraphics[width=\paperwidth,height=\paperheight]{cover_image.png}

\end{document}
</code></pre>

<p>いくつか注意が必要で、</p>

<pre><code>#!tex
\enlargethispage{\paperwidth}
</code></pre>

<p>は、これがないと、1ページ目を画像いっぱいのページにしようと思っても空白ページになってしまい、画像いっぱいのページは2ページ目になってしまう。また、</p>

<pre><code>#!tex
\noindent\hspace*{-1in}\hspace*{-\oddsidemargin}
</code></pre>

<p>は奇数ページの場合なので、偶数ページの場合は、</p>

<pre><code>#!tex
\noindent\hspace*{-1in}\hspace*{-\evensidemargin}
</code></pre>

<p>とする。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/4/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/2/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/01/09/web-to-mobi-a-script-for-converting-web-sites-to-mobipocket-format/">Web-to-mobi - A script for converting web sites to mobipocket format</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/06/weechat-script-for-pushing-notification-to-im-dot-kayac-dot-com/">WeeChat script for pushing notification to im.kayac.com</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/12/20/lunar-eclipse/">Lunar Eclipse</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/12/20/a-picture-of-geminids/">A Picture of Geminids</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/12/13/maglica-presentation-at-hatena/">Maglica Presentation At Hatena</a>
      </li>
    
  </ul>
</section>




  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Gosuke Miyashita -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mizzyorg';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
