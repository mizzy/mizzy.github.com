
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Gosuke Miyashita</title>
  <meta name="author" content="Gosuke Miyashita">

  
  <meta name="description" content="source:library/perl/trunk/Parse-Apache-ServerStatus-Extended/lib/Parse/Apache/ServerStatus/Extended.pm NAME Parse::Apache::ServerStatus::Extended - &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mizzy.org/blog/page/13">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Gosuke Miyashita" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-53984-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Gosuke Miyashita</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mizzy.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/07/09/library-perl-trunk-Parse-Apache-ServerStatus-Extended-lib-Parse-Apache-ServerStatus-Extended.pm/">library/perl/trunk/Parse-Apache-ServerStatus-Extended/lib/Parse/Apache/ServerStatus/Extended.pm</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-07-09T21:03:59+09:00" pubdate>Jul 9<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/07/09/library-perl-trunk-Parse-Apache-ServerStatus-Extended-lib-Parse-Apache-ServerStatus-Extended.pm/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>source:library/perl/trunk/Parse-Apache-ServerStatus-Extended/lib/Parse/Apache/ServerStatus/Extended.pm</p>

<h1>NAME</h1>

<p>Parse::Apache::ServerStatus::Extended - Simple module to parse apache&#8217;s extended server-status.</p>

<h1>SYNOPSIS</h1>

<pre><code>    use Parse::Apache::ServerStatus::Extended;

    my $parser = Parse::Apache::ServerStatus::Extended-&gt;new;

    $parser-&gt;request(
       url     =&gt; 'http://localhost/server-status',
       timeout =&gt; 30
    ) or die $parser-&gt;errstr;

    my $stat = $parser-&gt;parse or die $parser-&gt;errstr;

    # or both in one step

    my $stats = $parser-&gt;get(
       url     =&gt; 'http://localhost/server-status',
       timeout =&gt; 30
    ) or die $parser-&gt;errstr;
</code></pre>

<h1>DESCRIPTION</h1>

<p>This module parses the content of apache&#8217;s extended server-status.It works nicely with apache versions 1.3 and 2.x.</p>

<h1>METHODS</h1>

<h2>new()</h2>

<p>Call <code>new()</code> to create a new Parse::Apache::ServerStatus::Extended object.</p>

<h2>request()</h2>

<p>This method accepts one or two arguments: <code>url</code> and <code>timeout</code>. It requests the url and safes the content into the object. The option <code>timeout</code> is set to 180 seconds if it is not set.</p>

<h2>parse()</h2>

<p>Call <code>parse()</code> to parse the extended server status. This method returns an array reference with the parsed content.</p>

<p>It&#8217;s possible to call <code>parse()</code> with the content as an argument.</p>

<pre><code>    my $stat = $prs-&gt;parse($content);
</code></pre>

<p>If no argument is passed then <code>parse()</code> looks into the object for the content that is stored by <code>request()</code>.</p>

<h2>get()</h2>

<p>Call <code>get()</code> to <code>request()</code> and <code>parse()</code> in one step. It accepts the same options like <code>request()</code> and returns the array reference that is returned by <code>parse()</code>.</p>

<h1>SEE ALSO</h1>

<p>Parse::Apache::ServerStatus</p>

<h1>AUTHOR</h1>

<p>Gosuke Miyashita <code>&lt;gosukenator at gmail.com&gt;</code></p>

<h1>LICENCE AND COPYRIGHT</h1>

<p>This module is free software; you can redistribute it and/or modify it under the same terms as Perl itself. See perlartistic.</p>

<h1>DISCLAIMER OF WARRANTY</h1>

<p>BECAUSE THIS SOFTWARE IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY FOR THE SOFTWARE, TO THE EXTENT PERMITTED BY APPLICABLE LAW. EXCEPT WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES PROVIDE THE SOFTWARE &#8220;AS IS&#8221; WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE. THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THE SOFTWARE IS WITH YOU. SHOULD THE SOFTWARE PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING, REPAIR, OR CORRECTION.</p>

<p>IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR REDISTRIBUTE THE SOFTWARE AS PERMITTED BY THE ABOVE LICENCE, BE LIABLE TO YOU FOR DAMAGES, INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES ARISING OUT OF THE USE OR INABILITY TO USE THE SOFTWARE (INCLUDING BUT NOT LIMITED TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY YOU OR THIRD PARTIES OR A FAILURE OF THE SOFTWARE TO OPERATE WITH ANY OTHER SOFTWARE), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGES.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/06/30/518/">Puppet の連載はじめました</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-06-30T15:10:00+09:00" pubdate>Jun 30<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/06/30/518/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://gihyo.jp/admin/serial/01/puppet">gihyo.jp で Puppet に関する連載をはじめました。</a></p>

<p>第1回目は、システム管理の自動化がなぜ必要なのか、ということと、Puppet がどういったツールなのか、その概要について書いています。</p>

<p>この連載を一通り読めば、Puppet をシステム管理の現場で実践するための十分な知識が得られる、といったものを目指しています。</p>

<p>分かりにくいなどご意見ございましたら、ぜひお知らせください。</p>

<p>3週間毎に更新予定です。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/06/14/517/">紫色の何かを口に押し付けている…</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-06-14T13:02:00+09:00" pubdate>Jun 14<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/06/14/517/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>会社に紫色のブツがあったので。</p>

<p><img src="http://blog.mizzy.org/files/something_purple.jpg" title="紫" alt="紫" /></p>

<p>この写真は DPL(Dr.Pepper License) により保護されています。ドクターペッパー1本おごってくれれば、自由に使ってもらって構いません。（ライセンス発案者は <a href="http://d.hatena.ne.jp/tokuhirom/">id:tokuhirom</a> さんと <a href="http://d.hatena.ne.jp/hirose31/">id:hirose31</a>  さん）</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/06/14/516/">紫色の何かを口に押し付けている…</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-06-14T12:34:00+09:00" pubdate>Jun 14<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/06/14/516/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>会社に紫色のブツがあったので…</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/05/25/515/">Puppet 勉強会資料</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-05-25T22:16:00+09:00" pubdate>May 25<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/05/25/515/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>ペパボ社内で実施した Puppet 勉強会の資料を<a href="http://trac.mizzy.org/puppet/wiki/LearningPuppet">パペウィキにアップしました</a>。</p>

<p>内容的には、Puppetをまったく知らない人が、とりあえず動かしてみるために最低限知っておく必要のある情報をまとめてみた、という感じです。既に触っている方や、どんなものか一通りご存知の方には当たり前の内容ばかりだと思います。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/05/25/514/">ペパボでは技術スタッフ正社員を募集しています</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-05-25T20:51:00+09:00" pubdate>May 25<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/05/25/514/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.paperboy.co.jp/recruit/job/070523.php">プログラマ</a> と <a href="http://www.paperboy.co.jp/recruit/job/070403b.php">サーバーエンジニア</a> の枠で正社員募集中です。</p>

<p>プログラマは、現在僕が出張で来ている福岡で、サーバエンジニアは東京での募集です。</p>

<p><a href="http://ieiriblog.jugem.jp/?eid=1061">社長から「頭がおかしい」と言われるような</a> <a href="http://paperboy.grouptube.jp/user/miyashita">こんな僕</a>が技術のトップなんぞやってる会社ですが、ドクターペッパーが好きなサーバエンジニアの方、ぜひ僕と一緒にリフレッシュエリアでドクターペッパー飲み飲み、社長の生態を観察しましょう。（リフレッシュエリアのソファに座ると、真正面にガラス越しの社長が観察できます。動物園気分が味わえますよ。）またはカレー（ハヤシ含む）を飲みながらでも OK です。</p>

<p>プログラマは福岡での募集ですが、たびたび出張で来ますので、ぜひ福岡オフィスの自販機にドクターペッパーを入れるよう、署名運動とかしてもらいたいと思います。そしてドクターペッパー飲みつつ、焼きカレーを食べましょう。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/05/25/513/">Write はユーザプロセスを待たせない？の答え</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-05-25T20:03:00+09:00" pubdate>May 25<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/05/25/513/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://blog.mizzy.org/articles/2007/05/23/linux-disk-io-00">前回のエントリ</a> について、naoya さんから<a href="http://d.hatena.ne.jp/naoya/20070523/1179938637">僕の期待以上の素晴らしい回答</a>を頂きました。感謝感謝です。</p>

<p>詳細は上記エントリをじっくり読んで頂きたいのですが、僕の疑問への直接の答えとなるのが、まとめにある</p>

<blockquote><ul>
<li>write はプロセスを待たせない</li>
<li>ただし明示的に sync する場合は待たせる</li>
</ul>
</blockquote>

<p>ですね。「write はプロセスを待たせない」が正しい、というのは naoya さんの解説を読んで納得しました。プロセスが write するということと、それが実際にディスクに書き出されることを、区別しないで考えていたのが僕の敗因ですね。</p>

<p>また、こちらの環境で kjournald や qmail-queue プロセスが待たされていたのは、sync してるから、ということでした。kjournald は確かめていないのですが、qmail-queue のソースの中では確かに fsync() が実行されていました。考えてみれば当然ですよね。ジャーナルのメタデータやメールキューなど、大事なデータを write して sync しないなんてことはあり得ないでしょうし。</p>

<p>なので、<a href="http://d.hatena.ne.jp/hirose31/">id:hirose31</a>さんからのコメント「fsync(2)のせい？」がずばり回答になっていました。ありがとうございます。今度カレーおごらせてください。</p>

<p>というわけで、「write はユーザプロセスを待たせない？」は「待たせない」が答え、ということで完結です。</p>

<p>あと、</p>

<blockquote><p>ということですが free の結果では、プロセスに割り当てるためのメモリが足りてるかどうかはわかりますが、ページキャッシュ用にメモリが足りてるかどうかはわかりません。</p>

<p>実際そのサーバーが主な仕事で使っているデータは、合計でどのぐらいのサイズでしょう。おそらく、キューに溜まったメールその他 OS 上で必要なデータのサイズをあわせると 800MB を超えるんではないかなあと思います。外してたらごめん。</p></blockquote>

<p>もおっしゃるとおりですね。プロセスに必要なメモリ容量と、キャッシュに必要なメモリ容量をちゃんと区別していませんでした。</p>

<p>となると、メモリを増やせば書き込み性能が向上する可能性があるのでは、と思ったのですが、今回のケースではおそらく向上することはなさそうです。というのも、iostat の値を見てると、avgqu-sz が 1 日平均でおよそ 5、短時間で見ると 10 とか 20 あるいはそれ以上ということがざらにあります。avgqu-sz はキューに入っていて待ちとなっている I/O リクエストの数なので、常に処理待ちとなっている I/O リクエストが存在する、ということなります。なので、ページキャッシュの容量の問題ではなく、ディスクの性能がボトルネックになっている、と言えそうです。（これも自分の勘違いなら恥ずかしいなー…メモリを簡単に増やせるなら、試してみたいんですけどね。）</p>

<p>naoya さん、詳細な解説ありがとうございました。大変勉強になりました。僕のために時間を割いて長文エントリ書いてくれた、と思うとちょっと萌えました。（べっ、別にあんたのために…、とか言われそうですが。）</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/05/23/512/">Write はユーザプロセスを待たせない？</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-05-23T00:24:00+09:00" pubdate>May 23<span>rd</span>, 2007</time>
        
         | <a href="/blog/2007/05/23/512/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://naoya.g.hatena.ne.jp/naoya/20070522/1179830475">naoyaグループ - naoyaの日記 -  I/O, iowait</a> にちょっと反応してみます。</p>

<blockquote><p>write はページに dirty フラグを立てるだけなので決してユーザープロセスを待たせない</p></blockquote>

<p>って、本当にそうなんでしょうか？（否定しているわけではなく、純粋な疑問です。）</p>

<p>最近、書き込みの多いメールサーバのディスク I/O 周りを調査していて、実際にどのプロセスの書き込みが多いのかを調べる方法がわからなかったため、I/O 待ちになっているプロセスをカウントして、そこから類推してみようと、まずは</p>

<pre><code>while [ 1 ]
  do
    ps -eo comm,state|grep D|grep -v COMMAND &gt;&gt; ps.txt
    sleep 1
  done
</code></pre>

<p>な感じで STAT が D のプロセスを記録するスクリプトをしばらく走らせておいて、</p>

<pre><code>sort ps.txt | uniq -c | sort -gr| more
</code></pre>

<p>でカウントしてみると、</p>

<pre><code>9129 kjournald       D
6576 qmail-queue     D
2017 multilog        D
1897 pdflush         D
1373 qmail-send      D
1094 procmail        D
1032 syslogd         D
</code></pre>

<p>な感じで、kjournald と qmail-queue が圧倒的に多い。これってどっちも書き込みがメインの仕事のはず。</p>

<p>man ps で見ても、</p>

<pre><code>D    Uninterruptible sleep (usually IO)
</code></pre>

<p>なので、書き込みでプロセスが待たされてるのだと思うのですが、何か間違ってますでしょうか？</p>

<p>ちなみに、書き込みが多いというのはどれぐらいかというと、iostat での r/s と w/s の比率が 1:7 ぐらいです。</p>

<p>また、free の結果はこんな感じなので、メモリに余裕はあるみたいです。</p>

<pre><code># free
             total       used       free     shared    buffers     cached
Mem:       2043756    2011160      32596          0     351016     847776
-/+ buffers/cache:     812368    1231388
Swap:      1052248
</code></pre>

<p>ここ数日 I/O まわりを追いかけていたので、naoya さんのエントリはタイムリーでとてもためになります。ついでに色々教えてもらおうという甘い考えで、疑問に感じたことを書いてみました。</p>

<p><strong><em>追記</em></strong></p>

<p>もしかして「write はユーザプロセスを待たせない」というのは、非同期 I/O の話？であれば納得はいく。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/05/13/511/">FizzBuzz アセンブラ版 for x86/Linux</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-05-13T21:01:00+09:00" pubdate>May 13<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/05/13/511/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://labs.cybozu.co.jp/blog/takesako/2007/05/fizzbuzz_x86.html">竹迫さん</a>、<a href="http://subtech.g.hatena.ne.jp/yappo/20070511/1178907299">Yappo さん</a> に触発されて、FizzBuzz アセンブラ版 for x86/Linux をつくってみた。</p>

<p>20年ほど前に Z80 でアセンブラをちょっとかじった程度の知識しかないので、ベストには程遠いコードだと思います。だれかもっといいコードを教えてください。</p>

<p>最初竹迫さんのコードと同じように書けるかな、と思ったのですが、Windows とちがって、画面に表示するだけで EAX, EBX, ECX, EDX レジスタ使うので、竹迫さんのように BX レジスタを見張り役に、CX レジスタをカウンタに、ってことができませんでした。</p>

<p>また、とりあえず書いただけで疲れたので、コードゴルフにチャレンジする気力はありません。</p>

<pre><code>global  _start

_start:
        mov     si, 0

mawasu: 
        call    space
        inc     si
        mov     ax, si

        mov     di, 3
        xor     edx, edx
        div     di
        cmp     dx, 0
        je      pfizz

        mov     ax, si
        mov     di, 5
        xor     edx, edx
        div     di
        cmp     dx, 0
        je      pbuzz

        call    num
        cmp     si, 100
        jb      mawasu

pfizz:
        call    fizz

        mov     ax, si
        mov     di, 5
        xor     edx, edx
        div     di
        cmp     dx, 0
        je      pbuzz

        jmp     mawasu

pbuzz:
        call    buzz
        jmp     mawasu

num:
        mov     ax, si

        mov     di, 100
        cmp     ax, di
        jnge    num2

        jmp     end

num2:
        mov     di, 10
        cmp     ax, di
        jnge    num3

        xor     edx, edx
        div     di
        add     ax, 48
        call    print

num3:   
        mov     ax, si
        mov     di, 10
        xor     edx, edx
        div     di
        mov     al, dl
        add     al, 48
        call    print
        ret

fizz:
        mov     al, 0x46
        call    print
        mov     al, 0x69
        call    print
        mov     al, 0x7a
        call    print
        call    print
        ret

buzz:
        mov     al, 0x42
        call    print
        mov     al, 0x75
        call    print
        mov     al, 0x7a
        call    print
        call    print
        ret

space:
        mov     al, 0x20
        call    print
        ret

print:
        push    eax
        mov     eax, 4
        mov     ebx, 1
        mov     ecx, esp
        mov     edx, 1
        int     0x80
        pop     eax
        ret

end:    
        mov     al, 0x0a
        call    print

        mov     al, 1
        mov     bl, 0
        int     0x80
</code></pre>

<p>nasm を使ってこんな感じで動かすことができます。</p>

<pre><code>$ nasm -f elf fizzbuzz.asm
$ ld -s -o fizzbuzz fizzbuzz.o
$ ./fizzbuzz 
</code></pre>

<p><img src="/files/fizzbuzz.jpg" alt="fizzbuzz.asm" /></p>

<p>書いていてアセンブラの TMTOWTDI っぷりは Perl の比じゃないと思った。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/05/11/510/">Linux の Iostat は何を見てるのか</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-05-11T01:54:00+09:00" pubdate>May 11<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/05/11/510/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Linux の iostat が出している数値が、正確には何なのか、ということを知る必要があり、調べてみたのでメモ。</p>

<p>知りたいのは、とりあえずは以下の様に実行した場合の、rrqm/s, wrqm/s, r/s, w/s の 4 つ。</p>

<pre><code>$ iostat -d -x
Device:    rrqm/s wrqm/s   r/s   w/s  rsec/s  wsec/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await  svctm  %util
sda          0.02  72.33  3.73 31.23   57.91  830.07    28.96   415.03    25.40     0.77   22.15   3.26  11.39
</code></pre>

<p>特に rrqm/s, wrqm/s が man を読んでもよく分からない。</p>

<pre><code>          rrqm/s
                 The  number  of read requests merged per second that
                 were issued to the device.

          wrqm/s
                 The number of write requests merged per second  that
                 were issued to the device.
</code></pre>

<p>r/s, w/s が実際にデバイスにリクエストされた I/O 数で、rrqm/s, wrqm/s が、プロセスからリクエストされたものの、デバイスに渡される前にマージされたリクエスト数ではないか、推測。それが正しいかどうか確かめる。</p>

<p>また、このリクエスト数というのが正確には何なのか、ということも確かめる。read/write 系のシステムコールの数？</p>

<p>まずはおそらく /proc/diskstat から値を取得しているのだろう、ということで、中身を見てみると、こんな行がある。</p>

<pre><code>8    0 sda 4506815 26232 69968005 66785384 37727406 87380973 1002794888 868225876 125 137597988 935021144
</code></pre>

<p>でもって、sysstat-5.0.5 の iostat.c を見てみると、544行目あたりにこんな記述があった。</p>

<pre><code>if (dev_type == DT_DEVICE)
   i = (fscanf(sysfp, "%lu %lu %llu %lu %lu %lu %llu %lu %lu %lu %lu",
       &amp;sdev.rd_ios, &amp;sdev.rd_merges,
       &amp;sdev.rd_sectors, &amp;sdev.rd_ticks,
       &amp;sdev.wr_ios, &amp;sdev.wr_merges,
       &amp;sdev.wr_sectors, &amp;sdev.wr_ticks,
       &amp;sdev.ios_pgr, &amp;sdev.tot_ticks, &amp;sdev.rq_ticks) == 11);
</code></pre>

<p>/proc/diskstat 内の sda 右横にあるカラム数とも一致してるので、ここと考えて良さそう。そうなると、r/s, rrqm/s が 1, 2番目のカラム、w/s と wrqm/s が 5,6 番目のカラム、ってことになる。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/14/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/12/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/01/10/webiblo-web-to-ebook-project-en/">Webiblo - web to ebook project</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/10/webiblo-web-to-ebook-project/">Webiblo - web to ebook project</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/09/web-to-mobi-a-script-for-converting-web-sites-to-mobipocket-format/">Web-to-mobi - A script for converting web sites to mobipocket format</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/06/weechat-script-for-pushing-notification-to-im-dot-kayac-dot-com/">WeeChat script for pushing notification to im.kayac.com</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/12/20/lunar-eclipse/">Lunar Eclipse</a>
      </li>
    
  </ul>
</section>




  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Gosuke Miyashita -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mizzyorg';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
