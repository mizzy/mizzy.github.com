
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Gosuke Miyashita</title>
  <meta name="author" content="Gosuke Miyashita">

  
  <meta name="description" content="Puppet Dojo で知り合った方から、Virt-Factory はもうアクティブじゃなくなって、今はoVirt という新しいプロジェクトに移ってる、ということをお聞きして、Virt-Factory のサイトに行ってみたら本当にそう書いてある！Xen が動かせるマシンが調達できたら、本格的に &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mizzy.org/blog/page/11">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Gosuke Miyashita" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-53984-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Gosuke Miyashita</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mizzy.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/03/04/oVirt00/">O Virt00</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2008-03-04T01:20:28+09:00" pubdate>Mar 4<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/03/04/oVirt00/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Puppet Dojo で知り合った方から、<a href="http://virt-factory.et.redhat.com/">Virt-Factory</a> はもうアクティブじゃなくなって、今は<a href="http://ovirt.org/">oVirt</a> という新しいプロジェクトに移ってる、ということをお聞きして、Virt-Factory のサイトに行ってみたら本当にそう書いてある！Xen が動かせるマシンが調達できたら、本格的に Virt-Factory 検証しよう、と思ってしばらくアクセスしてなかったら、いつの間にやらこんなことに…</p>

<p>つーわけで、Virt-Factory は捨てて oVirt の検証していくです。</p>

<p><a href="http://ovirt.org/install-instructions.html">Installing Instructions</a> を見てみると、パッケージを配布してるわけじゃなく、QEMU/KVM の仮想マシンイメージとして配布されてる模様。まずはこのイメージを動かすところまでやってみる。</p>

<p>検証環境は CentOS 5 x86_64 です。手順は上記サイトの「Installing the management appliance」の通りではあるのですが、説明があまり親切ではないし、その通りではうまくいかないところもあったので、試してみたい方は、以下の手順も合わせて参考にしてみてください。。</p>

<p>まずは VM イメージを取得。場所はどこでもいいんですが、自分は ~/vm というディレクトリを作成して、その下に置いた。</p>

<pre><code>$ mkdir ~/vm
$ cd ~/vm
$ wget http://ovirt.org/download/wui-appliance.dsk.bz2
$ bzip2 -d wui-appliance.dsk.bz2
</code></pre>

<p>次に必要なパッケージのインストール。</p>

<pre><code>$ sudo yum install libvirt qemu kvm
</code></pre>

<p>以下のような ~/vm/wui-appliance.xml を作成。</p>

<pre><code>&lt;domain type="kvm"&gt;
  &lt;name&gt;wui-appliance&lt;/name&gt;
  &lt;memory&gt;768000&lt;/memory&gt;
  &lt;currentMemory&gt;768000&lt;/currentMemory&gt;
  &lt;vcpu&gt;1&lt;/vcpu&gt;
  &lt;os&gt;
    &lt;type&gt;hvm&lt;/type&gt;
    &lt;boot dev="hd"/&gt;
  &lt;/os&gt;
  &lt;clock offset="utc"/&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;destroy&lt;/on_crash&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/bin/qemu-kvm&lt;/emulator&gt;
    &lt;disk type="file"&gt;
      &lt;source file="/home/miya/vm/wui-appliance.dsk"/&gt;
      &lt;target dev="hda"/&gt;
    &lt;/disk&gt;
    &lt;interface type="bridge"&gt;
      &lt;mac address="00:16:3e:08:97:e7"/&gt;
      &lt;source bridge="xenbr0"/&gt;
    &lt;/interface&gt;
    &lt;input type="mouse" bus="ps2"/&gt;
    &lt;graphics type="vnc" port="-1" listen="0.0.0.0"/&gt;
  &lt;/devices&gt;
&lt;/domain&gt;
</code></pre>

<p>libvirtd を起動して、virsh で qemu に接続、create でさきほどの XML ファイルを指定して VM 作成。</p>

<pre><code>$ sudo /sbin/chkconfig libvirtd on
$ sudo /etc/init.d/libvirtd start
$ sudo virsh --connect qemu:///system  
virsh #  create wui-appliance.xml
Domain wui-appliance created from wui-appliance.xml
virsh # list
 Id Name                 State
----------------------------------
  1 wui-appliance        running
</code></pre>

<p>以上で VM 起動まで完了。で、VM に SSH とかでアクセスしたいんだけど、IP アドレスがわからない！（VM の IP アドレスを外から知る方法をご存知な方は教えてください。）というわけで、virt-manager からつないでみることにする。</p>

<pre><code>$ sudo yum install virt-manager
</code></pre>

<p>virt-manager 入れたのはいいけど、CentOS は X 使えるようにしていないことに気づく。とりあえず手元の PC の cygwin に X が入ってたので、cygwin のシェルで</p>

<pre><code>$ startxwin.sh
$ xhost +
</code></pre>

<p>でもって CentOS 上で</p>

<pre><code>$ export DISPLAY=192.168.10.19:0.0
$ virt-manager
</code></pre>

<p>で virt-manager 起動。</p>

<p>[[Image(01.jpg)]]</p>

<p>無事に画面が出たので、QEMU を選択して接続。</p>

<p>[[Image(02.jpg)]]</p>

<p>VM が見えるので選択して、右下の「Open」をクリック。</p>

<p>[[Image(03.jpg)]]</p>

<p>無事アクセスできた。root のパスワードは ovirtwui 。</p>

<p>ここまでやってから、XML で MAC アドレス指定してるんだから、DHCP サーバのログから IP アドレス調べればいいだけだった、ということに気づく。</p>

<p>今日はここまで。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/02/03/YCombinatorWithPerl/">Y Combinator With Perl</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2008-02-03T03:03:52+09:00" pubdate>Feb 3<span>rd</span>, 2008</time>
        
         | <a href="/blog/2008/02/03/YCombinatorWithPerl/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>計算機科学を学んでいる人にとっては今更な話題らしいですが、経済学部出身の自分には目新しい話題なので書いてみます。（といっても、全然知らなかった、というわけでもないんですが。）</p>

<p><a href="http://d.hatena.ne.jp/amachang/20080124/1201199469">id:amachang</a> さんのエントリにある最終形のみを Perl で書くとこんな感じかな。</p>

<pre><code>#!perl
my $Y = sub {
    my $f = shift;
    return sub {
        my $g = shift;
        return sub {
            my $m = shift;
            return $f-&gt;($g-&gt;($g))-&gt;($m);
        }
    }-&gt;(
        sub {
            my $g = shift;
            return sub {
                my $m = shift;
                return $f-&gt;($g-&gt;($g))-&gt;($m);
            };
        }
    )
};

my $fib = sub {
    my $f = shift;
    return sub {
        my $n = shift;
        return $n &lt;= 2 ? 1 : $f-&gt;($n - 1) + $f-&gt;($n - 2);
    };
};

warn $Y-&gt;($fib)-&gt;(10);
</code></pre>

<hr />

<p>なぜこれで再帰として動作するかを考えるにあたって、<a href="http://d.hatena.ne.jp/gotin/20080127/1201372491">id:gotin</a> さんのエントリと同内容のことを、Perl で考えてみる。</p>

<p>簡単にするために最終形の Y コンビネータになる前の中間形のコードで考える。</p>

<pre><code>#!perl
my $Y = sub {
    my $f = shift;
    my $g;
    return $g = sub {
        my $n = shift;
        $f-&gt;($g)-&gt;($n);
    }
};

my $fib = sub {
    my $f = shift;
    return sub {
        my $n = shift;
        return $n &lt;= 2 ? 1 : $f-&gt;($n - 1) + $f-&gt;($n - 2);
    }
};

warn $Y-&gt;($fib)-&gt;(5);
</code></pre>

<p>$Y->($fib) は、 my $Y = sub { &#8230; } において、$f に $fib が代入され、結果として以下の関数が返ることになる。</p>

<pre><code>#!perl
sub {
    my $n = shift;
    $fib-&gt;($g)-&gt;($n);
}
</code></pre>

<p>そうなると $Y->($fib)->(5) は、以下のように変換できる。</p>

<pre><code>#!perl
$fib-&gt;($g)-&gt;(5)
</code></pre>

<p>$fib->($g) は、my $fib = sub { &#8230; } の $f に $g が代入されるので、$fib->($g)->(5) は、</p>

<pre><code>#!perl
sub {
   my $n = shift;
   return $n &lt;= 2 ? 1 : $g-&gt;($n - 1) + $g-&gt;($n - 2);
}-&gt;(5);
</code></pre>

<p>ということになる。</p>

<p>なのでこの $n に 5 が代入され、結果として $fib->($g)->(5) は以下のように変換される。</p>

<pre><code>#!perl
  $g-&gt;(4) ... [A]
+ $g-&gt;(3) ... [B]
</code></pre>

<p>[A] を更に変換してみると、$g->(4) は $fib->($g)->(4) となり、</p>

<pre><code>#!perl
sub {
   my $n = shift;
   return $n &lt;= 2 ? 1 : $g-&gt;($n - 1) + $g-&gt;($n - 2);
}-&gt;(4);
</code></pre>

<p>を実行するのと同じ。というわけで、$g->(4) は、</p>

<pre><code>#!perl
$g-&gt;(3) + $g-&gt;(2) ... [A]
</code></pre>

<p>になる。同様に [B] を変換すると、</p>

<pre><code>#!perl
$g-&gt;(2) + $g-&gt;(1) ... [B]
</code></pre>

<p>となる。今までのところまでをまとめると、$Y->($fib)->(5) は以下のように変換される。</p>

<pre><code>#!perl
  $g-&gt;(3) + $g-&gt;(2) ... [A]
+ $g-&gt;(2) + $g-&gt;(1) ... [B]
</code></pre>

<p>で、$g->(3) は [B] の変換と同様なので、更に以下のように変換される。</p>

<pre><code>#!perl
  $g-&gt;(2) + $g-&gt;(1) + $g-&gt;(2) ... [A]
+ $g-&gt;(2) + $g-&gt;(1)           ... [B]
</code></pre>

<p>ここで $g->(2) は、</p>

<pre><code>#!perl
sub {
   my $n = shift;
   return $n &lt;= 2 ? 1 : $g-&gt;($n - 1) + $g-&gt;($n - 2);
}-&gt;(2);
</code></pre>

<p>であり、$n &lt;= 2 であれば 1 が返る。ということは、$g->(2) も $g->(1) も 1 だから、[A] + [B] は以下のように変換される。</p>

<pre><code>#!perl
  1 + 1 + 1 ... [A]
+ 1 + 1     ... [B]
</code></pre>

<p>というわけで、結果は 5 になる。ということらしい。なんとなくわかった。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/01/12/VirtFactoryServerSetup/">Virt Factory Server Setup</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2008-01-12T15:41:17+09:00" pubdate>Jan 12<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/01/12/VirtFactoryServerSetup/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://trac.mizzy.org/public/wiki/VirtFactory">前回紹介した</a> Virt-Factory について、まずはサーバ側のインストールと設定手順を解説します。<a href="http://b.hatena.ne.jp/entry/http://trac.mizzy.org/public/wiki/VirtFactory">yappo さんと hirose31 さんに wktk されてしまった</a>ので、もう後には引けません。</p>

<p>おおまかな手順は <a href="http://virt-factory.et.redhat.com/vf-install-setup.php">本家サイトのドキュメント</a> の通りなのですが、ここの通りやってもうまくいかないので、試してみたい方は以下の手順を参考にしてください。</p>

<p>なお、本家から提供されているパッケージが Fedora 7 用のものしかないため、楽をするために Fedora 7 で検証しています。また、現時点での Virt-Factory のバージョンは 0.0.4 です。</p>

<h1>SELinux と iptables をオフに</h1>

<p>とりあえず検証目的なので、こいつらはオフにしときます。手順は省略。</p>

<h1>yum リポジトリの設定</h1>

<p>virt-factory.et.redhat.com のリポジトリを見に行くようにする。</p>

<pre><code>$ sudo wget http://virt-factory.et.redhat.com/download/repo/virt-factory.repo --output-document=/etc/yum.repos.d/virt-factory.repo
</code></pre>

<p>virt-factory.repo の内容が間違ってるので、以下のように修正。</p>

<pre><code>#!diff
--- /etc/yum.repos.d/virt-factory.repo.orig      2007-12-29 21:14:22.000000000 +0900
+++ /etc/yum.repos.d/virt-factory.repo   2007-12-29 21:14:55.000000000 +0900
@@ -1,11 +1,11 @@
 [virt-factory-fedora]
 name=Virt-factory packages
-baseurl=http://virt-factory.et.redhat.com/download/repo/fc$releasever/stable/$arch/
+baseurl=http://virt-factory.et.redhat.com/download/repo/f$releasever/stable/i386/
 enabled=1
 gpgcheck=0

 [virt-factory-srpms]
 name=Virt-factory src packages
-baseurl=http://virt-factory.et.redhat.com/download/repo/fc$releasever/stable/srpms
+baseurl=http://virt-factory.et.redhat.com/download/repo/f$releasever/stable/srpms
 enabled=0
 gpgcheck=0   
</code></pre>

<p>$arch の部分は Fedora 7 32bit だと i686 になってしまうが、リポジトリのディレクトリは i386 なので、修正が必要。64bit だと $arch 部分はそのままでいいかも。</p>

<h1>必要なパッケージのインストール</h1>

<p>普通に virt-factory-server パッケージを yum で入れると、依存関係で cobbler と koan が一緒にインストールされるのですが、updates にある cobbler 0.6.4 と koan 0.6.3 がインストールされてしまって、virt-factory-server が正常に動きません。なので、virt-factory.et.redhat.com にある 0.6.2 を明示的にインストールしてやります。</p>

<pre><code>$ sudo yum install cobbler-0.6.2-1.fc7  koan-0.6.2-1.fc7
</code></pre>

<p>次に、Virt-Factory サーバ本体である virt-factory-server パッケージをインストールします。また、依存関係にはないものの、python-setuptools も必要なので一緒に入れておきます。</p>

<pre><code>$ sudo yum install virt-factory-server python-setuptools
</code></pre>

<h1>PostgreSQL の初期化</h1>

<p>Virt-Factory はデータベースとして PostgreSQL を利用しています。（MySQL への対応予定もあるらしい。）以下のコマンドを実行して、Virt-Factory から PostgreSQL が利用できる状態にします。</p>

<pre><code>$ sudo /etc/init.d/postgresql initdb    
$ sudo vf_fix_db_auth
</code></pre>

<h1>デーモンの起動</h1>

<p>Puppet を利用してるので、とりあえず Puppet サーバを起動しておきます。（が、この段階では起動しなくても問題ないです。）</p>

<pre><code>$ sudo /sbin/chkconfig puppetmaster on 
$ sudo /etc/init.d/puppetmaster start
</code></pre>

<p>次に qpidd を起動します。これは必ず起動しておく必要があります。qpidd は、Virt-Factory のクライアント/サーバ間でのメッセージングのために利用されています。</p>

<pre><code>$ sudo /sbin/chkconfig qpidd on
$ sudo /etc/init.d/qpidd start 
</code></pre>

<p>最後に virt-factory-server を起動します。</p>

<pre><code>$ sudo /sbin/chkconfig virt-factory-server on
$ sudo /etc/init.d/virt-factory-server start
</code></pre>

<p>初回は起動時はデータベースとかテーブルを自動で作ってくれます。</p>

<h1>vf_server import の実行</h1>

<p>vf_server import により、以下の内容が実行されます。</p>

<ul>
<li>/etc/virt-factory/settings の repos セクションに基づく yum リポジトリミラーの作成</li>
<li>/etc/virt-factory/settings の mirrors セクションに基づくディストリビューションミラーの作成</li>
<li>プロファイルの作成</li>
</ul>


<p>ただし、プロファイルは cobbler import で作成されるものと一緒で、Virt-Factory に適したものではないため、捨ててしまって構いません。</p>

<p>まず、/etc/virt-factory/settings を2箇所いじります。mirrors のところは元は FC-7 になってるのですが、F-7 にしておく必要があります。</p>

<p>address は Virt-Factory サーバの IP アドレスを指定します。今回の import とは直接関係しませんが、どのみち変える必要があるので変えておきます。</p>

<pre><code>mirrors:
    F-7: [ 'rsync://ftp.jaist.ac.jp/pub/Linux/Fedora/releases/7/Fedora/i386/os/', '']
this_server:
    address: '192.168.25.134'
</code></pre>

<p>または、iso ファイルをダウンロードしてきて、</p>

<pre><code>$ sudo mkdir /mnt/dvdiso
$ sudo mount -t iso9660 -o loop F-7-i386-DVD.iso /mnt/dvdiso
</code></pre>

<p>とマウントして、/etc/virt-factory/settings には</p>

<pre><code>mirrors:
    F-7: [ '/mnt/dvdiso', '']
</code></pre>

<p>と設定してもいいです。検証で何度もやる場合には、iso イメージを持ってきておいた方が早いですね。</p>

<p>Virt-Factory でインストールするディストリビューションが Fedora 7 以外の場合には、repos セクションや mirrors セクションを適切に修正する必要があります。</p>

<p>設定ができたら、以下のコマンドを実行します。</p>

<pre><code>$ sudo vf_server import
</code></pre>

<p>cobbler report で結果を確認できます。distro, repo, profile が登録されていることが確認できます。</p>

<pre><code>$ sudo cobbler report
distro          : F-7-i386
kernel          : /var/www/cobbler/ks_mirror/F-7/images/pxeboot/vmlinuz
initrd          : /var/www/cobbler/ks_mirror/F-7/images/pxeboot/initrd.img
kernel options  : {}
architecture    : x86
ks metadata     : {'tree': 'http://@@server@@/cblr/links/F-7-i386'}
breed           : redhat

distro          : F-7-xen-i386
kernel          : /var/www/cobbler/ks_mirror/F-7/images/xen/vmlinuz
initrd          : /var/www/cobbler/ks_mirror/F-7/images/xen/initrd.img
kernel options  : {}
architecture    : x86
ks metadata     : {'tree': 'http://@@server@@/cblr/links/F-7-xen-i386'}
breed           : redhat

repo             : F-7-i386-core-lite
mirror           : http://download.fedora.redhat.com/pub/fedora/linux/releases/7/Everything/i386/os/
keep updated     : True
local filename   : F-7-i386-core-lite
rpm list         : ['m2crypto', 'python-simplejson']
createrepo_flags : -c cache

repo             : F-7-i386-updates-lite
mirror           : http://download.fedora.redhat.com/pub/fedora/linux/updates/7/i386/
keep updated     : True
local filename   : F-7-i386-updates-lite
rpm list         : ['cobbler', 'koan', 'python-cheetah', 'yum-utils', 'puppet',
'facter']
createrepo_flags : -c cache

repo             : F-7-i386-vf_repo
mirror           : http://virt-factory.et.redhat.com/download/repo/f7/stable/i386/
keep updated     : True
local filename   : F-7-i386-vf_repo
rpm list         :
createrepo_flags : -c cache

repo             : F-7-x86_64-core-lite
mirror           : http://download.fedora.redhat.com/pub/fedora/linux/releases/7/Everything/x86_64/os/
keep updated     : True
local filename   : F-7-x86_64-core-lite
rpm list         : ['m2crypto', 'python-simplejson']
createrepo_flags : -c cache

repo             : F-7-x86_64-vf_repo
mirror           : http://virt-factory.et.redhat.com/download/repo/f7/stable/x86_64/
keep updated     : True
local filename   : F-7-x86_64-vf_repo
rpm list         :
createrepo_flags : -c cache

profile         : F-7-i386
distro          : F-7-i386
kickstart       : /etc/cobbler/kickstart_fc6.ks
kernel options  : {}
ks metadata     : {}
virt file size  : 5
virt ram        : 512
virt type       : auto
virt path       :
repos           : []

profile         : F-7-xen-i386
distro          : F-7-xen-i386
kickstart       : /etc/cobbler/kickstart_fc6.ks
kernel options  : {}
ks metadata     : {}
virt file size  : 5
virt ram        : 512
virt type       : auto
virt path       :
repos           : [] 
</code></pre>

<h1>サンプルプロファイルのインポート</h1>

<p>virt-factory.et.redhat.com にサンプルプロファイルがあるので、こいつをインポートしてみます。</p>

<pre><code>$ sudo rpm -Uvh http://virt-factory.et.redhat.com/download/profiles/vf-profile-Container-1-2.fc7.noarch.rpm
$ sudo rpm -Uvh http://virt-factory.et.redhat.com/download/profiles/vf-profile-Test1-1.234-2.fc7.noarch.rpm
$ sudo vf_import
</code></pre>

<p>cobbler report を実行すると、以下の4つのプロファイルが登録されていることが確認できます。</p>

<pre><code>profile         : Container::F-7-i386
distro          : F-7-i386
kickstart       : /var/lib/virt-factory/kick-fc6.ks
kernel options  : {}
ks metadata     : {'server_name': '192.168.10.14', 'node_bare_packages': 'libvirt\npython-virtinst\nqemu\nkvm\n', 'cryptpw': '$1$mF86/UHC$WvcIcX2t6crBz2onWxyac.', 'server_param': '--server=http://192.168.10.14:5150', 'node_common_packages': 'koan\npuppet\nvirt-factory-nodes\nvirt-factory-register\nqemu\nkvm\n', 'network_param': '--allow-bridge-config', 'extra_post_magic': '/sbin/chkconfig 345 qemu on\n', 'node_virt_packages': '', 'token_param': '--profile=Container::F-7-i386'}
virt file size  : 0
virt ram        : 0
virt type       : qemu
virt path       :
repos           : ['F-7-i386-updates-lite', 'F-7-i386-core-lite', 'F-7-i386-vf_repo']

profile         : Container::F-7-xen-i386
distro          : F-7-xen-i386
kickstart       : /var/lib/virt-factory/kick-fc6.ks
kernel options  : {}
ks metadata     : {'server_name': '192.168.10.14', 'node_bare_packages': 'libvirt\npython-virtinst\nxend\n', 'cryptpw': '$1$mF86/UHC$WvcIcX2t6crBz2onWxyac.', 'server_param': '--server=http://192.168.10.14:5150', 'node_common_packages': 'koan\npuppet\nvirt-factory-nodes\nvirt-factory-register\nxen\nkernel-xen\n', 'network_param': '--allow-bridge-config', 'extra_post_magic': _, 'node_virt_packages': _, 'token_param': '--profile=Container::F-7-xen-i386'}
virt file size  : 0
virt ram        : 0
virt type       : xenpv
virt path       :
repos           : ['F-7-i386-updates-lite', 'F-7-i386-core-lite', 'F-7-i386-vf_repo'] 

profile         : Test1::F-7-i386
distro          : F-7-i386
kickstart       : /var/lib/virt-factory/kick-fc6.ks
kernel options  : {}
ks metadata     : {'server_name': '192.168.10.14', 'node_bare_packages': _, 'cryptpw': '$1$mF86/UHC$WvcIcX2t6crBz2onWxyac.', 'server_param': '--server=http://192.168.10.14:5150', 'node_common_packages': 'koan\npuppet\nvirt-factory-nodes\nvirt-factory-register\nqemu\nkvm\n', 'network_param': '', 'node_virt_packages': _, 'token_param': '--profile=Test1::F-7-i386'}
virt file size  : 5
virt ram        : 512
virt type       : qemu
virt path       :
repos           : ['F-7-i386-updates-lite', 'F-7-i386-core-lite', 'F-7-i386-vf_repo']

profile         : Test1::F-7-xen-i386
distro          : F-7-xen-i386
kickstart       : /var/lib/virt-factory/kick-fc6.ks
kernel options  : {}
ks metadata     : {'server_name': '192.168.10.14', 'node_bare_packages': _, 'cryptpw': '$1$mF86/UHC$WvcIcX2t6crBz2onWxyac.', 'server_param': '--server=http://192.168.10.14:5150', 'node_common_packages': 'koan\npuppet\nvirt-factory-nodes\nvirt-factory-register\nxen\nkernel-xen\n', 'network_param': '', 'node_virt_packages': _, 'token_param': '--profile=Test1::F-7-xen-i386'}
virt file size  : 5
virt ram        : 512
virt type       : xenpv
virt path       :
repos           : ['F-7-i386-updates-lite', 'F-7-i386-core-lite', 'F-7-i386-vf_repo']
</code></pre>

<p>cobbler import した時のプロファイルと違って、ks_metadata に koan, pupppet, virt-factory-nodes, virt-factory-register など、Virt-Factory クライアントとして必要なパッケージが含まれていたり、キックスタートファイル（/var/lib/virt-factory/kick-fc6.ks ）の %post セクションで、Virt-Factory クライアントとして必要な処理が実行されています。</p>

<h1>Web UI のインストール、設定、起動</h1>

<p>virt-factory-wui パッケージをインストールするのですが、そのままインストールすると、rubygem-rails-2.0.1-1.fc7 がインストールされてしまい、動作しません。なので、明示的に rubygem-rails-1.2.3-1.fc7 をインストールします。</p>

<pre><code>$ sudo yum install rubygem-rails-1.2.3-1.fc7
</code></pre>

<p>その後 virt-factory-wui パッケージをインストールします。</p>

<pre><code>$ sudo yum install virt-factory-wui
</code></pre>

<p>デフォルトでは 127.0.0.1 でリッスンするようになっているので、他のマシンからアクセスする場合には、/etc/init.d/virt-factory-wui を書き換えます。</p>

<pre><code>#!diff
--- /etc/init.d/virt-factory-wui.orig       2007-12-30 02:41:06.000000000 +0900
+++ /etc/init.d/virt-factory-wui    2007-12-30 02:41:23.000000000 +0900
@@ -10,7 +10,7 @@
 VIRTFACTORY_DIR=/usr/share/virt-factory-wui
 MONGREL_LOG=/var/log/virt-factory-wui/mongrel.log
 MONGREL_PID=/var/run/virt-factory-wui/mongrel.pid
-ADDR=127.0.0.1
+ADDR=0.0.0.0
 RAILS_ENVIRONMENT=production
 USER=virtfact
 GROUP=virtfact
</code></pre>

<p>起動します。</p>

<pre><code>$ sudo /sbin/chkconfig virt-factory-wui on
$ sudo /etc/init.d/virt-factory-wui start  
</code></pre>

<p>css ファイルへのパスがおかしいので、/usr/share/virt-factory-wui/app/views/layouts/virt-factory-layout.rhtml を修正します。</p>

<pre><code>#!diff
--- /usr/share/virt-factory-wui/app/views/layouts/virt-factory-layout.rhtml.ori2007-12-30 02:44:24.000000000 +0900
+++ /usr/share/virt-factory-wui/app/views/layouts/virt-factory-layout.rhtml    2007-12-30 02:44:40.000000000 +0900
@@ -7,7 +7,7 @@
      &lt;!-- dynamically filled in page title --&gt;
      &lt;title&gt;virt-factory: &lt;%= @page_title %&gt;&lt;/title&gt;

-     &lt;link rel="stylesheet" href="&lt;%= ActionController::AbstractRequest.relative_url_root %&gt;/style.css" type="text/css" /&gt;
+     &lt;link rel="stylesheet" href="/style.css" type="text/css" /&gt;

   &lt;/head&gt;
</code></pre>

<p>3000番 ポートにアクセスして、admin, fedora でログインします。</p>

<h1>virt-factory-ampm のインストール</h1>

<p>virt-factory-ampm は、Virt-Factory のコマンドラインクライアントで、リモートホスト上に仮想マシンを作成したり、仮想マシンの起動/停止を行ったり、といったことができます。</p>

<pre><code>$ sudo yum install virt-factory-ampm 
</code></pre>

<p>このままだと ampm コマンドを実行する度に no config file found と言われてうざいので、空の .ampm_config を作成しておきます。</p>

<pre><code>$ touch ~/.ampm_config
</code></pre>

<p>help を見ると、どんなことができるかがざっとわかります。</p>

<pre><code>$ ampm --help
global options
         --help, -h
         --verbose, -v
         --server &lt;server url&gt;
         --username &lt;username&gt;
         --passowrd &lt;password&gt;
valid modes include:
         pause, create, list, start, add, shutdown, query, unpause, delete
pause:
        Pause a guest
        ampm pause guest_name [--guest_id] &lt;guest_id&gt;
create:
        Create a new guest
        --help, -h
        --verbose, -v
        --host &lt;hostname&gt;           the  host to run the guest on
        --profile &lt;profilename&gt;     the profile to create the guest with
list:
        List information about virt-factory
        valid sub modes are hosts, guests, status, profiles, tasks, users
                 hosts      list machines capabable of running guests
                 guests     list virtulized guests
                 status     list status of virtulized guests
                 profiles   list profiles available for creating guests or hosts
                 tasks      list tasks that are queued
                 users      list users
start:
        Start up a guest
        ampm start guest_name [--guest_id] &lt;guest_id&gt;
add:
         Add a new user to virt-factory
         --username &lt;username&gt;
         --password &lt;password&gt;
         --first &lt;first_name
         --middle &lt;middle_name&gt;
         --last &lt;last_name&gt;
         --email &lt;email address&gt;
         --description &lt;desription&gt;
shutdown:
        Shutdown a guest
        ampm shutdown guest_name [--guest_id] &lt;guest_id&gt;
query:
        Query a guest for more info about what host or profile a guest is running
        --help, -h
        --verbose, -v
        --host &lt;host&gt;     which host a guest is running on
        --profile &lt;profile&gt;          which profile a guest is running
unpause:
        Unpause a guest
        ampm unpause guest_name [--guest_id] &lt;guest_id&gt;
delete:
        Delete a task, profile, or user
         --help, -h
         --verbose, -v
         --task_id &lt;task_id&gt;            delete a task from the task queue
         --user_id &lt;user_id&gt;            delete a user
</code></pre>

<p><del>次回はクライアント側のインストールと設定手順について解説予定です。</del><a href="http://trac.mizzy.org/public/wiki/VirtFactoryClientSetup">解説アップしました</a>。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/01/12/VirtFactoryClientSetup/">Virt Factory Client Setup</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2008-01-12T15:38:49+09:00" pubdate>Jan 12<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/01/12/VirtFactoryClientSetup/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://trac.mizzy.org/public/wiki/VirtFactoryServerSetup">前回</a>に続き、今回はクライアント側の手順です。クライアント側では、必要なソフトウェアのインストールと、サーバへの登録を行います。</p>

<p>クライアントのサーバへの登録は、既に OS がインストールされた状態から行う方法と、OS がインストールされていないまっさらな状態から行う方法の2つがあります。</p>

<p>以下、2つの方法について手順を解説します。これもサーバと一緒で、Fedora 7 で試しています。</p>

<h1>既に OS がインストールされた状態から行う方法</h1>

<h2>SELinux と iptables をオフに</h2>

<p>とりあえず検証目的なので、こいつらはオフにしときます。手順は省略。</p>

<h2>yum リポジトリの設定</h2>

<p>これは <a href="http://trac.mizzy.org/public/wiki/VirtFactoryServerSetup#yum%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%81%AE%E8%A8%AD%E5%AE%9A">サーバ側の設定</a> と同じなので省略。</p>

<h2>必要なパッケージのインストール</h2>

<p>Virt-Factory は仮想サーバの管理を行うためのものなので、当然何らかの仮想環境が必要。というわけで、Xen カーネルとツールをインストール。</p>

<pre><code>$ sudo yum install kernel-xen xen
</code></pre>

<p>それから、Python をアップデートしないと、後述する virt-factory-node-server でエラーが出たので、アップデートしておく。</p>

<pre><code>$ sudo yum update python
</code></pre>

<p>Xen カーネルで起動するために、再起動する。</p>

<p>現在の Virt-Factory は、Cobbler/Koan 0.6.2 を前提にしているため、バージョン指定で 0.6.2 をインストール。</p>

<pre><code>$ sudo yum install koan-0.6.2-1.fc7
</code></pre>

<p>その他必要なパッケージをインストール。</p>

<pre><code>$ sudo yum install virt-factory-nodes virt-factory-register libvirt-python
</code></pre>

<h2>サーバへの登録</h2>

<p>Virt-Factory クライアントをサーバに登録するためには、次のコマンドを実行します。</p>

<pre><code>$ sudo vf_register --serverurl=http://server.example.org:5150 --profile=Container     
</code></pre>

<p>server.example.org の部分は、サーバ側で Python の socket.gethostname() で取得できるホスト名と同一である必要があります。（qpid でのメッセージング処理の関係で。）</p>

<p>登録が正常に完了すれば、サーバ側で ampm コマンドを実行して、確認することができます。（Web UI でも確認できます。）</p>

<pre><code>$ sudo ampm list hosts
hostname: client.example.org id: 1 profile_name: Container::F-7-xen-i386 
</code></pre>

<p>最後に virt-factory-node-server を起動します。</p>

<pre><code>$ sudo /sbin/chkconfig virt-factory-node-server on
$ sudo /etc/init.d/virt-factory-node-server start
</code></pre>

<h1>OS がインストールされていない状態からの登録</h1>

<p>OS がインストールされていない場合、PXE ブートからネットワークインストールを行い、その流れでサーバへの登録まで一気にやってしまいます。これは、<a href="http://trac.mizzy.org/public/wiki/VirtFactoryServerSetup#yum%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%81%AE%E8%A8%AD%E5%AE%9A">前回の手順でインポートしたプロファイル</a>の中で、これらの手順をすべてやるように指定されているので、特にこれ以上何かを設定する必要はありません。マシンを PXE ブートし、boot: プロンプトでプロファイル名 (Container::F-7-xen-i386)を入力すれば、あとは全て自動的に進んでいくはずです。（まだきちんと検証できてません。）</p>

<p>また、事前に Web UI で MAC アドレスを登録しておけば、boot: プロンプトにプロファイル名を入れる必要すらありません。</p>

<p>以上で、Virt-Factory クライアントのサーバへの登録は完了です。この後、ampm コマンドで、リモートの Virt-Factory クライアント上にコマンド一発でゲスト OS をインストールしたり、ゲスト OS の起動や停止をリモートから行ったり、複数のリモートクライアント上にあるゲスト OS をすべてリストアップしたり、といった、Virt-Factory のメインの使い方に入るわけですが、この解説はまた次回に。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/01/05/VirtFactory/">Virt Factory</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2008-01-05T20:17:06+09:00" pubdate>Jan 5<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/01/05/VirtFactory/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://trac.mizzy.org/public/wiki/Cobbler">Cobbler</a> や <a href="http://trac.mizzy.org/public/wiki/Koan">Koan</a> について触れたところで、次は <a href="http://virt-factory.et.redhat.com/">Virt-Factory</a> です。</p>

<p><a href="http://blog.yappo.jp/yappo/archives/000555.html">Yappo さんが Xen 環境で Cobbler/Koan が動くことを検証してくださった</a>ので、心置きなく Virt-Factory の紹介ができます。こちらの身勝手なお願いに応じてくれた Yappo さん、ありがとうございます。</p>

<p>Virt-Factory は、大量の仮想サーバの管理を楽に行うためのツールで、Cobbler/Koan + Puppet + これらをラップするサーバ/クライアントデーモンとコマンドラインツール + Web UI + XMLRPC API、といった感じです。具体的には、以下のような感じ。</p>

<ul>
<li>Cobbler/Koan、Puppet の統合

<ul>
<li>Cobbler による PXE ブート + ネットワークインストール環境の構築。単に Cobbler を利用する場合とは違い、キックスタートファイルに、Virt-Factory に必要なパッケージのインストールや、インストール後に必要な処理の実行を含めてくれる。</li>
<li>Koan によるホスト OS や Xen/QEMU ゲスト OS のコマンド一発インストール。Koan を使う場合は、ホスト OS 上で実行する必要があるが、Virt-Factory を使うと中央のサーバからリモートで実行できる。</li>
<li>リモートのホスト OS 上にある仮想サーバの状況を、中央のサーバで一元管理できる。</li>
<li>Cobbler でのキックスタートファイル作成時に、Puppet パッケージのインストール処理を含めてくれたり、プロファイル属性として Puppet クラスを指定できたりとか。おそらく Puppet サーバのノード管理とも連携するんじゃないだろうか。（ここはまだちゃんと検証できてない。）</li>
</ul>
</li>
<li>Web UI でプロファイルやシステムの登録、管理などができる</li>
<li>Web UI やコマンドラインツールは XMLRPC API と連携してる</li>
</ul>


<p>とてもよさげなツールではあるのですが、色んなツールを統合してるだけあって、できることが多すぎてわけがわからないし、<a href="http://virt-factory.et.redhat.com/vf-install-setup.php">本家サイトのインストール/セットアップドキュメント</a>の通りにやっても動かないし、ドキュメントも不十分で、これから触ってみようと思う方は苦労するかと思いますので、インストール手順から使い方まで、自分が理解できた範囲で、今後数回にわけてご紹介していこうと思います。</p>

<p>ただしプロダクトとしてはまだ発展途上という感じで、すぐに実践投入できるものではなさそうです。</p>

<p><del>とりあえず次回は Virt-Factory サーバのインストールと設定について解説予定です。</del><a href="http://trac.mizzy.org/public/wiki/VirtFactoryServerSetup">解説をアップしました</a>。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/12/31/Koan/">Koan</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-12-31T20:33:54+09:00" pubdate>Dec 31<span>st</span>, 2007</time>
        
         | <a href="/blog/2007/12/31/Koan/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://cobbler.et.redhat.com/docs/koan.html">Koan (Kickstart over a network)</a> を使うと、Cobbler と連携して、PXE ブートを使わずに OS を再インストールしたり、Xen または QEMU のゲスト OS をコマンド一発でインストールすることができます。</p>

<p>以下、Fedora 7 で Koan を試してみたメモ。</p>

<h1>Koan のインストール</h1>

<pre><code>$ sudo yum install koan
</code></pre>

<h1>プロファイルやシステムの一覧を表示</h1>

<p>プロファイル一覧を表示する。</p>

<pre><code>$ sudo koan --server=cobbler.example.org --list-profile
fc7-i386
fc7-xen-i386 
</code></pre>

<p>システム一覧を表示する。</p>

<pre><code>$ sudo koan --server=cobbler.example.org --list-system
test-server.example.org
</code></pre>

<p>cobbler.example.org は cobbler が動いてるサーバ。koan による OS インストールを行うときには、プロファイルかシステムのどちらかを指定する。</p>

<h1>OS の再インストール</h1>

<p>OS を再インストールする時には、&#8211;replace-self オプション と &#8211;profile または &#8211;system を指定して koan を実行。</p>

<pre><code>$ sudo koan --server=cobbler.example.org --replace-self --profile=f7-i386
- using kickstart from cobbler: http://cobbler.example.org/cblr/kickstarts/f7-i386/ks.cfg
downloading initrd initrd.img to /boot/initrd.img
url=http://cobbler.example.org/cobbler/images/f7-i386/initrd.img
- using kickstart from cobbler: http://cobbler.example.org/cobbler/images/f7-i386/initrd.img
downloading kernel vmlinuz to /boot/vmlinuz
url=http://cobbler.example.org/cobbler/images/f7-i386/vmlinuz
- using kickstart from cobbler: http://cobbler.example.org/cobbler/images/f7-i386/vmlinuz
- kickstart: http://cobbler.example.org/cblr/kickstarts/f7-i386/ks.cfg
- downloading http://cobbler.example.org/cblr/kickstarts/f7-i386/ks.cfg
- using kickstart from cobbler: http://cobbler.example.org/cblr/kickstarts/f7-i386/ks.cfg
- ['/bin/bash', '/var/spool/koan/insert.sh']
cpio
14535 blocks
14538 blocks
done
- ['/sbin/grubby', '--grub', '--add-kernel', '/boot/vmlinuz', '--initrd', '/boot/initrd.img', '--make-default', '--title', 'kick1199098439', '--args', 'ksdevice=eth0 lang=  kssendmac syslog=cobbler.example.org:25150 text  ks=file:ks.cfg', '--copy-default']
- reboot to apply changes 
</code></pre>

<p>ネットワークインストール用の /boot/initrd.img とか /boot/vmlinuz とかを cobbler サーバからダウンロードして、/boot/grub/menu.lst を書き換えてくれる。</p>

<p>あとは再起動すれば、OS の再インストールが勝手にはじまる。</p>

<h1>Xen ゲスト OS のインストール</h1>

<h2>Xen のインストールと Xen カーネルの起動</h2>

<p>当然 Xen 環境が必要になるので、Xen をインストール。</p>

<pre><code>$ sudo yum install kernel-xen xen
</code></pre>

<p>インストール後、/boot/grub/menu.lst を書き換えて、デフォルトで Xen カーネルが起動するようにして再起動する。</p>

<h2>koan コマンドでの Xen ゲスト OS インストール</h2>

<p>&#8211;replace-self ではなく &#8211;virt を指定する。</p>

<pre><code>$ sudo koan --server=cobbler.example.org --virt --profile=f7-xen-i386
</code></pre>

<p>これで Xen ゲスト OS のインストールがはじまる、はずなんだけど、うちの環境では Segmentation Fault になってしまった。VMWare 上で Xen を動かすというのは無理があるのかもしれない。</p>

<p>実機で試したいところだけど、試せるサーバがないので保留。Yappo さんあたりが試してレポートしてくれるに違いない、きっと。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/12/29/CobblerWebUi/">Cobbler Web Ui</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-12-29T00:47:43+09:00" pubdate>Dec 29<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/12/29/CobblerWebUi/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://trac.mizzy.org/public/wiki/Cobbler">前回のエントリで書いた</a> Cobbler にはウェブ UI がある。その設定方法のメモ。設定方法は<a href="https://hosted.fedoraproject.org/cobbler/wiki/OldCobblerWebUi">ここ</a>を参照した。Cobbler のバージョンが 0.7 以降の場合は<a href="https://hosted.fedoraproject.org/cobbler/wiki/CobblerWebInterface">こっちを参照</a>。</p>

<p>まずは /var/lib/cobbler/settings の xmlrpc_rw_enabled を 1 に設定。</p>

<pre><code>xmlrpc_rw_enabled:  1
</code></pre>

<p>これを見て想像がつくと思うけど、cobblerd が XMLRPC リクエストを受け付けるようになる。</p>

<p>次に /etc/cobbler/auth.conf で、cobblerd の XMLRPC へのアクセスを許可するユーザ ID とパスワードを設定する。</p>

<pre><code>[xmlrpc_service_users]
admin = password
</code></pre>

<p>/etc/cobbler/auth.conf が httpd ユーザから読めるようにする。</p>

<pre><code>$ sudo chown apache /etc/cobbler/auth.conf
</code></pre>

<p>SELinux を利用している場合はこの設定も必要らしい。（自分は SELinux は disabled にしてる。）</p>

<pre><code>$ sudo chcon -t httpd_sys_content_t /etc/cobbler/auth.conf
$ sudo setsebool httpd_can_network_connect true
</code></pre>

<p>httpd で認証するユーザ名とパスワードを設定する。これは /etc/cobbler/auth.conf で設定したものと同じにする。</p>

<pre><code>$ sudo htdigest /var/www/cgi-bin/cobbler/.htpasswd "Cobbler WebUI Authentication" admin
</code></pre>

<p>あとは http://cobbler.example.org/cgi-bin/cobbler/webui.cgi にアクセスすれば OK。以下のスクリーンショットは Profile を表示させたところ。</p>

<p>[[Image(cobbler_web_ui.jpg)]]</p>

<p>この画面見てて気づいたんだけど、Cobbler では system の登録ができて、MAC アドレスを登録して Profile を指定しておけば、PXE ブート時にイメージ名を入力しなくても、勝手に指定された Profile のイメージでブートしてくれる。</p>

<p>system の登録はコマンドラインでもできる。</p>

<pre><code>$ sudo cobbler system add --name=test-server --mac=00:0C:29:7E:3A:8B --profile=f7-i386
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/12/29/Cobbler/">Cobbler</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-12-29T00:19:56+09:00" pubdate>Dec 29<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/12/29/Cobbler/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>ネットワークインストール環境がさくっと構築できる <a href="http://cobbler.et.redhat.com/">Cobbler</a> がおもしろそうなので触ってみたメモ。参考にしたサイトは以下の通り。</p>

<ul>
<li><a href="http://www.cafechantant.com/blog/2007/08/09/%e3%82%b5%e3%83%bc%e3%83%90%e3%81%ae%e6%a7%8b%e7%af%89%e3%82%92%e7%b0%a1%e5%8d%98%e3%81%ab%e3%81%99%e3%82%8b%e3%81%9f%e3%82%81%e3%81%ae%e3%82%b9%e3%83%86%e3%83%83%e3%83%97-%ef%bc%88%e3%81%9d%e3%81%ae5/">サーバの構築を簡単にするためのステップ （その5：Cobber編 Part1 ）</a></li>
<li><a href="http://www.cafechantant.com/blog/2007/09/05/%e3%82%b5%e3%83%bc%e3%83%90%e3%81%ae%e6%a7%8b%e7%af%89%e3%82%92%e7%b0%a1%e5%8d%98%e3%81%ab%e3%81%99%e3%82%8b%e3%81%9f%e3%82%81%e3%81%ae%e3%82%b9%e3%83%86%e3%83%83%e3%83%97-%ef%bc%88%e3%81%9d%e3%81%ae6/">サーバの構築を簡単にするためのステップ （その6：Cobber編 Part2 ）</a></li>
<li><a href="http://www.asahi-net.or.jp/~aa4t-nngk/pxeinstall.html">PXEネットワークインストール(Cobbler)</a></li>
<li><a href="http://www.cafechantant.com/trac/wiki/cobbler_top">cobbler_top - Cafe Chantant Info Repositry - Trac</a></li>
</ul>


<p>以下、Fedora 7 で Cobbler を動かしてみたメモ。</p>

<h1>インストール</h1>

<p>yum で一発インストール。</p>

<pre><code>$ sudo yum install cobbler
</code></pre>

<h1>設定</h1>

<p>cobbler check コマンドを実行すると、見直すべき設定ポイントを教えてくれる。親切。</p>

<pre><code>$ sudo cobbler check
The following potential problems were detected:
#0: The 'server' field in /var/lib/cobbler/settings must be set to something other than localhost, or kickstarting features will not work.  This should be a resolvable hostname or IP for the boot server as reachable by all machines that will use it.
#1: For PXE to be functional, the 'next_server' field in /var/lib/cobbler/settings must be set to something other than 127.0.0.1, and should match the IP of the boot server on the PXE network.
#2: service cobblerd is not running
#3: syslinux should be installed but is not, expecting to find something at /usr/lib/syslinux/pxelinux.0
#4: service xinetd is not running
#5: change 'disable' to 'no' in /etc/xinetd.d/tftp
#6: service httpd is not running
#7: since iptables may be running, ensure 69, 80, 25150, and 25151 are unblocked#8: reposync is not installed, need for cobbler reposync, install/upgrade yum-utils?
#9: yumdownloader is not installed, needed for cobbler repo add with --rpm-list
parameter, install/upgrade yum-utils? 
</code></pre>

<p>これを元に設定変更を行っていく。まずは /var/lib/cobbler/settings を以下のように修正。</p>

<pre><code>manage_dhcp: 1
next_server: '192.168.10.12'
server: 192.168.10.12
</code></pre>

<p>192.168.10.12 は Cobbler が動いているマシンの IP アドレス。</p>

<p>cobblerd を起動。</p>

<pre><code>$ sudo /sbin/chkconfig cobblerd on 
$ sudo /etc/init.d/cobblerd start 
</code></pre>

<p>syslinux をインストール。</p>

<pre><code>$ sudo yum install syslinux
</code></pre>

<p>tftpd と xinetd を起動。</p>

<pre><code>$ sudo /sbin/chkconfig tftp on
$ sudo /sbin/chkconfig xinetd on 
$ sudo /etc/init.d/xinetd start 
</code></pre>

<p>httpd を起動。</p>

<pre><code>$ sudo /sbin/chkconfig httpd on
$ sudo /etc/init.d/httpd start 
</code></pre>

<p>iptables はとりあえずオフにしとく。</p>

<pre><code>$ sudo /sbin/chkconfig iptables off
$ sudo /etc/init.d/iptables stop 
</code></pre>

<p>yum-utils のインストール。</p>

<pre><code>$ sudo yum install yum-utils
</code></pre>

<p>/etc/cobbler/dhcp.template を以下のような感じで修正。</p>

<pre><code># ******************************************************************
# Cobbler managed dhcpd.conf file
#
# generated from cobbler dhcp.conf template ($date)
#
# ******************************************************************

ddns-update-style interim;

allow booting;
allow bootp;

ignore client-updates;
set vendorclass = option vendor-class-identifier;

subnet 192.168.10.0 netmask 255.255.255.0 {
     option routers          192.168.10.1;
     option subnet-mask      255.255.255.0;
     range dynamic-bootp     192.168.10.100 192.168.10.254;
     filename                "/pxelinux.0";
     default-lease-time      21600;
     max-lease-time          43200;
     next-server             $next_server;
}

$insert_cobbler_system_definitions
</code></pre>

<p>dhcp をインストールしておく。dhcpd はこの段階では起動しなくていい。（起動してもエラーになる。）</p>

<pre><code>$ sudo yum install dhcp
$ sudo /sbin/chkconfig dhcpd on
</code></pre>

<h1>ネットワークインストールに必要なファイルの用意</h1>

<p>インストールイメージとか、キックスタートファイルとかを作成。</p>

<pre><code>$ sudo cobbler import --path=rsync://ftp.jaist.ac.jp/pub/Linux/Fedora/releases/7/Fedora/i386/os --name=f7
</code></pre>

<p>このコマンド一発で必要なものを全部つくってくれる。超簡単。時間はかかるけど。</p>

<p>cobbler report を実行すると、どこにどんなファイルがあるかとかを表示してくれる。</p>

<pre><code>$ sudo cobbler report
distro          : f7-i386
kernel          : /var/www/cobbler/ks_mirror/f7/images/pxeboot/vmlinuz
initrd          : /var/www/cobbler/ks_mirror/f7/images/pxeboot/initrd.img
kernel options  : {}
architecture    : x86
ks metadata     : {'tree': 'http://@@server@@/cblr/links/f7-i386'}
breed           : redhat

distro          : f7-xen-i386
kernel          : /var/www/cobbler/ks_mirror/f7/images/xen/vmlinuz
initrd          : /var/www/cobbler/ks_mirror/f7/images/xen/initrd.img
kernel options  : {}
architecture    : x86
ks metadata     : {'tree': 'http://@@server@@/cblr/links/f7-xen-i386'}
breed           : redhat

profile         : f7-i386
distro          : f7-i386
kickstart       : /etc/cobbler/kickstart_fc6.ks
kernel options  : {}
ks metadata     : {}
virt file size  : 5
virt ram        : 512
virt type       : auto
virt path       :
virt bridge     : xenbr0
virt cpus       : 1
repos           : []
dhcp tag        : default
server          : &lt;&lt;inherit&gt;&gt;

profile         : f7-xen-i386
distro          : f7-xen-i386
kickstart       : /etc/cobbler/kickstart_fc6.ks
kernel options  : {}
ks metadata     : {}
virt file size  : 5
virt ram        : 512
virt type       : auto
virt path       :
virt bridge     : xenbr0
virt cpus       : 1
repos           : []
dhcp tag        : default
server          : &lt;&lt;inherit&gt;&gt;
</code></pre>

<p>これを見て分かるとおり、Xen 用のイメージなんかも勝手に作ってくれる。</p>

<p>あとは必要に応じてキックスタートファイル（/etc/cobbler/kickstart_fc6.ks）なんかをいじる。何かファイルを修正したりしたら、cobbler sync を忘れずに実行。</p>

<pre><code>$ sudo cobbler sync
</code></pre>

<h1>ネットワークインストールを実行する</h1>

<p>ここまできたら、別のマシンを PXE ブートで起動して、boot プロンプトで cobbler import で作成したイメージの名前を入力。</p>

<pre><code>boot: f7-i386
</code></pre>

<p>あとは勝手にインストールが始まる。</p>

<p>以下のように system 登録しておくと、PXE ブート時にイメージ名を入力しなくても、勝手に割り当てられたイメージでブートしてくれる。</p>

<pre><code>$ sudo cobbler system add --name=test-server --mac=00:0C:29:7E:3A:8B --profile=f7-i386
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/12/08/FuncIntro/">Func Intro</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-12-08T01:58:14+09:00" pubdate>Dec 8<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/12/08/FuncIntro/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://opentechpress.jp/developer/07/12/06/0046247.shtml">Open Tech Press</a> で知った、<a href="https://hosted.fedoraproject.org/projects/func/">Func</a> がおもしろそうだ。</p>

<p>とりあえずどんなツールかを要約すると、</p>

<ul>
<li>複数のサーバに対して、何らかの処理を一括でまとめて実行して結果が取得できる。たとえば、yum でパッケージをインストールとか。</li>
<li>「何らかの処理」の部分は、モジュールで拡張できる。</li>
<li>「何らかの処理」はコマンドラインから実行して単に結果を表示、ということもできるし、Python API でプログラマブルに処理することもできる。</li>
<li>クライアント/サーバアーキテクチャ</li>
</ul>


<p>これだけだと何となくわかるようでわからない。触ってみるのが一番。というわけでまずはインストール。</p>

<h1>インストール</h1>

<p><a href="https://hosted.fedoraproject.org/projects/func/wiki/InstallAndSetupGuide">InstallAndSetupGuide</a> を読むと、（おそらく最近の）Fedora であれば yum 一発でインストールできるみたいだけど、手元にある CentOS 5 用のパッケージがなさそうなので、ソース RPM からパッケージをつくる。（noarch なので FC7 用でもそのまま入りそうだけど、せっかくだからつくってみる。）</p>

<p>まずは <a href="https://hosted.fedoraproject.org/projects/func/wiki/FuncReleases">FuncReleases</a> から func-0.13-3.fc7.src.rpm をゲット。</p>

<p>次にソース RPM からリビルドするために必要なパッケージをインストール。</p>

<pre><code>$ sudo yum -y install rpm-build python-devel python-setuptools 
</code></pre>

<p>リビルドしてインストール。依存パッケージの PyOpenSSL も忘れずに。</p>

<pre><code>$ sudo rpmbuild --rebuild func-0.13-3.fc7.src.rpm
$ sudo yum -y install pyOpenSSL
$ sudo rpm -ivh /usr/src/redhat/RPMS/noarch/func-0.13-3.noarch.rpm
</code></pre>

<p>サーバを起動する。サーバは master と呼ばれるみたい。</p>

<pre><code>$ sudo /etc/init.d/certmaster start
</code></pre>

<p>次にクライアント側。クライアントは minion と呼ばれているようだ。インストール手順は master と同じなので省略。</p>

<p>クライアント側では設定ファイル /etc/func/minion.conf を修正する必要がある。といっても、certmaster で master を指定してあげるだけでとりあえず OK。</p>

<pre><code># configuration for minions

[main]
log_level = DEBUG
certmaster = server.example.org
cert_dir = /etc/pki/func
acl_dir = /etc/func/minion-acl.d 
</code></pre>

<p>クライアント側で常駐するデーモン funcd を起動。</p>

<pre><code>$ sudo /etc/init.d/funcd start   
</code></pre>

<p>master と minion の通信は SSL 証明書での認証が必要なので、master 側で証明書リクエストに対して署名を行う。（この辺りはPuppetと一緒だ。）</p>

<pre><code>$ sudo certmaster-ca --list
client.example.org
$ sudo certmaster-ca --sign client.example.org
</code></pre>

<p>これで使うための準備はできた。</p>

<h1>コマンド実行</h1>

<p>master 上で func コマンドを実行する。まずは minion の一覧を表示。</p>

<pre><code>$ sudo func "*" list_minions
['https://client0.example.org:51234', 'https://client1.example.org:51234']
client0.example.org
client1.example.org
0
</code></pre>

<p>www ではじまる minion だけを表示。</p>

<pre><code>$ sudo func "www*" list_minions
['https://www0.example.org:51234', 'https://www1.example.org:51234']
www0.example.org
www1.example.org
0
</code></pre>

<p>各 minion で利用できるモジュールの一覧を表示。</p>

<pre><code>$ sudo func "*" call system list_modules
on https://client0.example.org:51234 running system list_modules ()
['command', 'copyfile', 'func_module', 'hardware', 'nagios-check', 'process', 'reboot', 'rpms', 'service', 'smart', 'snmp', 'test', 'yum']
on https://client1.example.org:51234 running system list_modules ()
['command', 'copyfile', 'func_module', 'hardware', 'nagios-check', 'process', 'reboot', 'rpms', 'service', 'smart', 'snmp', 'test', 'yum']
{'client0.example.org': ['command',
                        'copyfile',
                        'func_module',
                        'hardware',
                        'nagios-check',
                        'process',
                        'reboot',
                        'rpms',
                        'service',
                        'smart',
                        'snmp',
                        'test',
                        'yum'],
 'client1.example.org': ['command',
                        'copyfile',
                        'func_module',
                        'hardware',
                        'nagios-check',
                        'process',
                        'reboot',
                        'rpms',
                        'service',
                        'smart',
                        'snmp',
                        'test',
                        'yum']}   
</code></pre>

<p>service モジュールで使えるメソッド一覧を表示。</p>

<pre><code>$ sudo func "client0.example.org" call service list_methods
on https://client0.example.org:51234 running service list_methods ()
['status', 'reload', 'get_running', 'stop', 'start', 'inventory', 'get_enabled', 'restart', 'module_description', 'module_version', 'module_api_version', 'list_methods']
{'client0.example.org': ['status',
                        'reload',
                        'get_running',
                        'stop',
                        'start',
                        'inventory',
                        'get_enabled',
                        'restart',
                        'module_description',
                        'module_version',
                        'module_api_version',
                        'list_methods']} 
</code></pre>

<p>service モジュールの status メソッドで ntpd の起動状態を確認。以下はすべての minion で ntpd が停止してる状態での実行結果。</p>

<pre><code>$ sudo func "*" call service status ntpd
on https://client0.example.org:51234 running service status (ntpd)
3
on https://client1.example.org:51234 running service status (ntpd)
3
{'client1.example.org': 3, 'client0.example.org': 3}
</code></pre>

<p>ntpd を起動。</p>

<pre><code>$ sudo func "*" call service start ntpd
on https://client0.example.org:51234 running service start (ntpd)
0
on https://client1.example.org:51234 running service start (ntpd)
0
{'client1.example.org': 0, 'client0.example.org': 0}   
</code></pre>

<p>ntpd の起動状態を確認。</p>

<pre><code>$ sudo func "*" call service status ntpd
on https://client0.example.org:51234 running service status (ntpd)
0
on https://client1.example.org:51234 running service status (ntpd)
0
{'client1.example.org': 0, 'client0.example.org': 0}   
</code></pre>

<p>*.example.org のみをターゲットにする。</p>

<pre><code>$ sudo func "*.example.org" call service status ntpd
on https://client0.example.org:51234 running service status (ntpd)
0
on https://client1.example.org:51234 running service status (ntpd)
0
{'client1.example.org': 0, 'client0.example.org': 0}   
</code></pre>

<p>client0.example.org と client1.example.org のみをターゲットにする。</p>

<pre><code>$ sudo func "client0.example.org; client1.example.org" call service status ntpd
on https://client0.example.org:51234 running service status (ntpd)
0
on https://client1.example.org:51234 running service status (ntpd)
0
{'client1.example.org': 0, 'client0.example.org': 0}   
</code></pre>

<p>ここまで実行してみれば、何となく感じは掴めると思う。</p>

<h1>モジュール</h1>

<p>デフォルトで付属しているモジュールには以下のものがある。</p>

<ul>
<li>command</li>
<li>copyfile</li>
<li>func_module</li>
<li>hardware</li>
<li>nagios-check</li>
<li>process</li>
<li>reboot</li>
<li>rpms</li>
<li>service</li>
<li>smart</li>
<li>snmp</li>
<li>test</li>
<li>yum</li>
</ul>


<p><a href="https://hosted.fedoraproject.org/projects/func/#ListofStockModules">使い方はこの辺参照。</a></p>

<p>とりあえず</p>

<pre><code>$ sudo func client0.example.org system list_modules
</code></pre>

<p>で利用できるモジュールを調べて、</p>

<pre><code>$sudo func client0.example.org call module list_methods
</code></pre>

<p>でモジュールで使えるメソッド一覧を表示してみると、どんなモジュールがあるか、そのモジュールはどんなことができるのか、がおおよそわかるはず。</p>

<h1>モジュールの書き方</h1>

<p><a href="https://hosted.fedoraproject.org/projects/func/wiki/HowToWriteAndDistributeNewModules">ここに書かれてる。</a>これで自分が好きなように機能拡張ができる。</p>

<h1>Python プログラムから呼び出し</h1>

<p><a href="https://hosted.fedoraproject.org/projects/func/wiki/PythonApiExamples">ここにサンプルがある。</a></p>

<p>今後は [wiki:Func こちらの Wiki ページ] に情報まとめていく予定。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/12/08/Func/">Func</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-12-08T01:22:24+09:00" pubdate>Dec 8<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/12/08/Func/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://hosted.fedoraproject.org/projects/func/">Func</a> に関するまとめ Wiki。内容はまだなし。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/12/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/10/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/03/07/image-with-exif-tag-plugin/">Image with EXIF tag plugin</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/07/exif-tag-plugin/">EXIF tag plugin</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/04/rakuten-tag-plugin/">Rakuten tag plugin for Jekyll</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/29/paperboys-engineer-evaluation-system/">Paperboy&#8217;s engineer evaluation system</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/17/paperboy-is-hiring/">paperboy is hiring</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Coderwall</h1>
  <p>
  <script type="text/javascript">
    function display_coderwall(args) {
        var badges = args["data"]["badges"];
        for ( var i = 0; i < badges.length; i++ ) {
            document.write('<img src="'+ badges[i]["badge"] + '" width="48" height="48" />');
        }
    }
  </script>
  <script src="http://coderwall.com/mizzy.json?callback=display_coderwall"></script>
  </p>
  <p style="text-align: right;"><a href="http://coderwall.com/mizzy">Powered by coderwall.com</a></p>
</section>


<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/mizzy">@mizzy</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'mizzy',
            count: 30,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>




  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Gosuke Miyashita -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mizzyorg';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
