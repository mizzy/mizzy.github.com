
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Gosuke Miyashita</title>
  <meta name="author" content="Gosuke Miyashita">

  
  <meta name="description" content="今年も PacSec の季節がやってきました。昨年は二つほどスライドの翻訳をさせて頂いたのですが、残念ながら当日は体調不良で参加できませんでした… 今年も昨年同様、スライド翻訳をお手伝いさせて頂くのですが、一緒にお手伝いしてくださる方を募集しています。興味のある方は、gosukenator at &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mizzy.org/blog/page/7">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Gosuke Miyashita" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-53984-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Gosuke Miyashita</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mizzy.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/10/06/PacSec2009/">PacSec2009</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-10-06T23:16:52+09:00" pubdate>Oct 6<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/10/06/PacSec2009/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>今年も <a href="http://pacsec.jp/">PacSec</a> の季節がやってきました。昨年は二つほどスライドの翻訳をさせて頂いたのですが、残念ながら当日は体調不良で参加できませんでした…</p>

<p>今年も昨年同様、スライド翻訳をお手伝いさせて頂くのですが、一緒にお手伝いしてくださる方を募集しています。興味のある方は、gosukenator at gmail.com までご連絡ください。（無料でカンファレンスに参加できる上に、豪華なお弁当つきです。懇親会も無料で参加できる、はず。）</p>

<p>翻訳に対する考え方なんかは、<a href="http://trombik.mine.nu/~cherry/w/index.php/2008/11/16/1471/pacsec-and-translation">I, newbie の trombik さんのブログをご参照ください</a> 。</p>

<p>また、今年の PacSec の概要や、過去どんな感じだったのかなど、興味がある方は以下のリンクをご参照ください。</p>

<ul>
<li>http://pacsec.jp/speakers.html</li>
<li>http://twitter.com/Pacsecjp</li>
<li>http://gihyo.jp/admin/serial/01/sysadmin-toolbox/0004</li>
<li>http://trac.mizzy.org/public/wiki/PacSec2007</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/10/06/ScalaDesignPatterns/">ScalaDesignPatterns</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-10-06T00:10:45+09:00" pubdate>Oct 6<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/10/06/ScalaDesignPatterns/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.amazon.co.jp/dp/4844327453">Scalaスケーラブルプログラミング</a> をコードを書き写しながらざーっと読んだんだけど、全然身になってない気がするので、結城先生の <a href="http://www.amazon.co.jp/dp/4797327030/">Java言語で学ぶデザインパターン入門</a> のサンプルコードを <a href="http://github.com/mizzy/scala-design-patterns">Scala で実装して github にアップ</a> してみることにした。</p>

<p>とりあえず飽きるまでやります。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/09/15/CanBadge/">CanBadge</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-09-15T00:05:20+09:00" pubdate>Sep 15<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/09/15/CanBadge/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>5歳になる娘の幼稚園帽子。</p>

<p>[[Image(http://trac.mizzy.org/public/attachment/wiki/CanBadge/canbadge.jpg?format=raw)]]</p>

<p>ちなみに小3の長男はPerl Best Practicesの布製バッグを体育用具入れとして使ってる。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/09/11/YapcAsia2009TokyoPresentation/">YapcAsia2009TokyoPresentation</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-09-11T00:21:28+09:00" pubdate>Sep 11<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/09/11/YapcAsia2009TokyoPresentation/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>ひとつ目は <a href="http://conferences.yapcasia.org/ya2009/talk/2166">ペパボでの Perl のつかいかた</a> 。<a href="http://d.hatena.ne.jp/hiboma/">id:hiboma</a> と一緒にプレゼンしました。<a href="http://d.hatena.ne.jp/naoya/">お兄さん</a>、ネタに使わせてもらってすみません＆ありがとうございました。後半のロリポの話は、二人で休日も返上してがっつり取り組んだプロジェクトだったので、ぜひ二人で発表したい、と思い、一緒にやらせてもらいました。資料の最新版は id:hiboma が持ってるので、そのうちアップしてくれると思います。</p>

<p>ふたつ目は <a href="http://conferences.yapcasia.org/ya2009/talk/2220">Danga::Socketの非同期処理の仕組みとPerlbalで非同期処理するプラグインを書く方法</a> 。<a href="http://www.slideshare.net/mizzy/how-dangasocket-handles-asynchronous-processing-and-how-to-write-asynchronous-perlbal-plugins">英語版資料</a> と <a href="http://www.slideshare.net/mizzy/dangasocketperlbal">日本語版資料</a> を slideshare にアップしています。</p>

<p>また、プラグインのコードは、プレゼン中は概要しか紹介できなかったので、実際に動くサンプルを <a href="http://github.com/mizzy/perlbal-async-plugin-example/tree/master">github にアップ</a>しています。Perlbal::ClientProxy のパッチと設定ファイルも合わせて置いてあります。</p>

<p>ただ、プレゼンした手法は、以下の点でとても実用的とは言えません。</p>

<ul>
<li>本体に手を入れなければいけない</li>
<li>特定の hook にしか対応してない</li>
<li>同じフックで複数の非同期処理プラグインを動かすことができない</li>
</ul>


<p>本体に手を入れるのはしかたないとして、特定のフックに依存せずに、同じフックで複数の非同期処理プラグインを動かせるようするにはどうすればいいのか、今のところノーアイデアです。これがすっきりできるように実装できれば、ぜひパッチを送りたいところなのですが、今のところ必要に駆られてないので、たぶんやらないと思います。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/09/02/DeveloperRecruitAtPaperboy/">DeveloperRecruitAtPaperboy</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-09-02T02:16:46+09:00" pubdate>Sep 2<span>nd</span>, 2009</time>
        
         | <a href="/blog/2009/09/02/DeveloperRecruitAtPaperboy/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>ペパボでは以下の2つのサービスで開発者を募集中です。</p>

<ul>
<li><a href="http://www.paperboy.co.jp/recruit/job/090821.php">Color Me Shop!pro</a></li>
<li><a href="http://www.paperboy.co.jp/recruit/job/090806.php">30days Album</a></li>
</ul>


<p>併せて<a href="http://www.paperboy.co.jp/recruit/job/090821b.php">開発アルバイト</a>も募集中です。</p>

<p>詳しくは募集要項をご確認ください。</p>

<p>募集要項にはありませんが、採用された方にはドクターペッパーチェリーを差し上げます。合い言葉は「ドクターペッパーチェリー飲みたい！」です。僕との面接時に必ず声に出して言ってください。</p>

<p>[[Image(http://gyazo.com/37db61b8bd76e406987622d9863fbe5f.png)]]</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/08/13/YapcAsia2009/">YapcAsia2009</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-08-13T01:18:44+09:00" pubdate>Aug 13<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/08/13/YapcAsia2009/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>このところ、ほとんどエントリ更新してませんが、それは、<a href="http://japan.cnet.com/extra/paperboy_0907/story/0,3800098768,20394957,00.htm">ナウでヤングなレンタルサーバー ロリポップ！のインフラ再構築</a> で多忙だったからです。（それだけではないですが。）</p>

<p>というわけで、ブログエントリをほとんど書いてないので細切れにもなりようがないのですが、ロリポ含めて、ペパボが提供するサービスの中で、Perl がどのように使われているのかという話を <a href="http://d.hatena.ne.jp/hiboma/">id:hiboma</a> と一緒に YAPC::Asia 2009 でさせていただくことにしました。</p>

<p>また、それとは別に、以前からの関心事であった、Perlbal で非同期処理するプラグインを書く方法についても、ベースとなる Danga::Socket の説明も含めて、お話したいと思います。</p>

<p>YAPC::Asia 2009 は9月10日(木)と11日(金)の2日間、東京工業大学大岡山キャンパスで開催されます。すでにチケット販売も始まったので、興味のある方はお越しいただければ、と思います。</p>

<ul>
<li><a href="http://conferences.yapcasia.org/ya2009/">YAPC::Asia 2009</a></li>
<li><a href="http://conferences.yapcasia.org/ya2009/talk/2166">ペパボでの Perl のつかいかた</a></li>
<li><a href="http://conferences.yapcasia.org/ya2009/talk/2220">Perlbalで非同期処理するプラグインを書く方法</a></li>
</ul>


<p>【参考文献】</p>

<ul>
<li>http://d.hatena.ne.jp/hirose31/20090807/1249611130</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/08/06/InotifyAndMakuosan/">InotifyAndMakuosan</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-08-06T08:05:40+09:00" pubdate>Aug 6<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/08/06/InotifyAndMakuosan/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>ファイルのミラーリングツールとしては rsync が最も使われていると思いますが、差分チェックの負荷が大きく、できればつかうのやめたいなー、と思っていたところ、<a href="http://gihyo.jp/magazine/SD/archive/2009/200908">Software Design 2009年8月号</a> に <a href="http://code.google.com/p/lsyncd/">lsyncd</a> というツールが載っていて、お、これはと思って見てみたのですが、仕組みとしては inotify + rsync なので、結局は rsync を裏で呼び出していて、差分チェックの呪縛からは逃れられません。</p>

<p>inotify でファイルの更新イベント受け取ってるんだから、さらに rsync で差分チェックする必要はないじゃん、と思うわけですが、なんらかの理由でイベントが受け取れない可能性もあるため、二重チェックした方が安全なんでしょうね。</p>

<p>でもやっぱり余分な負荷はかけたくない、ってことで思いついたのが、inotify で更新イベントを検知したファイルを、<a href="http://lab.klab.org/wiki/Makuosan">makuosan</a> の msync コマンドに渡してミラーリングする方法。（makusan の詳しい解説は、<a href="http://gihyo.jp/magazine/wdpress/archive/2009/vol51">WEB+DB PRESS Vol.51</a> に載ってます。）</p>

<p>そこで以下のようなコードを書いて動かしてみたところ、いい感じでファイルが同期できることを確認しました。</p>

<pre><code>#!perl
#!/usr/bin/perl

use strict;
use warnings;
use File::ChangeNotify;

my $base = '/home/miya/work';
my $watcher = File::ChangeNotify-&gt;instantiate_watcher(
    directories =&gt; [ $base ],
);

while ( my @events = $watcher-&gt;wait_for_events() ) {
    for my $event ( @events ) {
        my $path = $event-&gt;path;
        $path =~ s!$base/!!;
        `msync --sync $path`;
    }
}

exit;
</code></pre>

<p>とは言っても、実運用で使うためには、イベントをとりこぼさない、またはとりこぼしてもリカバーするような仕組みを考えたり、負荷テストをしてみたりとか、色々と考慮しなければいけないことはありますが、それはまあおいおいってことで。</p>

<p>また、<a href="http://search.cpan.org/~drolsky/File-ChangeNotify/">File::ChangeNotify</a> がすべての inotify イベントに対応してるわけではなく、IN_CREATE, IN_MODIFY, IN_DELETE にしか対応してないため、パーミッション変更とかファイルの移動なんかは検知できない、という問題もあります。（パッチ書けばいけそうなので、書いてみるつもりです。）</p>

<p>File::ChangeNotify 自体は inotify だけじゃなく、他の仕組みにも対応できるようになっていて、inotify が使える Linux kernel 2.6.13 以降であれば File::ChangeNotify::Watcher::Inotify が、それ以外であれば File::ChangeNotify::Watcher::Default が自動的に呼ばれるようになってます。なので、Mac OS X の FSEvents に対応した File::ChangeNotify::Watcher::FSEvents とか書けば、Mac では自動的に FSEvents で更新イベントを検知、ってこともできそうです。</p>

<p>ともかく、rsync の負荷には困っているので、今後この辺の方法論は詰めていきたいな、と思っています。</p>

<p><em>追記</em></p>

<p><a href="http://github.com/miyagawa/File-ChangeNotify-Watcher-MacFSEvents/tree">miyagawa さんによる File::ChangeNotify::Watcher::MacFSEvents が github にありました</a>。ただし、FSEventsではファイル名とかイベントの種類はとれないそうです。Wikipedia 見てもそんな感じのことが書いてますね。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/07/21/library-perl-trunk-Net-Amazon-ECS-lib-Net-Amazon-ECS.pm/">library/perl/trunk/Net-Amazon-ECS/lib/Net/Amazon/ECS.pm</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-07-21T00:58:15+09:00" pubdate>Jul 21<span>st</span>, 2009</time>
        
         | <a href="/blog/2009/07/21/library-perl-trunk-Net-Amazon-ECS-lib-Net-Amazon-ECS.pm/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>source:library/perl/trunk/Net-Amazon-ECS/lib/Net/Amazon/ECS.pm</p>

<h1>NAME</h1>

<p>Net::Amazon::ECS - [One line description of module&#8217;s purpose here]</p>

<h1>VERSION</h1>

<p>This document describes Net::Amazon::ECS version 0.0.1</p>

<h1>SYNOPSIS</h1>

<pre><code>    use Net::Amazon::ECS;

    my $ua =  Net::Amazon::ECS-&gt;new(
        access_key_id =&gt; 'YOUR_AWS_ACCESS_KEY_ID',
        associate_tag =&gt; 'YOUR_AFFILIATE_ID',
        locale        =&gt; 'jp',
    );

    my $req = Net::Amazon::Request::Keyword-&gt;new(
        keywords     =&gt; 'SEARCH KEYWORDS',
        search_index =&gt; 'books',
        sort         =&gt; 'daterank',
    );

    my $res = $ua-&gt;request($req);

    croak $res-&gt;message if $res-&gt;is_error;

    my @items = $res-&gt;items;
</code></pre>

<h1>DESCRIPTION</h1>

<h1>INTERFACE</h1>

<h1>DIAGNOSTICS</h1>

<p> <code>Error message here, perhaps with %s placeholders</code>:: [Description of error here]
 <code>Another error message here</code>:: [Description of error here]
[Et cetera, et cetera]</p>

<h1>CONFIGURATION AND ENVIRONMENT</h1>

<p>Net::Amazon::ECS requires no configuration files or environment variables.</p>

<h1>DEPENDENCIES</h1>

<p>None.</p>

<h1>INCOMPATIBILITIES</h1>

<p>None reported.</p>

<h1>BUGS AND LIMITATIONS</h1>

<p>No bugs have been reported.</p>

<p>Please report any bugs or feature requests to <code>bug-net-amazon-ecs@rt.cpan.org</code>, or through the web interface at http://rt.cpan.org.</p>

<h1>AUTHOR</h1>

<p>Gosuke Miyashita <code>&lt;gosukenator@gmail.com&gt;</code></p>

<h1>LICENCE AND COPYRIGHT</h1>

<p>Copyright (c) 2006, Gosuke Miyashita <code>&lt;gosukenator@gmail.com&gt;</code>. All rights reserved.</p>

<p>This module is free software; you can redistribute it and/or modify it under the same terms as Perl itself. See perlartistic.</p>

<h1>DISCLAIMER OF WARRANTY</h1>

<p>BECAUSE THIS SOFTWARE IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY FOR THE SOFTWARE, TO THE EXTENT PERMITTED BY APPLICABLE LAW. EXCEPT WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES PROVIDE THE SOFTWARE &#8220;AS IS&#8221; WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE. THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THE SOFTWARE IS WITH YOU. SHOULD THE SOFTWARE PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING, REPAIR, OR CORRECTION.</p>

<p>IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR REDISTRIBUTE THE SOFTWARE AS PERMITTED BY THE ABOVE LICENCE, BE LIABLE TO YOU FOR DAMAGES, INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES ARISING OUT OF THE USE OR INABILITY TO USE THE SOFTWARE (INCLUDING BUT NOT LIMITED TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY YOU OR THIRD PARTIES OR A FAILURE OF THE SOFTWARE TO OPERATE WITH ANY OTHER SOFTWARE), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGES.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/05/10/AddModRewriteInternalFunction/">AddModRewriteInternalFunction</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-05-10T13:58:43+09:00" pubdate>May 10<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/05/10/AddModRewriteInternalFunction/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Apache モジュール界のスイスアーミーナイフこと mod_rewrite の中でも、最も何でもありな rewrite ができるのが、<a href="http://httpd.apache.org/docs/2.2/ja/mod/mod_rewrite.html#rewritemap">RewriteMap</a> での prg タイプによる外部プログラム実行ですが、こいつは外部プログラムがひとつだけ常駐し、httpd と標準入出力を介してやりとりする、という形なので、並列処理させることができません。これは rewrite 処理するときにデータベースへ問い合わせるなど、I/O ブロッキングが発生するような処理をさせたいときには致命的なパフォーマンス劣化を引き起こすことになります。</p>

<p>これを解決するためには、Apache モジュールの中で望みの rewrite 処理をさせるようにすればいいのでは、と思い、RewriteMap にある int タイプに好きな internal function を追加できればいけるんじゃないないか、と考えたものの、<a href="http://httpd.apache.org/docs/2.2/ja/mod/mod_rewrite.html">mod_rewrite のリファレンス</a> では、「you cannot create your own」とか書かれていて、追加できないっぽい。かと言って mod_rewrite.c に手を入れるのもやだなー、と思っていたところ、<a href="http://code.google.com/p/modicpquery/wiki/Internals">mod_icpquery のドキュメント</a> を見つけた。これを見ると、好きな internal function を独立したモジュールの形で追加できそう、ってことでやってみたらできた。</p>

<p>以下が internal function を追加するためのモジュールテンプレ。rewrite_mapfunc_custom の中で、望みの処理を記述してあげるだけで OK。</p>

<pre><code>#!c
#include "httpd.h"
#include "http_config.h"
#include "apr_optional.h"

/* rewrite map function prototype from mod_rewrite.h */
typedef char *(rewrite_mapfunc_t)(request_rec *r, char *key);

/* optional function declaration from mod_rewrite.h */
APR_DECLARE_OPTIONAL_FN(void, ap_register_rewrite_mapfunc,
                        (char *name, rewrite_mapfunc_t *func));

static char *rewrite_mapfunc_custom(request_rec *req, char *key)
{
    /* key を元にごにょごにょして value を生成 */
    return value;
}

/* from mod_rewrite.c */
static int pre_config(apr_pool_t *pconf,
                      apr_pool_t *plog,
                      apr_pool_t *ptemp)
{
    APR_OPTIONAL_FN_TYPE(ap_register_rewrite_mapfunc) *map_pfn_register;

    /* register int: rewritemap handlers */
    map_pfn_register = APR_RETRIEVE_OPTIONAL_FN(ap_register_rewrite_mapfunc);
    if (map_pfn_register) {
        map_pfn_register("custom", rewrite_mapfunc_custom);
    }
    return OK;
}

static void register_hooks(apr_pool_t *p)
{
    ap_hook_pre_config(pre_config, NULL, NULL, APR_HOOK_MIDDLE);
}

module AP_MODULE_DECLARE_DATA rewrite_mapfunc_custom_module = {
    STANDARD20_MODULE_STUFF,
    NULL,                  /* create per-dir    config structures */
    NULL,                  /* merge  per-dir    config structures */
    NULL,                  /* create per-server config structures */
    NULL,                  /* merge  per-server config structures */
    NULL,                  /* table of config file commands       */
    register_hooks         /* register hooks                      */
};
</code></pre>

<p>追加した internal function を呼び出すための httpd.conf は以下のような感じ。</p>

<pre><code>LoadModule rewrite_mapfunc_custom_module modules/mod_rewrite_mapfunc_custom.so

RewriteEngine On
ProxyPreserveHost On
RewriteMap custom int:custom
RewriteRule ^/(.*)$ http://${custom:%{HTTP_HOST}}/$1 [P,QSA]
</code></pre>

<p>この例では、Host ヘッダの内容を custom function に渡して、ホスト名を変換して proxy するけど、Host ヘッダはオリジナルのままで変換しない、といった処理を想定してます。</p>

<p>例の件はこんな感じで実現できそうだよ。＞<a href="http://d.hatena.ne.jp/hiboma/">id:hiboma</a></p>

<p>*2009/05/10 13:57:00 追記 *</p>

<p>github に Makefile 等も含めてコードアップしました。</p>

<p>http://github.com/mizzy/mod_rewrite_mapfunc_custom/tree/master</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/05/05/ChefFirstImpression/">ChefFirstImpression</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-05-05T14:45:58+09:00" pubdate>May 5<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/05/05/ChefFirstImpression/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Puppet 作者 <a href="http://madstop.com/2009/01/16/opscode-announces-chef-a-puppet-competitor/">Luke Kanies 氏のブログエントリ</a> にて、Puppet の競合となる <a href="http://wiki.opscode.com/display/chef/Home">Chef</a> というソフトウェアについて触れられていた。</p>

<p>ソフトウェアのポジション的にも、使われている用語的にも、かなり Puppet を意識している模様。開発言語が Ruby という点も Puppet と同じ。</p>

<p>Luke 氏としては、Puppet を散々使っていながらあまりコードに貢献することなしに、新しいプロジェクトを立ち上げるってどうなのよ、とか、競合が存在するのはいいことなんだけど、 そんなたくさん競合がある分野じゃないんだから、もっと色々話してくれてもいいのに、といった不満があるみたい。</p>

<p>また、名前が SEO 的にまずいよね、自分もそれで苦労した、といったことや、Puppet が外部 DSL なのに対し、Chef は内部 DSL なんだけどそれってどうなのよ、的なことも書いてますね。自分も外部 DSL の方が、制限があるけどわかりやすくていいんじゃないかとは思ってます。</p>

<p>で、&#8221;I’m not afraid of competition.&#8221; と言っていて、Puppet の競合なんて笑わせるぜ、的なことを言ってる（実際にこういうニュアンスかはよくわからないけど）わけですが、やはり気にはなるので試してみました。</p>

<p>最初は CentOS 5.2 で環境作ろうとしてたんですが、あまりにも面倒で挫折したので、<a href="http://wiki.opscode.com/display/chef/Installation">インストールガイド</a> で対象としてる Ubuntu で試してみました。</p>

<h1>インストール手順</h1>

<p>今回はひとつの Ubuntu 8.10 VM 上で、サーバ/クライアント両方を兼ねる形でセットアップしました。基本的には <a href="http://wiki.opscode.com/display/chef/Installation">インストールガイド</a> にある通りなんですが、いくつか説明通りではうまくいかなかった点があるので、その点をここで補足しておきます。</p>

<p>「Install Ruby and Rubygems」では、libhttp-access2-ruby も合わせてインストールしておく必要があります。</p>

<pre><code>$ sudo apt-get install ruby ruby1.8-dev rubygems build-essential libhttp-access2-ruby
</code></pre>

<p>また、「Bring up the Chef Server」にある、</p>

<pre><code>$ sudo chef-solo -r http://wiki.opscode.com/download/attachments/1179839/chef-server-install-solo.tar.gz
</code></pre>

<p>ですが、これをそのまま実行しても、エラーが出て途中で止まってしまいました。この手順では、chef-solo というスタンドアローンな chef クライアントを使って、chef に必要となるパッケージをインストールし、初期化等を行っているのですが、runit パッケージと couchdb パッケージのインストール部分でこけてました。なので、まずは一度上記コマンドを実行してエラーが出た後に、この2つのパッケージを手動でインストールしておきます。</p>

<pre><code>$ sudo apt-get install runit couchdb
</code></pre>

<p>それから、http://wiki.opscode.com/download/attachments/1179839/chef-server-install-solo.tar.gz の展開先にある二つのファイルを修正し、runit と couchdb をインストールしている部分をコメントアウトします。</p>

<p>/tmp/chef-solo/cookbooks/runit/recipes/default.rb</p>

<pre><code>#  package "runit" do
#    action :install
#    notifies :run, resources(:execute =&gt; "start-runsvdir")
#  end
</code></pre>

<p>/tmp/chef-solo/cookbooks/chef/recipes/server.rb</p>

<pre><code>#package "couchdb"
</code></pre>

<p>修正後、ファイルを tar.gz で固めます。</p>

<pre><code>$ cd /tmp
$ tar cvf chef-solo.tar chef-solo
$ gzip chef-solo.tar
</code></pre>

<p>その後この tar.gz ファイルを指定して、chef-solo を走らせます。</p>

<pre><code>$ sudo chef-solo -r /tmp/chef-solo.tar.gz
</code></pre>

<p>これでインストールは完了し、ウェブブラウザで 4000 番ポートにアクセスすることができるようになります。</p>

<h1>Chef Repository の作成</h1>

<p>インストールの次に行うのは、<a href="http://wiki.opscode.com/display/chef/Chef+Repository">Chef Repository の作成</a> です。Chef Repository とは、Chef でサーバ管理をするために必要な Cookbooks(Puppet でいうマニフェス）や設定ファイル等を管理するためのリポジトリです。</p>

<p>ここも基本的には <a href="http://wiki.opscode.com/display/chef/Chef+Repository">Wiki の手順書</a> の通りなので、その通りに実行すればいいだけなんですが、いくつか補足を。</p>

<p>リポジトリの雛形を作成するところは、git clone してますので、当然 git が必要となります。なので、あらかじめインストールしておきます。</p>

<pre><code>$ sudo apt-get install git git-core
</code></pre>

<p>rake new_cookbook してる手順ですが、これは cookbook の雛形となるファイルを生成してくれます。</p>

<pre><code>$ rake new_cookbook COOKBOOK=apache
(in /home/mizzy/chef-repo)
</code></pre>

<p>** Creating cookbook apache</p>

<p>を実行すると、以下のようなディレクトリ/ファイルが生成されます。</p>

<pre><code>$ ls -FR cookbooks/apache/
cookbooks/apache/:
attributes/  definitions/  files/  libraries/  recipes/  templates/

cookbooks/apache/attributes:

cookbooks/apache/definitions:

cookbooks/apache/files:
default/

cookbooks/apache/files/default:

cookbooks/apache/libraries:

cookbooks/apache/recipes:
default.rb

cookbooks/apache/templates:
default/

cookbooks/apache/templates/default: 
</code></pre>

<p>例えば、cookbooks/apache/recipes/default.rb の内容は以下のようになってます。</p>

<pre><code>#
# Cookbook Name:: apache
# Recipe:: default
#
# Copyright 2009, Example Com
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
</code></pre>

<p>rake install を実行すると、作成/編集した cookbooks を /var/chef/cookbooks の下に配置してくれたり、cofig/server.rb, client.rb, solo.rb を /etc/chef の下に配置してくれたりします。なので、雛形を git clone したままだと、勝手に設定が書き換えられるので注意が必要です。</p>

<p>実行時には、rake update (upstream リポジトリからの pull) と rake test も合わせて実行してくれ、sudo も自動的に実行してくれます。実行した結果は以下のようになります。</p>

<pre><code>$ rake install
(in /home/mizzy/chef-repo)
</code></pre>

<p>** Updating your repository</p>

<pre><code>Already up-to-date.
</code></pre>

<p>** Testing your cookbooks for syntax errors</p>

<pre><code>Testing recipe /home/mizzy/chef-repo/cookbooks/apache/recipes/default.rb: Syntax OK
</code></pre>

<p>** Installing your cookbooks
* Creating Directories
* Installing new Cookbooks</p>

<pre><code>sending incremental file list
README
          54 100%    0.00kB/s    0:00:00 (xfer#1, to-check=10/12)
apache/
apache/attributes/
apache/definitions/
apache/files/
apache/files/default/
apache/libraries/
apache/recipes/
apache/recipes/default.rb
         628 100%   18.04kB/s    0:00:00 (xfer#2, to-check=1/12)
apache/templates/
apache/templates/default/

sent 1063 bytes  received 86 bytes  2298.00 bytes/sec
total size is 682  speedup is 0.59
</code></pre>

<ul>
<li>Installing new Site Cookbooks
  sending incremental file list
  README

<pre><code>        96 100%    0.00kB/s    0:00:00 (xfer#1, to-check=0/2)
</code></pre>

<p>  sent 178 bytes  received 31 bytes  418.00 bytes/sec
  total size is 96  speedup is 0.46</p></li>
<li>Installing new Chef Server Config</li>
<li>Installing new Chef Client Config</li>
</ul>


<h1>Chef クライアント のサーバへの登録</h1>

<p>Chef クライアントを動作させるためには、まずは Chef サーバへのノード登録が必要となります。手順は http://wiki.opscode.com/display/chef/Nodes#Nodes-RegistrationviatheWebUI の通りで、サーバの 4000 番ポートにブラウザでアクセスし、</p>

<ol>
<li>右上の「Login」をクリックして、OpenID でログインする</li>
<li>上部の「Registration」をクリックする</li>
<li>対象となるノードの「Validation」をクリックする</li>
</ol>


<p>で完了です。</p>

<p>ここで気になるのは、OpenID でログインするので、有効な OpenID アカウントさえ持っていれば、とりあえずログインできちゃうんですよね。なので、デフォルトで誰でもログインできちゃうような状態なんで、これはまずいだろ、と。</p>

<p>それから、<a href="http://wiki.opscode.com/display/chef/Nodes#Nodes-NodeshaveOpenIDs">Nodes have OpenIDs</a> のところを読むと、内部的に Chef サーバがノードを認証するための仕組みとしても OpenID を使っているみたいなんだけど、そのメリットとか意図がさっぱりわからない。</p>

<h1>cookbook を 作成して Chef クライアントに適用する</h1>

<p>サンプル cookbook の作成の仕方は、<a href="http://wiki.opscode.com/display/chef/Quick+Start">Quick Start</a> を参照すれば OK です。ここでは特に補足しません。</p>

<p>わかりにくいのが、作成した cookbook を特定のノードに適用する方法。Puppet だと以下のようなやつ。</p>

<pre><code>node 'client.example.org' {
    include apache
}
</code></pre>

<p>これには <a href="http://wiki.opscode.com/display/chef/Nodes#Nodes-ManagingNodesviatheWebUI">ウェブ UI を利用する方法</a> と <a href="http://wiki.opscode.com/display/chef/Nodes#Nodes-ManagingNodesthroughJSONatthecommandline">chef-client コマンドを利用する方法</a> があります。</p>

<p>ウェブ UI の方では、上部メニューの「Nodes」をクリックし、該当するノードを選択。するとノードに関する詳細情報が表示されるので、適当なところをクリック。すると、テキストエリアに以下のように JSON 形式で内容が表示されて編集可能に。</p>

<pre><code>{
  "name": "ubuntu",
  "_rev": "4279229607",
  "attributes": {
    "kernel": {
      "machine": "i686",
      "name": "Linux",
      "os": "GNU\/Linux",
      "version": "#1 SMP Thu Nov 20 21:57:00 UTC 2008",
      "release": "2.6.27-9-generic"
    },

    ... 中略 ...

    "uptime": "4 hours 56 minutes 03 seconds",
    "platform": "ubuntu",
    "block_device": {
      "ram13": {
        "size": "131072",
        "removable": "0"
      },

      ... 中略 ...

      "ram9": {
        "size": "131072",
        "removable": "0"
      }
    },
    "uptime_seconds": 17763
  },
  "json_class": "Chef::Node",
  "recipes": [

  ],
  "chef_type": "node"
}
</code></pre>

<p>この下のほうにある「recipes」ところに、適用したい cookbook を追加して、save すれば OK らしいのですが、うちの環境ではうまく save ができませんでした。</p>

<p>chef-client コマンドを使う方法では、</p>

<pre><code>$ sudo chef-client -j node.json
</code></pre>

<p>といった形で、JSON ファイルをロードできるようなのですが、この方法でもうまくいかず、結局試すことができませんでした。また後ほど環境作り直して再チャレンジの予定。</p>

<h1>まとめ</h1>

<p>ここまでざっと使ってみた感想をまとめてみます。</p>

<ul>
<li>セットアップがめんどくさい。Puppet は Ruby と Facter があれば OK なのに対し、Chef はいろいろなものが必要。特に CouchDB は、CentOS 5 用のパッケージがなく、パッケージ作るのも大変そうだったので、今回は諦めた。（誰かパッケージの在り処を知っていったら教えてください。）</li>
<li>OpenID をつかってる意味がよくわからない。誰か教えて。</li>
<li>ウェブ UI は必要ない。すべてコマンドラインで完結してくれるほうがうれしい。</li>
<li>Chef Repository の考え方ははよさげ。

<ul>
<li>Rakefile を覗いてみると、git と subversion に対応してるみたい。</li>
<li>rake コマンド で特定のタスクを実行できるのもいい。</li>
<li>git に対応してるのは、外部の人たちと cookbooks を共有するのに良さげ。ただ、システム管理者に git 使わせるのは厳しいかも。</li>
</ul>
</li>
<li>内部 DSL よりも外部 DSL の方が、制限がある分逆に誰が書いても同じような記述になるし、分かりやすいと思うので、特にメンテナンスや他メンバーとの共有を考えると、外部 DSL である Puppet の方が個人的には好き。</li>
</ul>


<p>今のところ、まだ Puppet からの乗換えを検討しようとは思わないけど、今後ウォッチしていこうと思います。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/8/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/6/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/01/13/coderwall-badges-on-the-sidebar/">coderwall badges on the sidebar</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/10/webiblo-web-to-ebook-project-en/">Webiblo - web to ebook project</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/10/webiblo-web-to-ebook-project/">Webiblo - web to ebook project</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/09/web-to-mobi-a-script-for-converting-web-sites-to-mobipocket-format/">Web-to-mobi - A script for converting web sites to mobipocket format</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/06/weechat-script-for-pushing-notification-to-im-dot-kayac-dot-com/">WeeChat script for pushing notification to im.kayac.com</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Coderwall</h1>
  <p>
  <script type="text/javascript">
    function display_coderwall(args) {
        var badges = args["data"]["badges"];
        for ( var i = 0; i < badges.length; i++ ) {
            document.write('<img src="'+ badges[i]["badge"] + '" width="48" height="48" />');
        }
    }
  </script>
  <script src="http://coderwall.com/mizzy.json?callback=display_coderwall"></script>
  </p>
  <p style="text-align: right;"><a href="http://coderwall.com/mizzy">Powered by coderwall.com</a></p>
</section>


<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/mizzy">@mizzy</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'mizzy',
            count: 10,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>




  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Gosuke Miyashita -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mizzyorg';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
