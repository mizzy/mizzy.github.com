
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Gosuke Miyashita</title>
  <meta name="author" content="Gosuke Miyashita">

  
  <meta name="description" content="&#8220;SearchHyperEstraierPlugin&#8221;:http://weekbuild.sakura.ne.jp/trac/wiki/TracDoc/SearchHyperEstraierPlugin が、Trac 0.10.x というか、うちの環境で動かないので、 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mizzy.org/blog/page/12">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Gosuke Miyashita" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-53984-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Gosuke Miyashita</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mizzy.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/08/09/521/">Trac の SearchHyperEstraierPlugin を Trac 0.10.x で動かすパッチ</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-08-09T03:03:00+09:00" pubdate>Aug 9<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/08/09/521/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>&#8220;SearchHyperEstraierPlugin&#8221;:http://weekbuild.sakura.ne.jp/trac/wiki/TracDoc/SearchHyperEstraierPlugin が、Trac 0.10.x というか、うちの環境で動かないので、パッチ書いた。初 Python プログラミング。（というほどのものじゃないけど。）</p>

<pre><code>
=== searchhyperestraier/searchhyperestraier.py
==================================================================
--- searchhyperestraier/searchhyperestraier.py  (revision 892)
+++ searchhyperestraier/searchhyperestraier.py  (local)
@@ -2,8 +2,9 @@
 # SearchRepositoryWithNamazu plugin

 from trac.core import *
-from trac.Search import ISearchSource, query_to_sql, shorten_result
+from trac.Search import ISearchSource, shorten_result
 from trac.util import NaivePopen
+from trac.util.text import to_unicode
 from StringIO import StringIO
 import urllib
 import time
@@ -44,9 +45,9 @@
         browse_trac = self.env.config.get('searchhyperestraier', 'browse_trac','enabled')
 
 
-        cmdline = "%s %s %s %s" % (estcmd_path,estcmd_arg,index_path,unicode(query,'utf-8').encode(estcmd_encode))
+        cmdline = "%s %s %s %s" % (estcmd_path,estcmd_arg,index_path,' '.join(query))
         self.log.debug('SearchHyperEstraier:%s' % cmdline)
-        np = NaivePopen(cmdline)
+        np = NaivePopen( cmdline.encode(estcmd_encode) )
         #self.log.debug('Result:%s' % unicode(np.out,'utf-8').encode('mbcs'))
         #self.log.debug('Result:%s' % np.out)
         if np.errorlevel or np.err:
@@ -74,7 +75,7 @@
             attrelem_array = element.getElementsByTagName("attribute")
             for attrelem in attrelem_array:
                 attr_name = attrelem.getAttribute("name")
-                attr_value = unicode(attrelem.getAttribute("value")).encode('utf-8')
+                attr_value = to_unicode(attrelem.getAttribute("value"))
                 #URLとタイトルを生成
                 if attr_name == "_lreal":
                     attr_value=attr_value[len(replace_left):].replace("\\","/")
</code></pre>


<p>エラーが出るたびに、適当にいじってたら動いた、という感じ。なので、こんなんでいいのかはよく分からない。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/08/03/520/">Pushmi つかってます & 技術者募集中 at 福岡</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-08-03T01:52:00+09:00" pubdate>Aug 3<span>rd</span>, 2007</time>
        
         | <a href="/blog/2007/08/03/520/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>&#8220;弊社&#8221;:http://www.paperboy.co.jp/ は東京と福岡にオフィスがあり、それぞれの拠点に Subversion + Trac 環境を構築し、&#8221;OpenVPN&#8221;:http://openvpn.net/ により VPN 接続してお互いの開発状況を公開しています。サービス絡みの開発は基本的に、東京は東京、福岡は福岡で完結しているので、この方式で問題はないのですが、サーバ管理関連のスクリプトなんかは、東京と福岡で共通するものが多いため、別々の SVN リポジトリで管理されてると不便なんですよね。かといって、どちらかの拠点だけしかリポジトリがないと、VPN の障害発生時に、リポジトリのない拠点からはまったくアクセスができない、という困ったことになってしまいます。</p>

<p>そこで、SVN リポジトリレプリケーションツール &#8220;Pushmi&#8221;:http://search.cpan.org/dist/Pushmi/lib/Pushmi.pm を導入してみました。詳細は &#8220;YAPC::Asia での 作者 Cl Kao によるスピーチ動画&#8221;:http://video.google.com/videoplay?docid=-7181301487103062288&amp;q=yapc+asia+2007&amp;total=46&amp;start=0&amp;num=50&amp;so=1&amp;type=search&amp;plindex=13 を見て頂くとして、ここでは行った設定についてメモを残しておきます。ほとんど perldoc Pushmi の内容と同じですが。</p>

<p>まず当然 Pushmi のインストールが必要です。これの手順は省略。また、より良いアトミックロック実現のために &#8220;memcached&#8221;:http://www.danga.com/memcached/ を利用している、ということなのでインストールしておきます。これも手順は省略。</p>

<p>memcached を起動します。</p>

<pre><code>$ sudo /usr/bin/memcached -p 8123 -dP /var/run/memcached.pid -u nobody
</code></pre>


<p>/etc/pushmi.conf を設定します。弊社の環境では memcached のポートのみ指定してます。</p>

<pre><code>authproxy_port: 8123
</code></pre>


<p>ミラーリポジトリを作成します。</p>

<pre><code>$ pushmi mirror /var/db/my-local-mirror http://master.repository/svn
Mirror initialized.
</code></pre>


<p>ミラーリポジトリとマスターリポジトリを同期します。</p>

<pre><code>$ pushmi sync /var/db/my-local-mirror
Retrieving log information from 1 to 62
</code></pre>


<p>ミラーリポジトリは、svnadmin create で作成するのと同様なディレクトリ、ファイル構造になってますが、Pushmi 用の pre-commit スクリプトと post-commit スクリプトが置かれている、というところが異なります。</p>

<p>pre-commit では以下の様なコマンドが実行され、ミラーリポジトリにコミットされた内容を、マスターリポジトリにコミットしに行きます。</p>

<pre><code>/usr/bin/pushmi runhook $1 --txnname $2
</code></pre>


<p>post-commit では以下の様なコマンドが実行され、ミラーとマスターの整合性を確認しています。</p>

<pre><code>/usr/bin/pushmi verify $1 --revision $2
</code></pre>


<p>Apache + WebDAV で SVN リポジトリにアクセスするために、以下の様な設定を Apache で行います。</p>

<pre><code><Location /svn/server>
  PerlSetVar SVNPath /var/db/my-local-mirror
  PerlSetVar Pushmi /usr/bin/pushmi
  PerlSetVar PushmiConfig /etc/pushmi.conf
  <LimitExcept GET PROPFIND OPTIONS REPORT>
    AuthName "mirrored private area"
    AuthType Basic
    Require valid-user
    AuthLDAPURL ldap://localhost:389/ou=people,o=paperboy?uid?sub?(objectclass=*)
    PerlAuthenHandler Pushmi::Apache::AuthCommit
  </LimitExcept>
</Location>
</code></pre>


<p>設定見て分かると思いますが、mod_perl を利用していて、Apche2 + mod_perl の環境が必要です。Apache は 2.0 系でも 2.2 系でも大丈夫なようです。弊社では 2.0 系を利用しています。</p>

<p>特にポイントとなるのは、</p>

<pre><code>PerlAuthenHandler Pushmi::Apache::AuthCommit
</code></pre>


<p>の部分で、認証で渡されたユーザ名、パスワードをこのモジュールで memcached にキャッシュしておき、マスタリポジトリへのコミット時の認証に利用します。Apache 2.2 系の場合には、以下の様に設定します。</p>

<pre><code>AuthBasicProvider Pushmi::Apache::RelayProvider
</code></pre>


<p>この状態では、ミラーへのコミットは即マスターに反映されますが、マスターへのコミットはミラーに反映されませんので、以下の様な cron 設定を行い、5分おきにマスターとミラーを同期するようにします。</p>

<pre><code>*/5 * * * * /usr/bin/pushmi sync --nowait /var/db/my-local-mirror
</code></pre>


<p>今のところこれで問題なく動いています。</p>

<p>話変わりまして、弊社福岡支社では、&#8221;プログラマ&#8221;:http://tenshoku.mynavi.jp/jobset/index.cfm?fuseaction=mrjt_Jobinfo_form&amp;client_id=87984&amp;plan_id=1&amp;contract_id=1&amp;job_seq_no=1&amp;ty=0&amp;rm=0 と &#8220;サーバエンジニア&#8221;:http://tenshoku.mynavi.jp/jobset/index.cfm?fuseaction=mrjt_Jobinfo_form&amp;client_id=87984&amp;plan_id=1&amp;contract_id=1&amp;job_seq_no=2&amp;ty=0&amp;rm=0 を募集しています。Pushmi を実戦で使ってみたい！という方はぜひ。メガネ女子プログラマもいますよ。（東京本社にもいます。人妻ですが。）</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/07/26/519/">Mod_dosdetector を Apache 2.0 系で動かすパッチ</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-07-26T22:32:00+09:00" pubdate>Jul 26<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/07/26/519/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>&#8220;mod_dosdetecter 0.2&#8221;:http://sourceforge.net/projects/moddosdetector/ を Apache 2.0 系で動かすパッチを書いてみた。修正ポイントは、</p>

<ul>
<li>/usr/local/apache/include/pcreposix.h:41: error: redeclaration of enumerator `REG_BADBR&#8217; といったエラーが大量に出てくるが、これは /usr/include/regex.h と宣言が重複しているため。なので、#include &lt;regex.h&gt; は削除。</li>
<li>ap_regmatch_t 構造体と ap_regex_t 構造体は 2.2 系にのみ存在し、2.0 系には存在しない。なのでそれぞれ、regmatch_t, regex_t に置き換える。</li>
<li>apr_shm_remove は 2.2系 でしか使えないので、そのための修正を &#8220;mod_fcgid のソース&#8221;:http://mod-fcgid.cvs.sourceforge.net/mod-fcgid/mod_fcgid/arch/unix/fcgid_proctbl_unix.c?r1=1.7&amp;r2=1.8 からパクる。</li>
<li>set_ignore_contenttype_config() がセグフォるので修正</li>
</ul>


<pre><code>=== mod_dosdetector.c
==================================================================
--- mod_dosdetector.c   (revision 804)
+++ mod_dosdetector.c   (local)
@@ -28,7 +28,6 @@
 #include <arpa/inet.h>
 //#include <netinet/in.h>
 #include <time.h>
-#include <regex.h>
 #include "httpd.h"
 #include "http_config.h"
 #include "http_request.h"
@@ -41,6 +40,7 @@
 #include "apr_strings.h"
 #include "apr_shm.h"
 #include "apr_thread_mutex.h"
+#include "apr_version.h"
 
 //#define _DEBUG
 
@@ -102,7 +102,90 @@
 static apr_global_mutex_t *lock = NULL;
 static apr_shm_t *shm = NULL;
 
+/* apr version 0.x not support apr_shm_remove, I have to copy it from apr version 1.x */
+#if (APR_MAJOR_VERSION < 1)
+#ifdef HAVE_SYS_MMAN_H
+#include <sys/mman.h>
+#endif
+#ifdef HAVE_SYS_IPC_H
+#include <sys/ipc.h>
+#endif
+#ifdef HAVE_SYS_MUTEX_H
+#include <sys/mutex.h>
+#endif
+#ifdef HAVE_SYS_SHM_H
+#include <sys/shm.h>
+#endif
+#if !defined(SHM_R)
+#define SHM_R 0400
+#endif
+#if !defined(SHM_W)
+#define SHM_W 0200
+#endif
+#ifdef HAVE_SYS_FILE_H
+#include <sys/file.h>
+#endif
 
+static apr_status_t apr_shm_remove(const char *filename, apr_pool_t * pool)
+{
+#if APR_USE_SHMEM_SHMGET
+   apr_status_t status;
+   apr_file_t *file;
+   key_t shmkey;
+   int shmid;
+#endif
+
+#if APR_USE_SHMEM_MMAP_TMP
+   return apr_file_remove(filename, pool);
+#endif
+#if APR_USE_SHMEM_MMAP_SHM
+   if (shm_unlink(filename) == -1) {
+       return errno;
+   }
+   return APR_SUCCESS;
+#endif
+#if APR_USE_SHMEM_SHMGET
+   /* Presume that the file already exists; just open for writing */
+   status = apr_file_open(&file, filename, APR_WRITE,
+                          APR_OS_DEFAULT, pool);
+   if (status) {
+       return status;
+   }
+
+   /* ftok() (on solaris at least) requires that the file actually
+    * exist before calling ftok(). */
+   shmkey = ftok(filename, 1);
+   if (shmkey == (key_t) - 1) {
+       goto shm_remove_failed;
+   }
+
+   apr_file_close(file);
+
+   if ((shmid = shmget(shmkey, 0, SHM_R | SHM_W)) < 0) {
+       goto shm_remove_failed;
+   }
+
+   /* Indicate that the segment is to be destroyed as soon
+    * as all processes have detached. This also disallows any
+    * new attachments to the segment. */
+   if (shmctl(shmid, IPC_RMID, NULL) == -1) {
+       goto shm_remove_failed;
+   }
+   return apr_file_remove(filename, pool);
+
+  shm_remove_failed:
+   status = errno;
+   /* ensure the file has been removed anyway. */
+   apr_file_remove(filename, pool);
+   return status;
+#endif
+
+   /* No support for anonymous shm */
+   return APR_ENOTIMPL;
+}
+#endif                         /* APR_MAJOR_VERSION<1 */
+
+
 static apr_status_t cleanup_shm(void *not_used)
 {
     ap_log_error(APLOG_MARK, APLOG_STARTUP, 0, NULL, "Notice: cleaning up shared memory");
@@ -261,8 +344,8 @@
 
    address = r->connection->remote_ip;
 
-    ap_regmatch_t regmatch[AP_MAX_REG_MATCH];
-    ap_regex_t **contenttype_regexp = (ap_regex_t **) cfg->contenttype_regexp->elts;
+    regmatch_t regmatch[AP_MAX_REG_MATCH];
+    regex_t **contenttype_regexp = (regex_t **) cfg->contenttype_regexp->elts;
    for (i = 0; i < cfg->contenttype_regexp->nelts; i++) {
        if(!ap_regexec(contenttype_regexp[i], content_type, AP_MAX_REG_MATCH, regmatch, 0)){
            //ap_log_error(APLOG_MARK, APLOG_NOTICE, 0, 0, "ignoring content-type: %s", content_type);
@@ -390,15 +473,13 @@
                     const char *arg)
 {
     dosdetector_dir_config *cfg = (dosdetector_dir_config *) mconfig;
-    char **ignore_contenttype = (char **) cfg->ignore_contenttype->elts;
+    regex_t *regexp;
+    char *type;
 
-    *(char **) apr_array_push(cfg->ignore_contenttype) = apr_pstrdup(parms->pool, arg);
-
-   int i;
-   regex_t *regexp;
-   for (i = 0; i < cfg->ignore_contenttype->nelts; i++) {
-        regexp = (regex_t *)ap_pregcomp(parms->pool, (char *)ignore_contenttype[i], REG_EXTENDED|REG_ICASE);
-       *(regex_t **)apr_array_push(cfg->contenttype_regexp) = regexp;
+    while (*arg) {
+      type = ap_getword_conf(parms->pool, &arg);
+      regexp = ap_pregcomp(parms->pool, type, REG_EXTENDED|REG_ICASE);
+      *(regex_t **)apr_array_push(cfg->contenttype_regexp) = regexp;
     }
 
     return NULL;
</code></pre>


<p>2.0 系でも 2.2 系でもどっちでも動くように修正した方がいいんだろうけど、それはまた今度。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/07/09/library-perl-trunk-Parse-Apache-ServerStatus-Extended-lib-Parse-Apache-ServerStatus-Extended.pm/">library/perl/trunk/Parse-Apache-ServerStatus-Extended/lib/Parse/Apache/ServerStatus/Extended.pm</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-07-09T21:03:59+09:00" pubdate>Jul 9<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/07/09/library-perl-trunk-Parse-Apache-ServerStatus-Extended-lib-Parse-Apache-ServerStatus-Extended.pm/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>source:library/perl/trunk/Parse-Apache-ServerStatus-Extended/lib/Parse/Apache/ServerStatus/Extended.pm</p>

<h1>NAME</h1>

<p>Parse::Apache::ServerStatus::Extended - Simple module to parse apache&#8217;s extended server-status.</p>

<h1>SYNOPSIS</h1>

<pre><code>    use Parse::Apache::ServerStatus::Extended;

    my $parser = Parse::Apache::ServerStatus::Extended-&gt;new;

    $parser-&gt;request(
       url     =&gt; 'http://localhost/server-status',
       timeout =&gt; 30
    ) or die $parser-&gt;errstr;

    my $stat = $parser-&gt;parse or die $parser-&gt;errstr;

    # or both in one step

    my $stats = $parser-&gt;get(
       url     =&gt; 'http://localhost/server-status',
       timeout =&gt; 30
    ) or die $parser-&gt;errstr;
</code></pre>

<h1>DESCRIPTION</h1>

<p>This module parses the content of apache&#8217;s extended server-status.It works nicely with apache versions 1.3 and 2.x.</p>

<h1>METHODS</h1>

<h2>new()</h2>

<p>Call <code>new()</code> to create a new Parse::Apache::ServerStatus::Extended object.</p>

<h2>request()</h2>

<p>This method accepts one or two arguments: <code>url</code> and <code>timeout</code>. It requests the url and safes the content into the object. The option <code>timeout</code> is set to 180 seconds if it is not set.</p>

<h2>parse()</h2>

<p>Call <code>parse()</code> to parse the extended server status. This method returns an array reference with the parsed content.</p>

<p>It&#8217;s possible to call <code>parse()</code> with the content as an argument.</p>

<pre><code>    my $stat = $prs-&gt;parse($content);
</code></pre>

<p>If no argument is passed then <code>parse()</code> looks into the object for the content that is stored by <code>request()</code>.</p>

<h2>get()</h2>

<p>Call <code>get()</code> to <code>request()</code> and <code>parse()</code> in one step. It accepts the same options like <code>request()</code> and returns the array reference that is returned by <code>parse()</code>.</p>

<h1>SEE ALSO</h1>

<p>Parse::Apache::ServerStatus</p>

<h1>AUTHOR</h1>

<p>Gosuke Miyashita <code>&lt;gosukenator at gmail.com&gt;</code></p>

<h1>LICENCE AND COPYRIGHT</h1>

<p>This module is free software; you can redistribute it and/or modify it under the same terms as Perl itself. See perlartistic.</p>

<h1>DISCLAIMER OF WARRANTY</h1>

<p>BECAUSE THIS SOFTWARE IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY FOR THE SOFTWARE, TO THE EXTENT PERMITTED BY APPLICABLE LAW. EXCEPT WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES PROVIDE THE SOFTWARE &#8220;AS IS&#8221; WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE. THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THE SOFTWARE IS WITH YOU. SHOULD THE SOFTWARE PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING, REPAIR, OR CORRECTION.</p>

<p>IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR REDISTRIBUTE THE SOFTWARE AS PERMITTED BY THE ABOVE LICENCE, BE LIABLE TO YOU FOR DAMAGES, INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES ARISING OUT OF THE USE OR INABILITY TO USE THE SOFTWARE (INCLUDING BUT NOT LIMITED TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY YOU OR THIRD PARTIES OR A FAILURE OF THE SOFTWARE TO OPERATE WITH ANY OTHER SOFTWARE), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGES.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/06/30/518/">Puppet の連載はじめました</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-06-30T15:10:00+09:00" pubdate>Jun 30<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/06/30/518/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://gihyo.jp/admin/serial/01/puppet">gihyo.jp で Puppet に関する連載をはじめました。</a></p>

<p>第1回目は、システム管理の自動化がなぜ必要なのか、ということと、Puppet がどういったツールなのか、その概要について書いています。</p>

<p>この連載を一通り読めば、Puppet をシステム管理の現場で実践するための十分な知識が得られる、といったものを目指しています。</p>

<p>分かりにくいなどご意見ございましたら、ぜひお知らせください。</p>

<p>3週間毎に更新予定です。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/06/14/517/">紫色の何かを口に押し付けている…</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-06-14T13:02:00+09:00" pubdate>Jun 14<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/06/14/517/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>会社に紫色のブツがあったので。</p>

<p><img src="http://blog.mizzy.org/files/something_purple.jpg" title="紫" alt="紫" /></p>

<p>この写真は DPL(Dr.Pepper License) により保護されています。ドクターペッパー1本おごってくれれば、自由に使ってもらって構いません。（ライセンス発案者は <a href="http://d.hatena.ne.jp/tokuhirom/">id:tokuhirom</a> さんと <a href="http://d.hatena.ne.jp/hirose31/">id:hirose31</a>  さん）</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/06/14/516/">紫色の何かを口に押し付けている…</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-06-14T12:34:00+09:00" pubdate>Jun 14<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/06/14/516/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>会社に紫色のブツがあったので…</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/05/25/515/">Puppet 勉強会資料</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-05-25T22:16:00+09:00" pubdate>May 25<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/05/25/515/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>ペパボ社内で実施した Puppet 勉強会の資料を<a href="http://trac.mizzy.org/puppet/wiki/LearningPuppet">パペウィキにアップしました</a>。</p>

<p>内容的には、Puppetをまったく知らない人が、とりあえず動かしてみるために最低限知っておく必要のある情報をまとめてみた、という感じです。既に触っている方や、どんなものか一通りご存知の方には当たり前の内容ばかりだと思います。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/05/25/514/">ペパボでは技術スタッフ正社員を募集しています</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-05-25T20:51:00+09:00" pubdate>May 25<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/05/25/514/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.paperboy.co.jp/recruit/job/070523.php">プログラマ</a> と <a href="http://www.paperboy.co.jp/recruit/job/070403b.php">サーバーエンジニア</a> の枠で正社員募集中です。</p>

<p>プログラマは、現在僕が出張で来ている福岡で、サーバエンジニアは東京での募集です。</p>

<p><a href="http://ieiriblog.jugem.jp/?eid=1061">社長から「頭がおかしい」と言われるような</a> <a href="http://paperboy.grouptube.jp/user/miyashita">こんな僕</a>が技術のトップなんぞやってる会社ですが、ドクターペッパーが好きなサーバエンジニアの方、ぜひ僕と一緒にリフレッシュエリアでドクターペッパー飲み飲み、社長の生態を観察しましょう。（リフレッシュエリアのソファに座ると、真正面にガラス越しの社長が観察できます。動物園気分が味わえますよ。）またはカレー（ハヤシ含む）を飲みながらでも OK です。</p>

<p>プログラマは福岡での募集ですが、たびたび出張で来ますので、ぜひ福岡オフィスの自販機にドクターペッパーを入れるよう、署名運動とかしてもらいたいと思います。そしてドクターペッパー飲みつつ、焼きカレーを食べましょう。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/05/25/513/">Write はユーザプロセスを待たせない？の答え</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2007-05-25T20:03:00+09:00" pubdate>May 25<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/05/25/513/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://blog.mizzy.org/articles/2007/05/23/linux-disk-io-00">前回のエントリ</a> について、naoya さんから<a href="http://d.hatena.ne.jp/naoya/20070523/1179938637">僕の期待以上の素晴らしい回答</a>を頂きました。感謝感謝です。</p>

<p>詳細は上記エントリをじっくり読んで頂きたいのですが、僕の疑問への直接の答えとなるのが、まとめにある</p>

<blockquote><ul>
<li>write はプロセスを待たせない</li>
<li>ただし明示的に sync する場合は待たせる</li>
</ul>
</blockquote>

<p>ですね。「write はプロセスを待たせない」が正しい、というのは naoya さんの解説を読んで納得しました。プロセスが write するということと、それが実際にディスクに書き出されることを、区別しないで考えていたのが僕の敗因ですね。</p>

<p>また、こちらの環境で kjournald や qmail-queue プロセスが待たされていたのは、sync してるから、ということでした。kjournald は確かめていないのですが、qmail-queue のソースの中では確かに fsync() が実行されていました。考えてみれば当然ですよね。ジャーナルのメタデータやメールキューなど、大事なデータを write して sync しないなんてことはあり得ないでしょうし。</p>

<p>なので、<a href="http://d.hatena.ne.jp/hirose31/">id:hirose31</a>さんからのコメント「fsync(2)のせい？」がずばり回答になっていました。ありがとうございます。今度カレーおごらせてください。</p>

<p>というわけで、「write はユーザプロセスを待たせない？」は「待たせない」が答え、ということで完結です。</p>

<p>あと、</p>

<blockquote><p>ということですが free の結果では、プロセスに割り当てるためのメモリが足りてるかどうかはわかりますが、ページキャッシュ用にメモリが足りてるかどうかはわかりません。</p>

<p>実際そのサーバーが主な仕事で使っているデータは、合計でどのぐらいのサイズでしょう。おそらく、キューに溜まったメールその他 OS 上で必要なデータのサイズをあわせると 800MB を超えるんではないかなあと思います。外してたらごめん。</p></blockquote>

<p>もおっしゃるとおりですね。プロセスに必要なメモリ容量と、キャッシュに必要なメモリ容量をちゃんと区別していませんでした。</p>

<p>となると、メモリを増やせば書き込み性能が向上する可能性があるのでは、と思ったのですが、今回のケースではおそらく向上することはなさそうです。というのも、iostat の値を見てると、avgqu-sz が 1 日平均でおよそ 5、短時間で見ると 10 とか 20 あるいはそれ以上ということがざらにあります。avgqu-sz はキューに入っていて待ちとなっている I/O リクエストの数なので、常に処理待ちとなっている I/O リクエストが存在する、ということなります。なので、ページキャッシュの容量の問題ではなく、ディスクの性能がボトルネックになっている、と言えそうです。（これも自分の勘違いなら恥ずかしいなー…メモリを簡単に増やせるなら、試してみたいんですけどね。）</p>

<p>naoya さん、詳細な解説ありがとうございました。大変勉強になりました。僕のために時間を割いて長文エントリ書いてくれた、と思うとちょっと萌えました。（べっ、別にあんたのために…、とか言われそうですが。）</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/13/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/11/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2011/11/15/octopress-on-heteml/">How to deploy a blog made by Octopress to Heteml</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/11/05/maglica-web/">Maglica Web</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/10/30/vimeo-tag-plugin/">Vimeo tag plugin</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/10/29/typo-to-octopress/">Typo to Octopress</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/10/21/twan-tag-plugin/">TWAN tag plugin for Jekyll</a>
      </li>
    
  </ul>
</section>




  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011 - Gosuke Miyashita -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mizzyorg';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
