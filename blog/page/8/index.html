
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Gosuke Miyashita</title>
  <meta name="author" content="Gosuke Miyashita">

  
  <meta name="description" content="ペパボでは以下の2つのサービスで開発者を募集中です。 Color Me Shop!pro
30days Album 併せて開発アルバイトも募集中です。 詳しくは募集要項をご確認ください。 募集要項にはありませんが、採用された方にはドクターペッパーチェリーを差し上げます。合い言葉は「 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mizzy.org/blog/page/8">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Gosuke Miyashita" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-53984-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Gosuke Miyashita</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mizzy.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/09/02/DeveloperRecruitAtPaperboy/">Developer Recruit At Paperboy</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-09-02T02:16:46+09:00" pubdate>Sep 2<span>nd</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>ペパボでは以下の2つのサービスで開発者を募集中です。</p>

<ul>
<li><a href="http://www.paperboy.co.jp/recruit/job/090821.php">Color Me Shop!pro</a></li>
<li><a href="http://www.paperboy.co.jp/recruit/job/090806.php">30days Album</a></li>
</ul>


<p>併せて<a href="http://www.paperboy.co.jp/recruit/job/090821b.php">開発アルバイト</a>も募集中です。</p>

<p>詳しくは募集要項をご確認ください。</p>

<p>募集要項にはありませんが、採用された方にはドクターペッパーチェリーを差し上げます。合い言葉は「ドクターペッパーチェリー飲みたい！」です。僕との面接時に必ず声に出して言ってください。</p>

<p>[[Image(http://gyazo.com/37db61b8bd76e406987622d9863fbe5f.png)]]</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/08/13/YapcAsia2009/">Yapc Asia2009</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-08-13T01:18:44+09:00" pubdate>Aug 13<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>このところ、ほとんどエントリ更新してませんが、それは、<a href="http://japan.cnet.com/extra/paperboy_0907/story/0,3800098768,20394957,00.htm">ナウでヤングなレンタルサーバー ロリポップ！のインフラ再構築</a> で多忙だったからです。（それだけではないですが。）</p>

<p>というわけで、ブログエントリをほとんど書いてないので細切れにもなりようがないのですが、ロリポ含めて、ペパボが提供するサービスの中で、Perl がどのように使われているのかという話を <a href="http://d.hatena.ne.jp/hiboma/">id:hiboma</a> と一緒に YAPC::Asia 2009 でさせていただくことにしました。</p>

<p>また、それとは別に、以前からの関心事であった、Perlbal で非同期処理するプラグインを書く方法についても、ベースとなる Danga::Socket の説明も含めて、お話したいと思います。</p>

<p>YAPC::Asia 2009 は9月10日(木)と11日(金)の2日間、東京工業大学大岡山キャンパスで開催されます。すでにチケット販売も始まったので、興味のある方はお越しいただければ、と思います。</p>

<ul>
<li><a href="http://conferences.yapcasia.org/ya2009/">YAPC::Asia 2009</a></li>
<li><a href="http://conferences.yapcasia.org/ya2009/talk/2166">ペパボでの Perl のつかいかた</a></li>
<li><a href="http://conferences.yapcasia.org/ya2009/talk/2220">Perlbalで非同期処理するプラグインを書く方法</a></li>
</ul>


<p>【参考文献】</p>

<ul>
<li>http://d.hatena.ne.jp/hirose31/20090807/1249611130</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/08/06/InotifyAndMakuosan/">Inotify And Makuosan</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-08-06T08:05:40+09:00" pubdate>Aug 6<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>ファイルのミラーリングツールとしては rsync が最も使われていると思いますが、差分チェックの負荷が大きく、できればつかうのやめたいなー、と思っていたところ、<a href="http://gihyo.jp/magazine/SD/archive/2009/200908">Software Design 2009年8月号</a> に <a href="http://code.google.com/p/lsyncd/">lsyncd</a> というツールが載っていて、お、これはと思って見てみたのですが、仕組みとしては inotify + rsync なので、結局は rsync を裏で呼び出していて、差分チェックの呪縛からは逃れられません。</p>

<p>inotify でファイルの更新イベント受け取ってるんだから、さらに rsync で差分チェックする必要はないじゃん、と思うわけですが、なんらかの理由でイベントが受け取れない可能性もあるため、二重チェックした方が安全なんでしょうね。</p>

<p>でもやっぱり余分な負荷はかけたくない、ってことで思いついたのが、inotify で更新イベントを検知したファイルを、<a href="http://lab.klab.org/wiki/Makuosan">makuosan</a> の msync コマンドに渡してミラーリングする方法。（makusan の詳しい解説は、<a href="http://gihyo.jp/magazine/wdpress/archive/2009/vol51">WEB+DB PRESS Vol.51</a> に載ってます。）</p>

<p>そこで以下のようなコードを書いて動かしてみたところ、いい感じでファイルが同期できることを確認しました。</p>

<pre><code>#!perl
#!/usr/bin/perl

use strict;
use warnings;
use File::ChangeNotify;

my $base = '/home/miya/work';
my $watcher = File::ChangeNotify-&gt;instantiate_watcher(
    directories =&gt; [ $base ],
);

while ( my @events = $watcher-&gt;wait_for_events() ) {
    for my $event ( @events ) {
        my $path = $event-&gt;path;
        $path =~ s!$base/!!;
        `msync --sync $path`;
    }
}

exit;
</code></pre>

<p>とは言っても、実運用で使うためには、イベントをとりこぼさない、またはとりこぼしてもリカバーするような仕組みを考えたり、負荷テストをしてみたりとか、色々と考慮しなければいけないことはありますが、それはまあおいおいってことで。</p>

<p>また、<a href="http://search.cpan.org/~drolsky/File-ChangeNotify/">File::ChangeNotify</a> がすべての inotify イベントに対応してるわけではなく、IN_CREATE, IN_MODIFY, IN_DELETE にしか対応してないため、パーミッション変更とかファイルの移動なんかは検知できない、という問題もあります。（パッチ書けばいけそうなので、書いてみるつもりです。）</p>

<p>File::ChangeNotify 自体は inotify だけじゃなく、他の仕組みにも対応できるようになっていて、inotify が使える Linux kernel 2.6.13 以降であれば File::ChangeNotify::Watcher::Inotify が、それ以外であれば File::ChangeNotify::Watcher::Default が自動的に呼ばれるようになってます。なので、Mac OS X の FSEvents に対応した File::ChangeNotify::Watcher::FSEvents とか書けば、Mac では自動的に FSEvents で更新イベントを検知、ってこともできそうです。</p>

<p>ともかく、rsync の負荷には困っているので、今後この辺の方法論は詰めていきたいな、と思っています。</p>

<p><em>追記</em></p>

<p><a href="http://github.com/miyagawa/File-ChangeNotify-Watcher-MacFSEvents/tree">miyagawa さんによる File::ChangeNotify::Watcher::MacFSEvents が github にありました</a>。ただし、FSEventsではファイル名とかイベントの種類はとれないそうです。Wikipedia 見てもそんな感じのことが書いてますね。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/07/21/library-perl-trunk-Net-Amazon-ECS-lib-Net-Amazon-ECS.pm/">Library/Perl/Trunk/Net Amazon Ecs/Lib/Net/Amazon/Ecs.Pm</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-07-21T00:58:15+09:00" pubdate>Jul 21<span>st</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>source:library/perl/trunk/Net-Amazon-ECS/lib/Net/Amazon/ECS.pm</p>

<h1>NAME</h1>

<p>Net::Amazon::ECS - [One line description of module&#8217;s purpose here]</p>

<h1>VERSION</h1>

<p>This document describes Net::Amazon::ECS version 0.0.1</p>

<h1>SYNOPSIS</h1>

<pre><code>    use Net::Amazon::ECS;

    my $ua =  Net::Amazon::ECS-&gt;new(
        access_key_id =&gt; 'YOUR_AWS_ACCESS_KEY_ID',
        associate_tag =&gt; 'YOUR_AFFILIATE_ID',
        locale        =&gt; 'jp',
    );

    my $req = Net::Amazon::Request::Keyword-&gt;new(
        keywords     =&gt; 'SEARCH KEYWORDS',
        search_index =&gt; 'books',
        sort         =&gt; 'daterank',
    );

    my $res = $ua-&gt;request($req);

    croak $res-&gt;message if $res-&gt;is_error;

    my @items = $res-&gt;items;
</code></pre>

<h1>DESCRIPTION</h1>

<h1>INTERFACE</h1>

<h1>DIAGNOSTICS</h1>

<p> <code>Error message here, perhaps with %s placeholders</code>:: [Description of error here]
 <code>Another error message here</code>:: [Description of error here]
[Et cetera, et cetera]</p>

<h1>CONFIGURATION AND ENVIRONMENT</h1>

<p>Net::Amazon::ECS requires no configuration files or environment variables.</p>

<h1>DEPENDENCIES</h1>

<p>None.</p>

<h1>INCOMPATIBILITIES</h1>

<p>None reported.</p>

<h1>BUGS AND LIMITATIONS</h1>

<p>No bugs have been reported.</p>

<p>Please report any bugs or feature requests to <code>bug-net-amazon-ecs@rt.cpan.org</code>, or through the web interface at http://rt.cpan.org.</p>

<h1>AUTHOR</h1>

<p>Gosuke Miyashita <code>&lt;gosukenator@gmail.com&gt;</code></p>

<h1>LICENCE AND COPYRIGHT</h1>

<p>Copyright (c) 2006, Gosuke Miyashita <code>&lt;gosukenator@gmail.com&gt;</code>. All rights reserved.</p>

<p>This module is free software; you can redistribute it and/or modify it under the same terms as Perl itself. See perlartistic.</p>

<h1>DISCLAIMER OF WARRANTY</h1>

<p>BECAUSE THIS SOFTWARE IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY FOR THE SOFTWARE, TO THE EXTENT PERMITTED BY APPLICABLE LAW. EXCEPT WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES PROVIDE THE SOFTWARE &#8220;AS IS&#8221; WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE. THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THE SOFTWARE IS WITH YOU. SHOULD THE SOFTWARE PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING, REPAIR, OR CORRECTION.</p>

<p>IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR REDISTRIBUTE THE SOFTWARE AS PERMITTED BY THE ABOVE LICENCE, BE LIABLE TO YOU FOR DAMAGES, INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES ARISING OUT OF THE USE OR INABILITY TO USE THE SOFTWARE (INCLUDING BUT NOT LIMITED TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY YOU OR THIRD PARTIES OR A FAILURE OF THE SOFTWARE TO OPERATE WITH ANY OTHER SOFTWARE), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGES.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/05/10/AddModRewriteInternalFunction/">Add Mod Rewrite Internal Function</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-05-10T13:58:43+09:00" pubdate>May 10<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Apache モジュール界のスイスアーミーナイフこと mod_rewrite の中でも、最も何でもありな rewrite ができるのが、<a href="http://httpd.apache.org/docs/2.2/ja/mod/mod_rewrite.html#rewritemap">RewriteMap</a> での prg タイプによる外部プログラム実行ですが、こいつは外部プログラムがひとつだけ常駐し、httpd と標準入出力を介してやりとりする、という形なので、並列処理させることができません。これは rewrite 処理するときにデータベースへ問い合わせるなど、I/O ブロッキングが発生するような処理をさせたいときには致命的なパフォーマンス劣化を引き起こすことになります。</p>

<p>これを解決するためには、Apache モジュールの中で望みの rewrite 処理をさせるようにすればいいのでは、と思い、RewriteMap にある int タイプに好きな internal function を追加できればいけるんじゃないないか、と考えたものの、<a href="http://httpd.apache.org/docs/2.2/ja/mod/mod_rewrite.html">mod_rewrite のリファレンス</a> では、「you cannot create your own」とか書かれていて、追加できないっぽい。かと言って mod_rewrite.c に手を入れるのもやだなー、と思っていたところ、<a href="http://code.google.com/p/modicpquery/wiki/Internals">mod_icpquery のドキュメント</a> を見つけた。これを見ると、好きな internal function を独立したモジュールの形で追加できそう、ってことでやってみたらできた。</p>

<p>以下が internal function を追加するためのモジュールテンプレ。rewrite_mapfunc_custom の中で、望みの処理を記述してあげるだけで OK。</p>

<pre><code>#!c
#include "httpd.h"
#include "http_config.h"
#include "apr_optional.h"

/* rewrite map function prototype from mod_rewrite.h */
typedef char *(rewrite_mapfunc_t)(request_rec *r, char *key);

/* optional function declaration from mod_rewrite.h */
APR_DECLARE_OPTIONAL_FN(void, ap_register_rewrite_mapfunc,
                        (char *name, rewrite_mapfunc_t *func));

static char *rewrite_mapfunc_custom(request_rec *req, char *key)
{
    /* key を元にごにょごにょして value を生成 */
    return value;
}

/* from mod_rewrite.c */
static int pre_config(apr_pool_t *pconf,
                      apr_pool_t *plog,
                      apr_pool_t *ptemp)
{
    APR_OPTIONAL_FN_TYPE(ap_register_rewrite_mapfunc) *map_pfn_register;

    /* register int: rewritemap handlers */
    map_pfn_register = APR_RETRIEVE_OPTIONAL_FN(ap_register_rewrite_mapfunc);
    if (map_pfn_register) {
        map_pfn_register("custom", rewrite_mapfunc_custom);
    }
    return OK;
}

static void register_hooks(apr_pool_t *p)
{
    ap_hook_pre_config(pre_config, NULL, NULL, APR_HOOK_MIDDLE);
}

module AP_MODULE_DECLARE_DATA rewrite_mapfunc_custom_module = {
    STANDARD20_MODULE_STUFF,
    NULL,                  /* create per-dir    config structures */
    NULL,                  /* merge  per-dir    config structures */
    NULL,                  /* create per-server config structures */
    NULL,                  /* merge  per-server config structures */
    NULL,                  /* table of config file commands       */
    register_hooks         /* register hooks                      */
};
</code></pre>

<p>追加した internal function を呼び出すための httpd.conf は以下のような感じ。</p>

<pre><code>LoadModule rewrite_mapfunc_custom_module modules/mod_rewrite_mapfunc_custom.so

RewriteEngine On
ProxyPreserveHost On
RewriteMap custom int:custom
RewriteRule ^/(.*)$ http://${custom:%{HTTP_HOST}}/$1 [P,QSA]
</code></pre>

<p>この例では、Host ヘッダの内容を custom function に渡して、ホスト名を変換して proxy するけど、Host ヘッダはオリジナルのままで変換しない、といった処理を想定してます。</p>

<p>例の件はこんな感じで実現できそうだよ。＞<a href="http://d.hatena.ne.jp/hiboma/">id:hiboma</a></p>

<p>*2009/05/10 13:57:00 追記 *</p>

<p>github に Makefile 等も含めてコードアップしました。</p>

<p>http://github.com/mizzy/mod_rewrite_mapfunc_custom/tree/master</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/05/05/ChefFirstImpression/">Chef First Impression</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-05-05T14:45:58+09:00" pubdate>May 5<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Puppet 作者 <a href="http://madstop.com/2009/01/16/opscode-announces-chef-a-puppet-competitor/">Luke Kanies 氏のブログエントリ</a> にて、Puppet の競合となる <a href="http://wiki.opscode.com/display/chef/Home">Chef</a> というソフトウェアについて触れられていた。</p>

<p>ソフトウェアのポジション的にも、使われている用語的にも、かなり Puppet を意識している模様。開発言語が Ruby という点も Puppet と同じ。</p>

<p>Luke 氏としては、Puppet を散々使っていながらあまりコードに貢献することなしに、新しいプロジェクトを立ち上げるってどうなのよ、とか、競合が存在するのはいいことなんだけど、 そんなたくさん競合がある分野じゃないんだから、もっと色々話してくれてもいいのに、といった不満があるみたい。</p>

<p>また、名前が SEO 的にまずいよね、自分もそれで苦労した、といったことや、Puppet が外部 DSL なのに対し、Chef は内部 DSL なんだけどそれってどうなのよ、的なことも書いてますね。自分も外部 DSL の方が、制限があるけどわかりやすくていいんじゃないかとは思ってます。</p>

<p>で、&#8221;I’m not afraid of competition.&#8221; と言っていて、Puppet の競合なんて笑わせるぜ、的なことを言ってる（実際にこういうニュアンスかはよくわからないけど）わけですが、やはり気にはなるので試してみました。</p>

<p>最初は CentOS 5.2 で環境作ろうとしてたんですが、あまりにも面倒で挫折したので、<a href="http://wiki.opscode.com/display/chef/Installation">インストールガイド</a> で対象としてる Ubuntu で試してみました。</p>

<h1>インストール手順</h1>

<p>今回はひとつの Ubuntu 8.10 VM 上で、サーバ/クライアント両方を兼ねる形でセットアップしました。基本的には <a href="http://wiki.opscode.com/display/chef/Installation">インストールガイド</a> にある通りなんですが、いくつか説明通りではうまくいかなかった点があるので、その点をここで補足しておきます。</p>

<p>「Install Ruby and Rubygems」では、libhttp-access2-ruby も合わせてインストールしておく必要があります。</p>

<pre><code>$ sudo apt-get install ruby ruby1.8-dev rubygems build-essential libhttp-access2-ruby
</code></pre>

<p>また、「Bring up the Chef Server」にある、</p>

<pre><code>$ sudo chef-solo -r http://wiki.opscode.com/download/attachments/1179839/chef-server-install-solo.tar.gz
</code></pre>

<p>ですが、これをそのまま実行しても、エラーが出て途中で止まってしまいました。この手順では、chef-solo というスタンドアローンな chef クライアントを使って、chef に必要となるパッケージをインストールし、初期化等を行っているのですが、runit パッケージと couchdb パッケージのインストール部分でこけてました。なので、まずは一度上記コマンドを実行してエラーが出た後に、この2つのパッケージを手動でインストールしておきます。</p>

<pre><code>$ sudo apt-get install runit couchdb
</code></pre>

<p>それから、http://wiki.opscode.com/download/attachments/1179839/chef-server-install-solo.tar.gz の展開先にある二つのファイルを修正し、runit と couchdb をインストールしている部分をコメントアウトします。</p>

<p>/tmp/chef-solo/cookbooks/runit/recipes/default.rb</p>

<pre><code>#  package "runit" do
#    action :install
#    notifies :run, resources(:execute =&gt; "start-runsvdir")
#  end
</code></pre>

<p>/tmp/chef-solo/cookbooks/chef/recipes/server.rb</p>

<pre><code>#package "couchdb"
</code></pre>

<p>修正後、ファイルを tar.gz で固めます。</p>

<pre><code>$ cd /tmp
$ tar cvf chef-solo.tar chef-solo
$ gzip chef-solo.tar
</code></pre>

<p>その後この tar.gz ファイルを指定して、chef-solo を走らせます。</p>

<pre><code>$ sudo chef-solo -r /tmp/chef-solo.tar.gz
</code></pre>

<p>これでインストールは完了し、ウェブブラウザで 4000 番ポートにアクセスすることができるようになります。</p>

<h1>Chef Repository の作成</h1>

<p>インストールの次に行うのは、<a href="http://wiki.opscode.com/display/chef/Chef+Repository">Chef Repository の作成</a> です。Chef Repository とは、Chef でサーバ管理をするために必要な Cookbooks(Puppet でいうマニフェス）や設定ファイル等を管理するためのリポジトリです。</p>

<p>ここも基本的には <a href="http://wiki.opscode.com/display/chef/Chef+Repository">Wiki の手順書</a> の通りなので、その通りに実行すればいいだけなんですが、いくつか補足を。</p>

<p>リポジトリの雛形を作成するところは、git clone してますので、当然 git が必要となります。なので、あらかじめインストールしておきます。</p>

<pre><code>$ sudo apt-get install git git-core
</code></pre>

<p>rake new_cookbook してる手順ですが、これは cookbook の雛形となるファイルを生成してくれます。</p>

<pre><code>$ rake new_cookbook COOKBOOK=apache
(in /home/mizzy/chef-repo)
</code></pre>

<p>** Creating cookbook apache</p>

<p>を実行すると、以下のようなディレクトリ/ファイルが生成されます。</p>

<pre><code>$ ls -FR cookbooks/apache/
cookbooks/apache/:
attributes/  definitions/  files/  libraries/  recipes/  templates/

cookbooks/apache/attributes:

cookbooks/apache/definitions:

cookbooks/apache/files:
default/

cookbooks/apache/files/default:

cookbooks/apache/libraries:

cookbooks/apache/recipes:
default.rb

cookbooks/apache/templates:
default/

cookbooks/apache/templates/default: 
</code></pre>

<p>例えば、cookbooks/apache/recipes/default.rb の内容は以下のようになってます。</p>

<pre><code>#
# Cookbook Name:: apache
# Recipe:: default
#
# Copyright 2009, Example Com
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
</code></pre>

<p>rake install を実行すると、作成/編集した cookbooks を /var/chef/cookbooks の下に配置してくれたり、cofig/server.rb, client.rb, solo.rb を /etc/chef の下に配置してくれたりします。なので、雛形を git clone したままだと、勝手に設定が書き換えられるので注意が必要です。</p>

<p>実行時には、rake update (upstream リポジトリからの pull) と rake test も合わせて実行してくれ、sudo も自動的に実行してくれます。実行した結果は以下のようになります。</p>

<pre><code>$ rake install
(in /home/mizzy/chef-repo)
</code></pre>

<p>** Updating your repository</p>

<pre><code>Already up-to-date.
</code></pre>

<p>** Testing your cookbooks for syntax errors</p>

<pre><code>Testing recipe /home/mizzy/chef-repo/cookbooks/apache/recipes/default.rb: Syntax OK
</code></pre>

<p>** Installing your cookbooks
* Creating Directories
* Installing new Cookbooks</p>

<pre><code>sending incremental file list
README
          54 100%    0.00kB/s    0:00:00 (xfer#1, to-check=10/12)
apache/
apache/attributes/
apache/definitions/
apache/files/
apache/files/default/
apache/libraries/
apache/recipes/
apache/recipes/default.rb
         628 100%   18.04kB/s    0:00:00 (xfer#2, to-check=1/12)
apache/templates/
apache/templates/default/

sent 1063 bytes  received 86 bytes  2298.00 bytes/sec
total size is 682  speedup is 0.59
</code></pre>

<ul>
<li>Installing new Site Cookbooks
  sending incremental file list
  README

<pre><code>        96 100%    0.00kB/s    0:00:00 (xfer#1, to-check=0/2)
</code></pre>

<p>  sent 178 bytes  received 31 bytes  418.00 bytes/sec
  total size is 96  speedup is 0.46</p></li>
<li>Installing new Chef Server Config</li>
<li>Installing new Chef Client Config</li>
</ul>


<h1>Chef クライアント のサーバへの登録</h1>

<p>Chef クライアントを動作させるためには、まずは Chef サーバへのノード登録が必要となります。手順は http://wiki.opscode.com/display/chef/Nodes#Nodes-RegistrationviatheWebUI の通りで、サーバの 4000 番ポートにブラウザでアクセスし、</p>

<ol>
<li>右上の「Login」をクリックして、OpenID でログインする</li>
<li>上部の「Registration」をクリックする</li>
<li>対象となるノードの「Validation」をクリックする</li>
</ol>


<p>で完了です。</p>

<p>ここで気になるのは、OpenID でログインするので、有効な OpenID アカウントさえ持っていれば、とりあえずログインできちゃうんですよね。なので、デフォルトで誰でもログインできちゃうような状態なんで、これはまずいだろ、と。</p>

<p>それから、<a href="http://wiki.opscode.com/display/chef/Nodes#Nodes-NodeshaveOpenIDs">Nodes have OpenIDs</a> のところを読むと、内部的に Chef サーバがノードを認証するための仕組みとしても OpenID を使っているみたいなんだけど、そのメリットとか意図がさっぱりわからない。</p>

<h1>cookbook を 作成して Chef クライアントに適用する</h1>

<p>サンプル cookbook の作成の仕方は、<a href="http://wiki.opscode.com/display/chef/Quick+Start">Quick Start</a> を参照すれば OK です。ここでは特に補足しません。</p>

<p>わかりにくいのが、作成した cookbook を特定のノードに適用する方法。Puppet だと以下のようなやつ。</p>

<pre><code>node 'client.example.org' {
    include apache
}
</code></pre>

<p>これには <a href="http://wiki.opscode.com/display/chef/Nodes#Nodes-ManagingNodesviatheWebUI">ウェブ UI を利用する方法</a> と <a href="http://wiki.opscode.com/display/chef/Nodes#Nodes-ManagingNodesthroughJSONatthecommandline">chef-client コマンドを利用する方法</a> があります。</p>

<p>ウェブ UI の方では、上部メニューの「Nodes」をクリックし、該当するノードを選択。するとノードに関する詳細情報が表示されるので、適当なところをクリック。すると、テキストエリアに以下のように JSON 形式で内容が表示されて編集可能に。</p>

<pre><code>{
  "name": "ubuntu",
  "_rev": "4279229607",
  "attributes": {
    "kernel": {
      "machine": "i686",
      "name": "Linux",
      "os": "GNU\/Linux",
      "version": "#1 SMP Thu Nov 20 21:57:00 UTC 2008",
      "release": "2.6.27-9-generic"
    },

    ... 中略 ...

    "uptime": "4 hours 56 minutes 03 seconds",
    "platform": "ubuntu",
    "block_device": {
      "ram13": {
        "size": "131072",
        "removable": "0"
      },

      ... 中略 ...

      "ram9": {
        "size": "131072",
        "removable": "0"
      }
    },
    "uptime_seconds": 17763
  },
  "json_class": "Chef::Node",
  "recipes": [

  ],
  "chef_type": "node"
}
</code></pre>

<p>この下のほうにある「recipes」ところに、適用したい cookbook を追加して、save すれば OK らしいのですが、うちの環境ではうまく save ができませんでした。</p>

<p>chef-client コマンドを使う方法では、</p>

<pre><code>$ sudo chef-client -j node.json
</code></pre>

<p>といった形で、JSON ファイルをロードできるようなのですが、この方法でもうまくいかず、結局試すことができませんでした。また後ほど環境作り直して再チャレンジの予定。</p>

<h1>まとめ</h1>

<p>ここまでざっと使ってみた感想をまとめてみます。</p>

<ul>
<li>セットアップがめんどくさい。Puppet は Ruby と Facter があれば OK なのに対し、Chef はいろいろなものが必要。特に CouchDB は、CentOS 5 用のパッケージがなく、パッケージ作るのも大変そうだったので、今回は諦めた。（誰かパッケージの在り処を知っていったら教えてください。）</li>
<li>OpenID をつかってる意味がよくわからない。誰か教えて。</li>
<li>ウェブ UI は必要ない。すべてコマンドラインで完結してくれるほうがうれしい。</li>
<li>Chef Repository の考え方ははよさげ。

<ul>
<li>Rakefile を覗いてみると、git と subversion に対応してるみたい。</li>
<li>rake コマンド で特定のタスクを実行できるのもいい。</li>
<li>git に対応してるのは、外部の人たちと cookbooks を共有するのに良さげ。ただ、システム管理者に git 使わせるのは厳しいかも。</li>
</ul>
</li>
<li>内部 DSL よりも外部 DSL の方が、制限がある分逆に誰が書いても同じような記述になるし、分かりやすいと思うので、特にメンテナンスや他メンバーとの共有を考えると、外部 DSL である Puppet の方が個人的には好き。</li>
</ul>


<p>今のところ、まだ Puppet からの乗換えを検討しようとは思わないけど、今後ウォッチしていこうと思います。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/03/21/SoftwareDesign200904/">Software Design200904</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-03-21T07:15:06+09:00" pubdate>Mar 21<span>st</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>宣伝エントリです。</p>

<p><a href="http://30d.jp/">30days Album</a> では 2009/3/10 から 2009/3/31 まで <a href="http://30d.jp/campaign/0903/">卒業おめでとうキャンペーン</a> やってます。<a href="http://fujifilmmall.jp/">フジフィルムモール</a>でのプリント料金が 20% OFF になるクーポンをプレゼントしてます。クーポンは期間中何回でも利用できます。</p>

<p>また、通常はアルバム作成後30日経過しないとダウンロードできない、オリジナルサイズ画像のアーカイブダウンロードが、期間中はいつでもダウンロード可能です。このために MogileFS のストレージノードを2台ほど追加しました。</p>

<p>それから、<a href="http://gihyo.jp/magazine/SD/archive/2009/200904">Software Design 2009年4月号</a> の第2特集『～サーバエンジニアがプログラムを知る意味～ システム運用／管理に役立つ「開発力」 ～楽天，mixi，paperboy&amp;co.の事例紹介！～』に寄稿しました。</p>

<p>第1章、第4章、第5章の一部、を担当してます。原稿料が入ったらダイソンの掃除機を買います。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/03/03/library-perl-trunk-FFmpeg-Command-lib-FFmpeg-Command.pm/">Library/Perl/Trunk/F Fmpeg Command/Lib/F Fmpeg/Command.Pm</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-03-03T22:58:20+09:00" pubdate>Mar 3<span>rd</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>source:library/perl/trunk/FFmpeg-Command/lib/FFmpeg/Command.pm</p>

<h1>NAME</h1>

<p>FFmpeg::Command - A wrapper class for ffmpeg command line utility.</p>

<h1>DESCRIPTION</h1>

<p>A simple interface for using ffmpeg command line utility.</p>

<h1>SYNOPSIS</h1>

<pre><code>    use FFmpeg::Command;

    my $ffmpeg = FFmpeg::Command-&gt;new('/usr/local/bin/ffmpeg');

    $ffmpeg-&gt;input_options({
        file =&gt; $input_file,
    });

    # Set timeout
    $ffmpeg-&gt;timeout(300);

    # Convert a video file into iPod playable format.
    $ffmpeg-&gt;output_options({
        file   =&gt; $output_file,
        device =&gt; 'ipod',
    });

    my $result = $ffmpeg-&gt;exec();

    croak $ffmpeg-&gt;errstr unless $result;

    # This is same as above.
    $ffmpeg-&gt;output_options({
        file                =&gt; $output_file,
        format              =&gt; 'mp4',
        video_codec         =&gt; 'mpeg4',
        bitrate             =&gt; 600,
        frame_size          =&gt; '320x240',
        audio_codec         =&gt; 'libaac',
        audio_sampling_rate =&gt; 48000,
        audio_bit_rate      =&gt; 64,
    });

    $ffmpeg-&gt;exec();


    # Convert a video file into PSP playable format.
    $ffmpeg-&gt;output_options({
        file  =&gt; $output_file,
        device =&gt; 'psp',
    });

    $ffmpeg-&gt;exec();

    # This is same as above.
    $ffmpeg-&gt;output_options({
        file                =&gt; $output_file,
        format              =&gt; 'psp',
        video_codec         =&gt; 'mpeg4',
        bitrate             =&gt; 600,
        frame_size          =&gt; '320x240',
        audio_codec         =&gt; 'libaac',
        audio_sampling_rate =&gt; 48000,
        audio_bit_rate      =&gt; 64,
    });

    $ffmpeg-&gt;exec();

    # Execute ffmpeg with any options you like.
    # This sample code takes a screnn shot.
    $ffmpeg-&gt;input_file($input_file);
    $ffmpeg-&gt;output_file($output_file);

    $ffmpeg-&gt;options(
        '-y',
        '-f'       =&gt; 'image2',
        '-pix_fmt' =&gt; 'jpg',
        '-vframes' =&gt; 1,
        '-ss'      =&gt; 30,
        '-s'       =&gt; '320x240',
        '-an',
    );

    $ffmpeg-&gt;exec();
</code></pre>

<h1>METHODS</h1>

<h2>new(&#8216;/usr/bin/ffmpeg&#8217;)</h2>

<p>Contructs FFmpeg::Command object.It takes a path of ffmpeg command. You can omit this argument and this module searches ffmpeg command within PATH environment variable.</p>

<h2>timeout()</h2>

<p>Set command timeout.Default is 0.</p>

<h2>input_options({ %options })</h2>

<p>Specify input file name and input options.(Now no options are available.)</p>

<p> file:: a file name of input file.</p>

<h2>output_options({ %options })</h2>

<p>Specify output file name and output options.</p>

<p>Avaiable options are:</p>

<p> file:: a file name of output file.
 format:: Output video format.
 video_codec:: Output video codec.
 bitrate:: Output video bitrate.
 frame_size:: Output video screen size.
 audio_codec:: Output audio code.
 audio_sampling_rate:: Output audio sampling rate.
 audio_bit_rate:: Output audio bit rate.
 title:: Set the title.
 author:: Set the author.
 comment:: Set the comment.</p>

<h2>input_file(&#8216;/path/to/inpuf_file&#8217;)</h2>

<p>Specify input file name using with options() method.</p>

<h2>output_file(&#8216;/path/to/output_file&#8217;)</h2>

<p>Specify output file name using with options() method.</p>

<h2>options( @options )</h2>

<p>Specify ffmpeg command options directly.</p>

<h2>execute()</h2>

<p>Executes ffmpeg comman with specified options.</p>

<h2>exec()</h2>

<p>An alias of execute()</p>

<h2>stdout()</h2>

<p>Get ffmpeg command output to stdout.</p>

<h2>stderr()</h2>

<p>Get ffmpeg command output to stderr.</p>

<h1>AUTHOR</h1>

<p>Gosuke Miyashita, <code>&lt;gosukenator at gmail.com&gt;</code></p>

<h1>BUGS</h1>

<p>Please report any bugs or feature requests to <code>bug-ffmpeg-command at rt.cpan.org</code>, or through the web interface at http://rt.cpan.org/NoAuth/ReportBug.html?Queue=FFmpeg-Command. I will be notified, and then you&#8217;ll automatically be notified of progress on your bug as I make changes.</p>

<h1>SUPPORT</h1>

<p>You can find documentation for this module with the perldoc command.</p>

<pre><code>    perldoc FFmpeg::Command
</code></pre>

<p>You can also look for information at:</p>

<ul>
<li>AnnoCPAN: Annotated CPAN documentation</li>
</ul>


<p> http://annocpan.org/dist/FFmpeg-Command</p>

<ul>
<li>CPAN Ratings</li>
</ul>


<p> http://cpanratings.perl.org/d/FFmpeg-Command</p>

<ul>
<li>RT: CPAN&#8217;s request tracker</li>
</ul>


<p> http://rt.cpan.org/NoAuth/Bugs.html?Dist=FFmpeg-Command</p>

<ul>
<li>Search CPAN</li>
</ul>


<p> http://search.cpan.org/dist/FFmpeg-Command</p>

<h1>ACKNOWLEDGEMENTS</h1>

<h1>COPYRIGHT &amp; LICENSE</h1>

<p>Copyright 2006 Gosuke Miyashita, all rights reserved.</p>

<p>This program is free software; you can redistribute it and/or modify it under the same terms as Perl itself.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/02/06/HowToRpmizeCpanModules/">How To Rpmize Cpan Modules</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-02-06T21:53:30+09:00" pubdate>Feb 6<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://wassr.jp/">Wassr</a> で <a href="http://d.hatena.ne.jp/ZIGOROu/">ZIGOROu さん</a> や <a href="http://blog.hide-k.net/">hidek さん</a> とやりとりした内容をまとめてみます。</p>

<p>CPAN モジュールの rpm パッケージ作成なんですが、自分は<a href="http://search.cpan.org/dist/RPM-Specfile/">RPM::Specfile</a> に付属している、cpanflute2 を基本的に使ってます。</p>

<p><a href="http://perl.arix.com/cpan2rpm/">cpan2rpm</a> の方がメジャーだとは思うんですが、オリジナルのダウンロード用FTPサイトが接続できないのと、吐き出す SPEC ファイルが微妙な感じがするので、なんとなくイヤで使ってないんですが、それ以外はそんなに明確な理由もなく、cpanflute2 の方を使ってます。</p>

<p>ただ、cpanflute2 には以下の問題点があります。</p>

<ul>
<li>依存関係を自動的に解決してくれない（これは cpan2rpm も同じ）</li>
<li>モジュールの tar ball を自分で取得しないといけない（cpan2rpm はsearch.cpan.org から取得してくれる）</li>
</ul>


<p>なので、<a href="http://gist.github.com/59314">cpanflute2_wrapper.pl</a> といったラッパースクリプトを書いて使ってます。これを使うと、</p>

<pre><code>$ cpanflute2_wrapper.pl --buildall Catalyst::Runtime
</code></pre>

<p>みたいに実行すると、Catalyt::Runtime とそれに依存するモジュールの srpm と rpm を「半自動」で全部作ってくれます。&#8211;buildall とかのオプションは、中で呼び出される cpanflute2 にそのまま渡されます。</p>

<p>「半自動」と言ってるのは、スクリプトがいろいろとイケてなくて、場合によっては途中でこけてるのを目視で確認して、依存関係を自分で解決しないといけない時があったりするからです。あと、エラー処理やエラーメッセージもイケてなくてわかりにくかったり、ということもあって、今まで公開してなかったんですが、Wassr の流れで gist にスクリプト貼り付けちゃったので、ここでまとめてみることにしました。</p>

<p>他にも注意点があって、まずは rpmbuild の問題。rpmbuild でパッケージを作る際に、use/require してるモジュールがすべて勝手に SPEC ファイルのRequires に含まれてしまう、という問題があります。eval しているモジュールは依存関係の対象とはならないが、以下のように複数行にまたがっていると、依存関係の対象になってしまう。</p>

<pre><code>eval {
    require 'Hoge';
}
</code></pre>

<p>そのせいで、Linux 上でビルドしてるのに、Requires に Win32::*** が含まれる、ということがあったりします。で、Requires に含まれないようにするためには、/usr/lib/rpm/perl.req を以下のように修正します。（cpanflute2 が Makefile.PL を見て Requires に加えてくれるので、rpmbuild で Requires の処理してる部分はコメントアウトしちゃう。）</p>

<pre><code>#!diff
--- /usr/lib/rpm/perl.req.org   2008-01-31 19:21:31.000000000 +0900
+++ /usr/lib/rpm/perl.req       2008-01-31 19:21:41.000000000 +0900
@@ -221,8 +221,8 @@

       ($module  =~ m/\.ph$/) &amp;&amp; next;

-      $require{$module}=$version;
-      $line{$module}=$_;
+      #$require{$module}=$version;
+      #$line{$module}=$_;
     }

   }
</code></pre>

<p>それから、cpanflute2自体に問題があって、以下のパッチをあてておく必要がある。</p>

<pre><code>#!diff
--- cpanflute2.org      2008-02-26 12:20:28.000000000 +0900
+++ cpanflute2  2008-02-26 12:21:15.000000000 +0900
@@ -159,10 +159,12 @@
       my $yaml = Load($contents);

       while (my ($mod, $ver) = each %{$yaml-&gt;{build_requires}}) {
-       push @build_requires, [ "perl($mod)", $ver ];
+        $mod = "perl($mod)" if $mod ne 'perl';
+       push @build_requires, [ "$mod", $ver ];
       }
       while (my ($mod, $ver) = each %{$yaml-&gt;{requires}}) {
-       push @requires, [ "perl($mod)", $ver ];
+        $mod = "perl($mod)" if $mod ne 'perl';
+       push @requires, [ "$mod", $ver ];
       }
     }

@@ -289,12 +291,7 @@
 my $makefile_pl = qq{CFLAGS="\$RPM_OPT_FLAGS" %{__perl} Makefile.PL &lt; /dev/null};
 my $make_install = qq{make pure_install PERL_INSTALL_ROOT=\$RPM_BUILD_ROOT};

-if ($use_module_build) {
-  $makefile_pl = qq{CFLAGS="\$RPM_OPT_FLAGS" %{__perl} Makefile.PL destdir=\$RPM_BUILD_ROOT $installdirs &lt; /dev/null};
-}
-else {
-  $makefile_pl = qq{CFLAGS="\$RPM_OPT_FLAGS" %{__perl} Makefile.PL $installdirs};
-}
+$makefile_pl = qq{CFLAGS="\$RPM_OPT_FLAGS" %{__perl} Makefile.PL $installdirs};

 $spec-&gt;build(&lt;&lt;EOB);
 $makefile_pl
</code></pre>

<p>前半の修正は、Makefile.PL の PREREQ_PM とか requires とかに perl が含まれていると、SPEC ファイルの Requires に perl(perl) とか入っちゃっておかしなことになるので、そうならないように修正。</p>

<p>後半の修正は、なんで修正したかあまり覚えてないんだけど、時々 RPM_BUILD_ROOT がおかしくなることがあって、それに対する修正だったと思う。</p>

<p>そういえば、<a href="http://d.hatena.ne.jp/stanaka/20070728/1185605498">まっさらなサーバを30分で本番投入できるようにする</a> で stanaka さんが「CPANの依存関係を解析してrpm化する手製スクリプトで、CPANモジュールのrpm化が、ほぼ自動化されています」と書いてるんだけど、これって公開してくれないのかなー。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/01/13/SetupRemedie/">Setup Remedie</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2009-01-13T14:05:45+09:00" pubdate>Jan 13<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>overlast さんの<a href="http://overlasting.dyndns.org/2009-01-07-1.html">これから15分で Remedie を始めるための資料</a> に触発されて書いてみました。こっちは CPAN モジュールをインストールする時間も入れて15分。ただし限定された環境のみ。</p>

<p>Remedie 用に CPAN モジュールの RPM パッケージ作ったので、これプラス Puppet を利用します。ただし、RPM パッケージを CentOS 5 x86_64 でビルドしてるので、この環境限定。<a href="http://svn.mizzy.org/public/yum/SRPMS/">SRPM</a> はあるので、他の環境の方はこいつをビルドして使ってください。</p>

<p>まずは Puppet をインストールするための yum リポジトリ設定。以下の内容で /etc/yum.repos.d/dlutter.repo を作成。</p>

<pre><code>[dlutter]
name=lutter
baseurl=http://people.redhat.com/dlutter/yum/rhel/$releasever/$basearch/
enabled=1
gpgcheck=0
</code></pre>

<p>Puppet のインストール。</p>

<pre><code># yum -y install puppet-server
</code></pre>

<p>Puppet で署名するのはだるいので、以下の内容で /etc/puppet/autosign.conf を作成。</p>

<p>*</p>

<p>/etc/puppet/manifests ディレクトリを作成。</p>

<pre><code># mkdir /etc/puppet/manifests
</code></pre>

<p>以下の内容の /etc/puppet/manifests/site.pp を作成。</p>

<pre><code>node default {

  yumrepo {
    'mizzy':
      baseurl  =&gt; 'http://svn.mizzy.org/public/yum/RPMS/centos/$releasever/$basearch/',
      enabled  =&gt; 1,
      gpgcheck =&gt; 0;
    'dag':
      baseurl  =&gt; 'http://ftp.riken.jp/Linux/dag/redhat/el$releasever/en/$basearch/dag/',
      enabled  =&gt; 1,
      gpgcheck =&gt; 0;
    'updates':
      exclude =&gt; 'perl';
    'extras':
      exclude =&gt; 'perl';
  }

  Package {
    require =&gt; [ Yumrepo['mizzy'], Yumrepo['dag'], Yumrepo['updates'], Yumrepo[extras] ],
  }  

  package {
    'git':
      ensure =&gt; present;
    'perl':
      ensure =&gt; '5.8.8-15.1';
    'perl-Moose':
      ensure =&gt; present;
    'perl-Class-C3':
      ensure =&gt; present;
    'perl-Sub-Name':
      ensure =&gt; present;
    'perl-Devel-GlobalDestruction':
      ensure =&gt; present;
    'perl-Rose-DB':
      ensure =&gt; present;
    'perl-Rose-DB-Object':
      ensure =&gt; present;
    'perl-DateTime-TimeZone':
      ensure =&gt; '0.8301-8';
    'perl-MooseX-Types-Path-Class':
      ensure =&gt; present;
    'perl-DBD-SQLite':
      ensure =&gt; present;
    'perl-FindBin-libs':
      ensure =&gt; present;
    'perl-HTTP-Engine':
      ensure =&gt; present;
    'perl-MIME-Types':
      ensure =&gt; present;
    'perl-Path-Class-URI':
      ensure =&gt; present;
    'perl-String-CamelCase':
      ensure =&gt; present;
    'perl-Log-Dispatch':
      ensure =&gt; present;
    'perl-JSON-XS':
      ensure =&gt; present;
    'perl-MooseX-Getopt':
      ensure =&gt; present;
    'perl-MooseX-ConfigFromFile':
      ensure =&gt; present;
    'perl-File-Find-Rule':
      ensure =&gt; present;
    'perl-UNIVERSAL-require':
      ensure =&gt; present;
    'perl-Class-Accessor':
      ensure =&gt; present;
    'perl-DateTime-Format-Strptime':
      ensure =&gt; present;
    'perl-Feed-Find':
      ensure =&gt; present;
    'perl-Class-ErrorHandler':
      ensure =&gt; present;
    'perl-XML-Atom':
      ensure =&gt; present;
    'perl-XML-XPath':
      ensure =&gt; present;
    'perl-XML-Feed':
      ensure =&gt; present;
    'perl-Template-Toolkit':
      ensure =&gt; present;
    'perl-DateTime-Format-ISO8601':
      ensure =&gt; present;
    'perl-MooseX-ClassAttribute':
      ensure =&gt; present;
    'perl-XML-OPML-LibXML':
      ensure =&gt; present;
    'perl-File-Find-Rule-Filesys-Virtual':
      ensure =&gt; present;
    'perl-HTTP-Response-Encoding':
      ensure =&gt; present;
    'perl-HTML-ResolveLink':
      ensure =&gt; present;
    'perl-HTML-Selector-XPath':
      ensure =&gt; present;
    'perl-HTML-TreeBuilder-XPath':
      ensure =&gt; present;
    'perl-YAML':
      ensure =&gt; present;
    'perl-YAML-Syck':
      ensure =&gt; present;
    'perl-HTML-Scrubber':
      ensure =&gt; present;
    'perl-Image-Info':
      ensure =&gt; present;
    'perl-Text-Tags':
      ensure =&gt; present;
    'perl-XML-RSS-LibXML':
      ensure =&gt; present;
    'perl-Web-Scraper':
      ensure =&gt; present;
  }

}
</code></pre>

<p>puppetmasterd を起動。</p>

<pre><code># puppetmasterd --verbose --no-daemonize
</code></pre>

<p>puppetd を起動して、マニフェストを適用。注意点としては、localhost とかではなく、きちんと FQDN で指定すること。（puppetmasterd 初回起動時に自動作成される証明書中の CN と &#8211;server で指定するサーバ名が一致してないと怒られる。）</p>

<pre><code># puppetd --server host.example.org --verbose --no-daemonize
</code></pre>

<p>このままログを見ながらしばらく待つ。完了したら Remedie を github.com から取得して起動。</p>

<pre><code># git clone git://github.com/miyagawa/remedie.git
# cd remedie
# perl -Ilib -MRemedie::DB::Schema -e 'Remedie::DB::Schema-&gt;install'
# ./bin/remedie-server.pl
</code></pre>

<p>自分でやったら10分ぐらいで終わった。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/9/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/7/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/03/31/puppet-report-ikachan/">puppet-report-ikachan</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/07/image-with-exif-tag-plugin/">Image with EXIF tag plugin</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/07/exif-tag-plugin/">EXIF tag plugin</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/04/rakuten-tag-plugin/">Rakuten tag plugin for Jekyll</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/29/paperboys-engineer-evaluation-system/">Paperboy&#8217;s engineer evaluation system</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Coderwall</h1>
  <p>
  <script type="text/javascript">
    function display_coderwall(args) {
        var badges = args["data"]["badges"];
        for ( var i = 0; i < badges.length; i++ ) {
            document.write('<img src="'+ badges[i]["badge"] + '" width="48" height="48" />');
        }
    }
  </script>
  <script src="http://coderwall.com/mizzy.json?callback=display_coderwall"></script>
  </p>
  <p style="text-align: right;"><a href="http://coderwall.com/mizzy">Powered by coderwall.com</a></p>
</section>


<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/mizzy">@mizzy</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'mizzy',
            count: 30,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>




  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Gosuke Miyashita -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mizzyorg';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
