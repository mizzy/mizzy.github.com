
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>mizzy.org</title>
  <meta name="author" content="Gosuke Miyashita">

  
  <meta name="description" content="このエントリ の様な経緯で、うちでは apache + tracd という構成で trac を動かしてるのですが、tracd がしょっちゅう落ちるんですよね。1日に2, 3回ぐらいは落ちる感じ。で、5分ごとに cron で tracd プロセスを監視して、 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mizzy.org/blog/page/26">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="mizzy.org" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-53984-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">mizzy.org</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mizzy.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/05/17/417/">Trac を Lighttpd + FastCGI で動かす</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2006-05-17T23:40:00+09:00" pubdate>May 17<span>th</span>, 2006</time>
        
         | <a href="/blog/2006/05/17/417/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="entryBody">
<a href="http://mizzy.org/program/trac.html" target="_blank">このエントリ</a> の様な経緯で、うちでは apache + tracd という構成で trac を動かしてるのですが、tracd がしょっちゅう落ちるんですよね。1日に2, 3回ぐらいは落ちる感じ。で、5分ごとに cron で tracd プロセスを監視して、落ちてたら再起動ってなことをやってるんですが、<a href="http://unknownplace.org/memo/" target="_blank">typester さん</a> から「うちは lighttpd + FastCGI でやってるよ」というアドバイスを頂いたので、試してみました。
</p>




<p class="entryBody">
やったことは以下の通り。
</p>




<ol class="entryBody">
<li>FastCGI のインストール</li>
<li>lighttpd のインストール</li>
<li>lighttpd.conf を書く</li>
<li>lighttpd の起動</li>
</ol>




<p class="entryBody">
1, 2 については省略。ディストリビューションによって違うでしょうし、うちは Slackware だからあんまり参考にならないだろうし。3 については以下の様な内容の /usr/local/etc/lighttpd.conf を作成した。
</p>




<pre class="code">
server.modules              = (
                               "mod_fastcgi",
                              )
server.document-root        = "/home/miya/html"
server.errorlog             = "/var/log/lighttpd.error.log"
mimetype.assign             = (
  ".png"          =>      "image/png",
 )
static-file.exclude-extensions = ( ".fcgi" )
server.port                = 81
server.bind                = "localhost"
server.username            = "svn"
server.groupname           = "svn"
fastcgi.server = ("/public" =>
                   ("public" =>
                     ("socket" => "/tmp/trac-fastcgi.sock",
                      "bin-path" => "/usr/local/share/trac/cgi-bin/trac.fcgi",
                      "check-local" => "disable",
                      "bin-environment" =>
                        ("TRAC_ENV" => "/home/miya/trac/public")
                     )
                   )
</pre>




<p class="entryBody">
たったこれだけの設定でちゃんと動きました。起動は以下のコマンドで。
</p>




<pre class="code">
$ sudo /usr/local/sbin/lighttpd -f /usr/local/etc/lighttpd.conf
</pre>




<p class="entryBody">
あとは apache の設定を変更してやれば OK。<a href="http://trac.mizzy.org/public/" target="_blank">こんな感じで</a> 動いてます。
</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/05/17/312/">Mod_rpaf よりも Mod_extract_forwarded</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2006-05-17T09:54:00+09:00" pubdate>May 17<span>th</span>, 2006</time>
        
         | <a href="/blog/2006/05/17/312/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="entryBody">
リバースプロキシな環境では <a href="http://stderr.net/apache/rpaf/" target="_blank">mod_rpaf</a> 使ったりすることが多いと思いますが、バックエンドの apache でアクセス制限かける場合には、<a href="http://www.openinfo.co.uk/apache/index.html">mod_extract_forwarded</a> を使ったほうが良いよ、というお話。
</p>




<p class="entryBody">
バックエンドの apache 2.0 + mod_rpaf な環境で .htaccess によるアクセス制限をかけようとしても、接続元の IP アドレスではなく、pound の IP アドレスで制限がかかってしまう、という現象に悩まされました。で、ソースを眺めてみると mod_rpaf は ap_hook_post_read_request で実行されているのに対し、mod_access は ap_hook_access_checker で実行されています。おそらく、ap_hook_post_read_request よりも ap_hook_access_checker が先に実行されてしまい、mod_rpaf によるアドレス書き換え前にアクセス制限が実行されてしまう、ということなのでしょう、たぶん。（<a href="http://httpd.apache.org/docs/2.2/ja/developer/modules.html" target="_blank">「モジュールの Apache 1.3 から Apache 2.0 への移植」</a> にモジュールのフックステージ一覧があるのですが、実行される順番は不明。apache のソース軽く眺めても、いくつかのファイルに分散しててよくわからんかった。）
</p>




<p class="entryBody">
で、mod_rpaf のソース書き換えて、フックする場所変えればいいんじゃね、と思いつつ試してみるも、思った通りの動作をせずに悩んでいたところ、弊社のサーバエンジニアの方が、mod_extract_forwarded を見つけてきてくれました。
</p>




<p class="entryBody">
これを試してみたところ、ちゃんと pound ではなく接続元の IP アドレスで制限がかかってくれました。
</p>




<p class="entryBody">
mod_extract_forwarded のソースを眺めてみると、ap_hook_post_read_request, ap_hook_translate_name, ap_hook_access_checker の3つのフックステージで何やらごにょごにょやっている様子。特に、mod_access の場合は、
</p>




<pre class="code">
ap_hook_access_checker(check_dir_access,NULL,NULL,<strong>APR_HOOK_MIDDLE</strong>);
</pre>




<p class="entryBody">
と同じ ap_hook_access_checker の APR_HOOK_MIDDLE で実行されてるのに対し、mod_extract_forwarded では
</p>




<pre class="code">
ap_hook_access_checker(mef_access_check, NULL, NULL, <strong>APR_HOOK_FIRST</strong>);
</pre>




<p class="entryBody">
といった感じで APR_HOOK_FIRST で実行されてたりするので、この辺がポイントなのかな、とあまりソース読めないなりに理解しました。
</p>




<p class="entryBody">
ためしたのは .htaccess だけですが、おそらく httpd.conf でアクセス制限かける場合でも同じなのではないかと。
</p>




<p class="entryBody">
<s>また、 apache 2.2 では mod_access ではなく mod_authz_host ですが、フックしているところは mod_access と全く同じなので、たぶん 2.2 でも同じことでしょう。</s> <a href="http://d.hatena.ne.jp/dayflower/20060603/1149314379" target="_blank">2.2 ではそのままでは動かないそうです。</a> その他にも色々注意点があり大変参考になります。<a href="http://d.hatena.ne.jp/dayflower/" target="_blank">id:dayflower さん</a>、ありがとうございます。
</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/05/13/296/">Plagger と YouTube #2</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2006-05-13T07:44:00+09:00" pubdate>May 13<span>th</span>, 2006</time>
        
         | <a href="/blog/2006/05/13/296/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="entryBody">
今回のネタは、最近はやりの YouTube 動画をダウンロード、変換して iPod につっこむ、を Plagger で自動化する、というものです。ゴールデンウィーク中にプラグイン作ってたのですが、<a href="http://wiki.shibuya.pl/?PlaggerConference" target="_blank">Plagger Conference</a> のライトニングトークネタとして暖めていました。以下のことが可能です。
</p>




<ul class="entryBody">
<li>指定の検索/ソート条件で YouTube から動画ファイルを取得</li>
<li>取得した動画を PSP または iPod 用に変換</li>
<li>iPod 用に変換した場合は iTunes へファイルを登録</li>
<li>または、Publish::PodCast で PodCast 用 RSS フィードを吐き出し、iTunes で取り込む</li>
</ul>




<p class="entryBody">
もう少し詳しい説明は、 <a href="http://mizzy.org/archives/plagger_con/plagger.html" target="_blank">カンファレンスの資料</a> をご参照ください。資料で紹介したプラグインは以下から取得できます。(資料は一部発表したものから削ってます。)
</p>




<ul class="entryBody">
<li><strike><a href="http://trac.mizzy.org/public/browser/plagger/trunk/lib/Plagger/Plugin/CustomFeed/YouTube.pm" target="_blank">CustomFeed::YouTube</a></strike></li>
<li><strike><a href="http://trac.mizzy.org/public/browser/plagger/trunk/lib/Plagger/Plugin/Filter/ConvertVideo.pm" target="_blank">Filter::ConvertVideo</a></strike></li>
<li><strike><a href="http://trac.mizzy.org/public/browser/plagger/trunk/lib/Plagger/Plugin/Publish/PodCast.pm" target="_blank">Publish::PodCast</a></strike></li>
</ul>




<p class="entryBody">
<strike>ただし、Filter::ConvertVideo で実行する動画変換コマンドは <a href="http://trac.mizzy.org/public/browser/plagger/trunk/assets/plugins/Filter-ConvertVideo" target="_blank">assets</a> に分離してあるので、以下の様に svn でまとめて取得しちゃう方が楽です。</strike>
</p>




<pre class="code">
<strike>svn co http://svn.mizzy.org/public/plagger/trunk plagger</strike>
</pre>




<p class="entryBody">
<strong>2006/05/13 7:40 追記</strong><br />
Plagger core での enclosure 対応に伴い、CustomFeed::YouTube は宮川さんによるブラッシュアップを経て本家 trunk にマージされました。また、Publish::PodCast は 本家 trunk の Publish::Feed に吸収されましたので、その役目を終えました。ですのでこれらのプラグインは、ここから取得せずに、<a href="http://plagger.org/" target="_blank">Plagger 本家</a> から取得して下さい。
</p>




<p class="entryBody">
今のところ動画取得用の Plagger プラグインは、<a href="http://trac.mizzy.org/public/browser/plagger/trunk/lib/Plagger/Plugin/CustomFeed/GoogleVideo.pm" target="_blank">CustomFeed::GoogleVideo</a> と 上にある CustomFeed::YouTube しかないのですが、今後色々増えてくんじゃないでしょうか。
</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/04/30/259/">Plagger と YouTube #1</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2006-04-30T00:41:00+09:00" pubdate>Apr 30<span>th</span>, 2006</time>
        
         | <a href="/blog/2006/04/30/259/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="entryBody">
YouTube の HTML が変更されていたので、<a href="http://trac.mizzy.org/public/browser/plagger/trunk/lib/Plagger/Plugin/CustomFeed/YouTube.pm" target="_blank">Plagger::Plugin::CustomFeed::YouTube</a> を修正。ついでに以下の機能もつけました。
</p>




<ul class="entryBody">
<li>取得する検索結果ページ数を指定できるようにした。（デフォルトは1ページ。）</li>
<li>ソート条件を指定できるようにした。（デフォルトはアップロード日時。）</li>
</ul>




<p class="entryBody">
<a href="http://wiki.shibuya.pl/?PlaggerConference" target="_blank">Plagger Conference</a> のライトニングトークで、「Plagger &amp; YouTube（仮）」というお題でしゃべります。もちろん、CustomFeed::YouTube のことだけ話してもおもしろくないので、これ以上のことを考えてます。お楽しみに。
</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/04/30/333/">Plagger と YouTube #0</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2006-04-30T00:25:00+09:00" pubdate>Apr 30<span>th</span>, 2006</time>
        
         | <a href="/blog/2006/04/30/333/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="entryBody">
宣言どおり、<a href="http://trac.mizzy.org/public/browser/plagger/trunk/lib/Plagger/Plugin/CustomFeed/YouTube.pm" target="_blank">Plagger::Plugin::CustomFeed::YouTube</a> を作成しました。野良プラグインとして転がしときます。Publish::Gmail との組み合わせで以下の様になります。
</p>




<p class="entryBody">
<a href="http://mizzy.org/img/youtube_plagger.jpg" target="_blank"><img src="http://mizzy.org/img/youtube_plagger_t.jpg" /></a>
</p>




<p class="entryBody">
YouTube はタグ別に RSS を吐いているのですが、検索結果は RSS にはなっていません。なので、config.yaml でタグか検索かを選べるようにして、処理を分けています。また、検索クエリは UTF-8 で指定すれば日本語でも OK です。
</p>




<p class="entryBody">
特定のキーワードやタグで YouTube をウォッチしたい方は、これを使うと良いかもしれませんね。ふと思いついたキーワードで検索したり、他の人がどういったキーワードで検索しているか知りたいなど、偶然の出会いを求める場合には、<a href="http://solvalou.net/" target="_blank">オオヒダさん</a> 開発の <a href="http://video.qooqle.jp" target="_blank">Qooqle Video</a> が最高です。
</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/04/23/416/">やじうま Watch と Plagger</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2006-04-23T22:47:00+09:00" pubdate>Apr 23<span>rd</span>, 2006</time>
        
         | <a href="/blog/2006/04/23/416/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="entryBody">
既に誰かが作ってそうだと思ったけど、見つからなかったので作ってみた。<a href="http://trac.mizzy.org/public/browser/plagger/trunk/lib/Plagger/Plugin/CustomFeed/YajiumaWatch.pm" target="_blank">Plagger::Plugin::CustomFeed::YajiumaWatch</a>
</p>




<p class="entryBody">
プログラム内の文字コードが UTF-8 だと、正規表現でうまくマッチしなかったので、無理やり euc-jp で。なので encode/decode しまくりでコード汚いです。誰かがきれいに書き直してくれることを期待。正規表現と文字エンコーディングって苦手…
</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/04/21/331/">JugemKey リリース</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2006-04-21T17:32:00+09:00" pubdate>Apr 21<span>st</span>, 2006</time>
        
         | <a href="/blog/2006/04/21/331/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="entryBody">
<a href="http://jugemkey.jp" target="_blank">JugemKey</a> がリリースされました。現在はペパボの一部サービスのみ対応ですが、今後認証 API を実装してサードパーティアプリから利用できるようにすることを目論んでます。たぶん Flickr ライクな API になると思います。
</p>




<p class="entryBody">
サービス名は TypeKey インスパイヤです。もともとは Jugem 1iD という名称だったのですが大人の事情により使えない、また、パスポートという名称も使えない、ということで「似たようなサービスで ID もパスポートも使ってないものだと、TypeKey がありますね。」とボソっと言ったところ、JugemKey に決まってしまいました。パクリではなくオマージュということでご理解頂けると幸いです。
</p>




<p class="entryBody">
今後認証 API を実装ということで、JugemKey の管理画面に、開発者向けの APIキーや shared secret の発行/管理ページ、ユーザが利用するサードパーティアプリの管理ページなどが増えることになるかと思います。また、認証 API をうまく利用して、シングルサインオン的なこともできるようにしたいと考えています。
</p>




<p class="entryBody">
そして、PAIPO READER 再構築も視野にいれつつ、フィード API の公開も予定しています。もうほとんど実装は済んでいるので、認証 API の実装と社内でのテスト完了後にリリースすることになるかと思います。
</p>




<p class="entryBody">
ちなみに認証やフィードの API は、Perl + Catalyst で開発しています。
</p>




<p class="entryBody">
あと、PAIPO READER の方も、Plagger と組み合わせておもしろいことができるんじゃないかな、と目論んでたりします。
</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/04/15/356/">コトノハ と Plagger</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2006-04-15T18:00:00+09:00" pubdate>Apr 15<span>th</span>, 2006</time>
        
         | <a href="/blog/2006/04/15/356/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="entryBody">
<a href="http://kotonoha.cc" target="_blank">コトノハ</a> の Inbox を取得する Plagger プラグインを <a href="http://trac.mizzy.org/public/browser/plagger/trunk/lib/Plagger/Plugin/CustomFeed/KotonohaInbox.pm" target="_blank">作ってみました</a>。
</p>




<p class="entryBody">
例によってビジュアル的にわかりやすい Publish::Gmail してみたときのイメージです。
</p>




<p class="entryBody">
<a href="http://mizzy.org/img/kotonoha_plagger.jpg" target="_blank"><img src="http://mizzy.org/img/kotonoha_plagger_t.jpg" /></a>
</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/04/14/421/">Shibuya.js Technical Talk 行けませんでした…</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2006-04-14T23:47:00+09:00" pubdate>Apr 14<span>th</span>, 2006</time>
        
         | <a href="/blog/2006/04/14/421/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="entryBody">
こんな大事な日に限って仕事でおおはまり。普段は早く帰れてるのに。行きたくても応募が締め切られて行けなかった方々に大変申し訳ないです。
</p>




<p class="entryBody">
もっとはやく残業することがわかっていれば、別の人に代わりに行ってもらえたのですが、なかなか終る時間が読めずに、「何とか間に合うかな？」「ちょっと遅れるけど行けそうかな？」「懇親会ぐらいは行けそうかな？」「ああ、やっぱ無理」といった感じでした。
</p>




<p class="entryBody">
<a href="http://d.hatena.ne.jp/secondlife/" target="_blank">id:secondlife</a> さんにも、<a href="http://solvalou.net/" target="_blank">オオヒダさん</a> を通じて懇親会に誘って頂いていたのですが、参加できなくて大変申し訳ありません。YAPC 懇親会での約束通り、ランチ行きましょうね。社交辞令にはさせませんよ！MSN Messenger のアドレスは <a href="http://search.cpan.org/~mizzy/" target="_blank">CPAN に登録しているアドレス</a> ですので、ぜひぜひご連絡ください。
</p>




<p class="entryBody">
近々新サービスがリリースされるのでしかたがないと言えばしかたないのですが、昨日の段階では自分の担当分はほとんど終っていて、余裕で行けるなって思ってたんですよ。ところが今日になって急な仕様追加があったり、トラブル対応に追われたり、自分の担当はサービスのバックエンドで perl でコーディングしてたのですが、上司から「フロント部分やってみない？」と言われてPHPデビューしたり、といった感じでした。
</p>




<p class="entryBody">
そう、新サービスがリリースされるんですよ。ペパボに入ってから裏側のことばかりやってたのですが、自分が関わったプロジェクトがはじめて日の目を見ることになります。（とかいって作ってるのはやっぱりバックエンドという日陰の部分なのですが。）最近リリースされた、<a href="http://heteml.jp/" target="_blank">ヘテムル</a>、 <a href="http://grouptube.jp/" target="_blank">グルチュ</a>、<a href="http://calamel.jp/" target="_blank">カラメル</a>、<a href="http://chicappa.jp/" target="_blank">チカッパ</a> なんかと比べると、ややインパクトに欠けるかもしれませんが、今後展開していくサービスの基盤でもあり布石でもあるので、みなさん期待していて下さい。（とか言って自分にプレッシャーをかけてみる。） 内容については間もなくプレスリリースで発表されると思います。
</p>




<p class="entryBody">
で、タイトルの Shibuya.js Technical Talk から全然関係ない話になってしまいましたが、言いたかったことは id:secondlife さんランチ行きましょう、ってことです。
</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/04/05/278/">Plagger::Plugin::Filter::Amazon</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2006-04-05T21:19:00+09:00" pubdate>Apr 5<span>th</span>, 2006</time>
        
         | <a href="/blog/2006/04/05/278/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="entryBody">
<a href="http://trac.mizzy.org/public/browser/plagger/trunk/lib/Plagger/Plugin/Filter/Amazon.pm" target="_blank">P::P::Filter::Amazon</a> を作ってみました。<a href="http://mizzy.org/program/iTunesRecentPlay01.html" target="_blank">以前 CustomFeed::iTunesRecentPlay に Amazon Web Service からの情報取得機能をつけた</a> のですが、宮川さんから「Filter でやったほうがよい」というコメントを頂きましたので、Filter プラグインとして分離しました。
</p>




<p class="entryBody">
Amazon から情報を取得して、entry に link, icon, summary をセットします。
</p>




<p class="entryBody">
設定はこんな感じになります。
</p>




<pre class="code">
  - module: Filter::Amazon
    config:
      keywords:
        - title
        - meta: artist
        - meta: album
      associate_id: xxxxxxx-22
      developer_token: XXXXXXXXXXXXXXXXXXXX
      locale: jp
      mode: music
</pre>




<p class="entryBody">
上の設定だと、$entry-&gt;title, $entry-&gt;meta-&gt;{artist}, $entry-&gt;meta-&gt;{album} を検索キーワードとします。
</p>




<p class="entryBody">
この検索キーワード指定のフォーマットには、少し悩みました。このフォーマットだと、<a href="http://trac.mizzy.org/public/browser/plagger/trunk/lib/Plagger/Plugin/CustomFeed/GoogleVideo.pm" target="_blank">CustomFeed::GoogleVideo</a> や <a href="http://trac.mizzy.org/public/browser/plagger/trunk/lib/Plagger/Plugin/CustomFeed/YouTube.pm" target="_blank">CustomFeed::YouTube</a> で使われている様な、$entry->meta->{enclosure}->{url} といった深いハッシュには対応できないのですが、特殊なケースだと思うので、とりあえず考えないことにしました。
</p>




<p class="entryBody">
あと悩んだのは名称ですね。Filter::Amazon にするか、 Filter::AWS にするか、 Filter::AmazonWebService にするか。とりあえず Net::Amazon に合わせてみました。
</p>




<p class="entryBody">
<strong>追記</strong><br />
IRC で宮川さんからアドバイス頂いたのでメモ。
</p>




<ul class="entryBody">
<li>Filter::AmazonWebService に名称を変える。</li>
<li>検索ワードは config.yaml で設定せずに、Filter::AWS で制約を設けて、metadata を見るようにする。music, books などの mode も metadata に入れる。</li>
<li>曲名を入れて検索するとヒットしないことがあるので、その場合は曲名を抜いて検索しなおす。</li>
</ul>




<p class="entryBody">
<strong>更に追記</strong><br />
<a href="http://trac.mizzy.org/public/browser/plagger/trunk/lib/Plagger/Plugin/Filter/AmazonWebService.pm" target="_blank">P::P::Filter::AmazonWebService</a> として作り直した。まだ音楽のみ対応。
</p>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/27/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/25/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2011/11/05/maglica-web/">Maglica Web</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/10/30/vimeo-tag-plugin/">Vimeo tag plugin</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/10/29/typo-to-octopress/">Typo to Octopress</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/10/21/twan-tag-plugin/">TWAN tag plugin for Jekyll</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/10/17/first-post/">自宅サーバが死にました</a>
      </li>
    
  </ul>
</section>




  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011 - Gosuke Miyashita -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mizzyorg';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
