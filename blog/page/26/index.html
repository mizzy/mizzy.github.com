
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Gosuke Miyashita</title>
  <meta name="author" content="Gosuke Miyashita">

  
  <meta name="description" content="typester さんが NEXT やめやめ。
なんもうれしいことない。
plagger の hook 機構をぱくろう。そうしよう。
from: CLON - 2006/05/04 - Plugin とおっしゃっていたので、plagger の hook 機構を catlxom &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mizzy.org/blog/page/26">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Gosuke Miyashita" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-53984-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Gosuke Miyashita</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mizzy.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/06/04/357/">Catlxom の プラグイン機構 (Catlxom メモ #4)</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2006-06-04T18:47:00+09:00" pubdate>Jun 4<span>th</span>, 2006</time>
        
         | <a href="/blog/2006/06/04/357/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="entryBody">
typester さんが
</p>




<blockquote>
NEXT やめやめ。<br />
なんもうれしいことない。<br />
plagger の hook 機構をぱくろう。そうしよう。<br />
<cite>from: <a href="http://unknownplace.org/memo/2006/05/04#e001" target="_blank">CLON - 2006/05/04 - Plugin</a></cite>
</blockquote>




<p class="entryBody">
とおっしゃっていたので、plagger の hook 機構を catlxom に組み込むとどんな感じになるのかなー、といきなりコードを書こうとしたら混乱してきたので、catlxom の動作の流れを、特にプラグイン機構に注目して整理してみることにした。
</p>




<h3>起動時の流れ</h3>




<h4>Catlxom の基底クラス設定</h4>




<p class="entryBody">
まずは以下の2箇所のコードで、Catlxom の基底クラスを @Catlxom::ISA につっこむ。
</p>




<pre class="code">
use Catalyst qw(
    ConfigLoader
    Flavour
);
</pre>




<pre class="code">
__PACKAGE__-&gt;setup(
    do {
        my @plugin = qw/+Catlxom::Base/;
        push @plugin, 'Static::Simple'
            if ( $ENV{CATALYST_ENGINE} || '' ) =~ /^HTTP/;
        push @plugin, 'DebugScreen' if $ENV{CATALYST_DEBUG};

        @plugin;
    }
);
</pre>




<p class="entryBody">
これで @Catlxom::ISA は以下の様な感じになる。
</p>




<pre class="code">
@Catlxom::ISA = qw(
    <strong>Catlxom::Base</strong>
    Catalyst::Plugin::Static::Simple
    Catalyst::Plugin::ConfigLoader
    Catalyst::Plugin::Flavour
    Catalyst
    Catalyst::Controller
);
</pre>




<p class="entryBody">
catlxom 固有なのは、Catlxom::Base があるところ。
</p>




<h4>@Catlxom::ISA 中の基底クラスの setup を順に実行</h4>




<p class="entryBody">
Catlxom::Base::setup が実行される。実際のコードは以下の通り。
</p>




<pre class="code">
sub setup {
    my $class = shift;
    $class-&gt;NEXT::setup(@_);

    $class-&gt;catlxom-&gt;setup($class);
}
</pre>




<p class="entryBody">
$class-&gt;catlxom は、Class::Data::Inheritable を使ってこんな感じで定義されてる。
</p>




<pre class="code">
__PACKAGE__-&gt;mk_classdata( catlxom =&gt; Catlxom::Context-&gt;new );
</pre>




<p class="entryBody">
というわけでこの setup では、 Catlxom::Context の setup メソッドが実行される。
</p>




<h4>Catlxom::Context::setup の実行により catlxom プラグインをロード</h4>




<p class="entryBody">
Catlxom::Context は Catlxom::Context::Base を基底クラスとしていて、setup メソッドもこの基底クラスにある。こんな感じ。
</p>




<pre class="code">
sub setup {
    my ($self, $c) = @_;

    $self-&gt;plugin-&gt;load($c);
    {
        # plugin setup
        no warnings 'redefine';
        local *setup = sub { };
        $self-&gt;setup($c);
    }
}
</pre>




<p class="entryBody">
$self-&gt;plugin は Calss::Data::Inheritable でこんな風に定義されてる。
</p>




<pre class="code">
__PACKAGE__-&gt;mk_classdata( plugin  =&gt; Catlxom::Plugins-&gt;new );
</pre>




<p class="entryBody">
なのでこの setup メソッド中の $self-&gt;plugin-&gt;load($c) では、Catlxom::Plugins の load メソッドが実行される。このメソッドでは、@Catlxom::Context::ISA に catlxom プラグインクラスを基底クラスとしてつっこむ。@Catlxom::Context::ISA はこんな感じになる。
</p>




<pre class="code">
@Catlxom::Context::ISA = qw(
    Catlxom::Plugin::Entry::Blosxom
    Catlxom::Plugin::Filter::Path
    Catlxom::Plugin::Filter::Date
    Catlxom::Plugin::Format::Textile
    Catlxom::Plugin::Paginate::Simple
    Catlxom::Plugin::Template::TT
    Catlxom::Context::Base
);
</pre>




<p class="entryBody">
更におなじく setup メソッド中の
</p>




<pre class="code">
        # plugin setup
        no warnings 'redefine';
        local *setup = sub { };
        $self-&gt;setup($c);
</pre>




<p class="entryBody">
で、Catlxom::Context の基底クラス中の setup メソッドを NEXT で順に実行していく。つまり、各プラグインの setup メソッドを順次実行する。
</p>




<p class="entryBody">
ちなみに、各プラグインメソッド中の $self は Catlxom::Context クラスのインスタンスであって、各プラグインクラスのインスタンスではないので注意。$c は Catlxom クラス。
</p>




<p class="entryBody">
これで起動時のプラグインロード、セットアップが完了。

</p>




<h3>アクセス時の流れ</h3>




<h4>Catlxom::default を実行</h4>




<p class="entryBody">
ブラウザからアクセスすると Catlxom::default が実行される。実際のコードはこんな感じ。
</p>




<pre class="code">
sub default : Private {
    shift-&gt;catlxom-&gt;dispatch(shift);
}
</pre>




<p class="entryBody">
これで Catlxom::Context::dispatch が実行される。
</p>




<h4>Catlxom::Context::dispatch の実行</h4>




<p class="entryBody">
Catlxom::Context::dispatch の実体は Catlxom::Context::Base::dispatch であり、以下の様なコードになっている。
</p>




<pre class="code">
sub dispatch {
    my ( $self, $c ) = @_;

    $self-&gt;initialize($c);

    $self-&gt;start($c);
    $self-&gt;update($c);

    $self-&gt;entries-&gt;filter($c);
    $self-&gt;sort($c);
    $self-&gt;paginate($c);

    $self-&gt;fixedup($c);
    $self-&gt;interpolate($c);
    $self-&gt;end($c);
}
</pre>




<p class="entryBody">
これにより Catlxom::Context の基底クラス、つまり 各 catlxom プラグインの initialize, start などが NEXT で順次実行されていく。
</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/06/01/284/">Inside Jugem Key&#8217;s Backend</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2006-06-01T23:36:00+09:00" pubdate>Jun 1<span>st</span>, 2006</time>
        
         | <a href="/blog/2006/06/01/284/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="entryBody">
よくある Inside Backend 系の話と違って、ハードの話ではなくプログラムの話が中心です。
</p>




<p class="entryBody">
<a href="http://jugemkey.jp/api/auth/" target="_blank">JugemKey 認証 API の仕様や PHP/Perl ライブラリ</a> を読んだ方はお気づきだと思いますが、認証 API を利用するには2つのサーバにアクセスする必要があります。1つは secure.jugemkey.jp、もう 1つが api.jugemkey.jp です。
</p>




<p class="entryBody">
secure.jugemkey.jp の方は、直接ユーザに見える部分をを担当していて、PHP で開発されています。https://secure.jugemkey.jp/ で見えるところがこれにあたります。
</p>




<p class="entryBody">
api.jugemkey.jp はそのバックエンドで動いていて、実際のユーザ登録や認証などの処理はこいつが担当し、AtomPP ライクな API を実装しています。
</p>




<p class="entryBody">
つまり、secure.jugemkey.jp と api.jugemkey.jp の間のやりとりは、AtomPP でやってる、というわけですね。
</p>




<p class="entryBody">
で、今回の認証 API リリースでは、今まで secure.jugemkey.jp にしか開放していなかった API を、一部だけ外部に公開した、ということになります。
</p>




<p class="entryBody">
そもそもなぜフロントとバックを分けて API で繋ぐようにしたか、ということなんですが、認証 API の様に外部へ API を公開する、という目的もあるのですが、それよりもまず、JugemKey 自体の最初の目的が、ペパボの各サービスで分散されているユーザ管理を統合する、ということだったので、重要な機能は一箇所にまとめてそれを API でラップし、各サービスでは API を叩くライブラリを利用することにより、実装効率を高めてサービス間の連携を容易にする、という狙いがあったからです。
</p>




<p class="entryBody">
また、自分は Perl 好きで、ペパボは PHP メインの会社なわけですが、API で繋ぐことによってフロントとバックの実装を明確に分離することができると、お互い得意な言語に集中して実装できるというメリットもありますね。
</p>




<p class="entryBody">
あと、JugemKey 認証 API に関連するフロント部分は、自分が PHP で実装しているのですが、面倒な処理はバックエンドのサーバがやってくれて、フロントからは AtomPP な割とシンプルな API を叩くだけだし、PHP 用ライブラリは既に社内の PHP 得意な人が実装してくれてるし、といった感じで、PHP に慣れてない自分でも割とさくさく実装することができました。
</p>




<p class="entryBody">
転職したばかりの頃に <a href="http://mizzy.org/web/build_on_your_own_api.html" target="_blank">こんなエントリを書いた</a> のですが、まさにこれを実践した、というわけです。
</p>




<p class="entryBody">
話変わって AtomPP ライクな API を実装している api.jugemkey.jp ですが、こいつは Perl + Catalyst で実装されていて、特にコアな部分は、主に以下の CPAN モジュールに依存しています。
</p>




<ul class="entryBody">
<li><a href="http://search.cpan.org/perldoc/DBIx::Class" target="_blank">DBIx::Class</a></li>
<li><a href="http://search.cpan.org/perldoc/Catalyst::Model::DBIC::Schema" target="_blank">Catalyst::Model::DBIC::Schema</a></li>
<li><a href="http://search.cpan.org/perldoc/Catalyst::Plugin::AtomServer" target="_blank">Catalyst::Plugin::AtomServer</a></li>
<li><a href="http://search.cpan.org/perldoc/Catalyst::Plugin::AtomPP" target="_blank">Catalyst::Plugin::AtomPP</a></li>
<li><a href="http://search.cpan.org/perldoc/XML::Atom::Entry" target="_blank">XML::Atom::Entry</a></li>
</ul>




<p class="entryBody">
Catalyst::Plugin::AtomServer に含まれている C::P::Authentication::Credential::Atom は、当初 Basic 認証では crypted/hashed な形で保持されたパスワードに対応していなかったので、修正して使ってました。0.03 からこの修正をとりこんでもらっていますので、今は対応しています。
</p>




<p class="entryBody">
<a href="http://mizzy.org/?topic=/program/atom_client_with_catalyst" target="_blank">Catalyst で Atom API テストツール</a> を作ったのも、この様に AtomPP なサーバを実装してたからだったりします。
</p>




<p class="entryBody">
この手の Inside Backend 系の話は大好物なので、みんなどんどん公開してくれないかなー、と思ってるのですが、それなら自分も公開するのが筋だろう、ってことでこんなエントリ書いてみました。
</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/06/01/444/">Qooqle Video Clippers!</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2006-06-01T17:14:00+09:00" pubdate>Jun 1<span>st</span>, 2006</time>
        
         | <a href="/blog/2006/06/01/444/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="entryBody">
隣の席のオオヒダさんが、早速 JugemKey 認証 API を利用したステキサービスを作ってくれちゃいました。<a href="http://clippers.qooqle.jp/" target="_blank">Qooqle Video Clippers!</a> 
</p>




<p class="entryBody">
YouTube のお気に入り動画をがんがんクリップしてタグづけたりコメントつけたり、人気の動画を一覧で見たり RSS で購読したりできちゃいます。
</p>




<p class="entryBody">
<a href="http://clippers.qooqle.jp/tag/%E3%83%81%E3%83%A7%E3%82%B3%E3%83%9C%E3%83%BC%E3%82%A4" target="_blank">こんな風に特定のタグで見れば</a>、YouTube まとめサイトっぽくも使えるし。
</p>




<p class="entryBody">
Clippers! は参加型で集合知な感じなのが、他の見るだけの YouTube 系サービスと一線を画してますね。今後どう発展していくのか楽しみです。
</p>




<p class="entryBody">
認証は JugemKey だけではなく、はてな認証 API にも対応してるので、はてなユーザも登録なしで使えますよ。
</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/05/31/365/">Jugem Key 認証 Api リリース</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2006-05-31T12:47:00+09:00" pubdate>May 31<span>st</span>, 2006</time>
        
         | <a href="/blog/2006/05/31/365/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="entryBody">
<strong>追記</strong><br />
CPAN モジュールが Perl 5.8.7 じゃないとインストールできない、という指摘が宮川さんからありましたので、修正しました。CPAN に反映されるまで時間がかかりますので、<a href="http://mizzy.org/archives/WebService-JugemKey-Auth-0.03.tar.gz">ここから取得してください</a> 。モジュール作るのに h2xs を使うのはやめます。今は Module::Starter の時代らしいです。
</p>




<p class="entryBody">
<a href="http://jugemkey.jp/api/auth/" target="_blank">JugemKey 認証 API</a> がリリースされました。<a href="http://jugemkey.jp/api/auth/#faq_for_developers" target="_blank">PHP4, PHP5, Perl の 認証 API ライブラリも提供しています</a>。
</p>




<p class="entryBody">
基本的には、Flickr や はてなの認証 API とほぼ同等のものなのですが、<a href="http://labs.cybozu.co.jp/blog/kazuho/" target="_blank">Kazuho@Cybozu Labs</a>, <a href="http://d.hatena.ne.jp/tociyuki/" target="_blank">Tociyuki::Diary</a>, <a href="http://www.machu.jp/diary/" target="_blank">まちゅダイアリー</a> のはてな認証 API 関連エントリを参考にさせて頂きつつ、以下の様な独自の仕様を加えています。
</p>




<ul class="entryBody">
<li>署名コードの生成には HMAC_SHA1 を利用。</li>
<li>frob や token を認証 API に渡す際に、クエリストリングではなく、HTTP リクエストヘッダを利用。これは、特に今後の他サービス API の認証に token を利用するにあたって、クエリストリングはあくまでもサービス固有のクエリストリングとして使いたい、ということと、frob や token が Authorization や X-WSSE などの認証用 ヘッダの代わりになるものなので、ヘッダに入れるのが自然ではないか、という考え。</li>
<li>frob や token を認証 API に渡す際に、リクエスト時の日時もヘッダに含め、署名コードも日時を含めて生成する。API サーバ側では、署名とともに日時のチェックも行い、現在時刻から5分以上ずれているリクエストはリジェクトする。</li>
<li>コールバック URL はリクエスト毎に自由に設定可能。ただし、API キーの設定で指定された URL を含む URL である必要あり。</li>
</ul>




<p class="entryBody">
<a href="http://labs.cybozu.co.jp/blog/kazuho/archives/2006/05/scenario.php" target="_blank">はてな認証 API への攻撃シナリオ</a> にあるような、frob（はてなの場合は cert） の漏洩対策に関しては、今後の課題とさせてください。
</p>




<p class="entryBody">
API の仕様決めや Perl ライブラリを作成するにあたって、はてな認証 API や <a href="http://search.cpan.org/~naoya/Hatena-API-Auth/lib/Hatena/API/Auth.pm" target="_blank">Hatena::API::Auth</a> を大いに参考にさせて頂きました。なので、naoya さんに一言お伝えするのが礼儀だろうと思い、事前にメールさせて頂いたのですが、「全然気にしなくていいですよ。」と快いお返事が頂けました。naoya さん、ありがとうございました！
</p>




<p class="entryBody">
また、PHP5 用ライブラリは <a href="http://solvalou.net/" target="_blank">オオヒダさん</a> に作成して頂きました。しかもオオヒダさんはライブラリだけでなく…、とこれは後ほどのお楽しみ、ということで。オオヒダさん、ありがとうございます！
</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/05/28/428/">Catlxom メモ #3</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2006-05-28T12:04:00+09:00" pubdate>May 28<span>th</span>, 2006</time>
        
         | <a href="/blog/2006/05/28/428/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="entryBody">
$self->stash でセットした値を、$self->stashall で取り出すと、以下の様なハッシュリファレンスが返ってきます。
</p>




<pre class="code">
{
    'Catlxom::Plugin::Paginate::Simple' =&gt; {
        'pager' =&gt; bless( {
            'total_entries'    =&gt; 14,
            'current_page'     =&gt; 2,
            'entries_per_page' =&gt; '5'
        }, 'Data::Page' )
}
</pre>




<p class="entryBody">
で、これをテンプレートで扱おうとして、
</p>




<pre class="code">
&#x5b;% Catlxom::Plugin::Paginate::Simple.pager.current_page %&#x5d;
</pre>




<p class="entryBody">
などと記述すると、
</p>




<pre class="code">
unexpected token (Catlxom::Plugin::Paginate::Simple)
</pre>




<p class="entryBody">
といったエラーになります。: が入ってるのがまずいのと、冗長で書くのがめんどくさいので、以下の様な patch を書いてみました。
</p>




<pre class="code">
Index: lib/Catlxom/Context/Base.pm
===================================================================
--- lib/Catlxom/Context/Base.pm (revision 23)
+++ lib/Catlxom/Context/Base.pm (working copy)
@@ -57,7 +57,8 @@

 sub stash {
     my $self   = shift;
-    my $caller = caller(0);
+    ( my $caller = lc caller(0) ) =~ s/Catlxom::Plugin:://i;
+    $caller =~ s/::/_/g;

     if (@_) {
         my $stash = @_ &gt; 1 ? {@_} : $_[0];
</pre>




<p class="entryBody">
これでテンプレートの中で以下の様に記述できます。
</p>




<pre class="code">
&#x5b;% pagenate_simple.pager.current_page %&#x5d;
</pre>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/05/28/409/">Catlxom メモ #2</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2006-05-28T02:11:00+09:00" pubdate>May 28<span>th</span>, 2006</time>
        
         | <a href="/blog/2006/05/28/409/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="entryBody">
catlxom の Template::TT プラグイン で、$self-&gt;classdata-&gt;{tt}-&gt;process() がエラーになっても、真っ白な画面が表示されるだけで、エラーログにも何も出なくてかなり悩む羽目になったので patch 。
</p>




<pre class="code">
Index: plugins/Template/TT.pm
===================================================================
--- plugins/Template/TT.pm      (revision 23)
+++ plugins/Template/TT.pm      (working copy)
@@ -84,7 +84,7 @@
                 c =&gt; $c,
             },
             \$c-&gt;res-&gt;{body},
-        );
+        ) or $c-&gt;error( $self-&gt;classdata-&gt;{tt}-&gt;error );
     }

     $self-&gt;NEXT::interpolate($c);
</pre>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/05/27/290/">Catlxom メモ #1</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2006-05-27T21:10:00+09:00" pubdate>May 27<span>th</span>, 2006</time>
        
         | <a href="/blog/2006/05/27/290/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="entryBody">
catlxom の Template::TT プラグインで、INCLUDE_PATH を指定するための patch 。
</p>




<pre class="code">
Index: plugins/Template/TT.pm
===================================================================
--- plugins/Template/TT.pm      (revision 23)
+++ plugins/Template/TT.pm      (working copy)
@@ -10,15 +10,15 @@

 our $VERSION = '0.01';

+my $template_dir = Catlxom::Util::load_dir('template');
+my $path_root    = join '/', $template_dir->dir_list;
+
 __PACKAGE__->classdata->{templates} = {};
-__PACKAGE__->classdata->{tt}        = Template->new;
+__PACKAGE__->classdata->{tt}        = Template->new( INCLUDE_PATH => $path_root );

 sub setup {
     my ( $self, $c ) = @_;

-    my $template_dir = Catlxom::Util::load_dir('template');
-    my $path_root    = join '/', $template_dir->dir_list;
-
     $template_dir->recurse(
         callback => sub {
             my $file = shift;
</pre>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/05/27/456/">Catlxom メモ #0</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2006-05-27T20:05:00+09:00" pubdate>May 27<span>th</span>, 2006</time>
        
         | <a href="/blog/2006/05/27/456/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="entryBody">
今イタリアにいるらしい <a href="http://unknownplace.org/memo/" target="_blank">typester さん</a> 作の Catalyst meets Blosxom な <a href="http://catlxom.org/trac" target="_blank">catlxom</a> を最近触り始めました。（<a href="http://unknownplace.org/slides/catlxom/start.html" target="_blank">説明はこちら。</a>キャットルームと読むらしいです。）
</p>




<p class="entryBody">
で、Catalyst::Plugin::Flavour でいくつかはまったのでメモです。
</p>




<p class="entryBody">
まず、cpan コマンドで Catalyst::Plugin::Flavour をインストールすると、バージョン 0.02 が入るのですが、これだと catlxom は動きません。DEVELOPER RELEASE の 0.029_01 のソースをもってきてインストールする必要があります。
</p>




<p class="entryBody">
次に、個別エントリのパーマリンクページを表示させようとしても、全エントリが表示されてしまうので、調べてみたところ $c-&gt;flavour-&gt;fn の返り値が undef でした。というわけで Catalyst::Plugin::Flavour に一行追加してみた。
</p>




<pre class="code">
--- Flavour.pm.org      2006-05-27 19:31:19.000000000 +0900
+++ Flavour.pm  2006-05-27 19:57:43.000000000 +0900
@@ -79,6 +79,7 @@
     }
     elsif ( my ( $fn, $flavour ) = $path[-1] =~ /(.*)\.(.*?)$/ ) {

+        $c-&gt;flavour-&gt;fn($fn);
         $c-&gt;flavour-&gt;flavour($flavour);
         if ( $fn eq 'index' ) {
             pop @path;
</pre>




<p class="entryBody">
これで個別パーマリンクページがちゃんと表示されました。
</p>




<p class="entryBody">
いずれこのブログは、blosxom から catlxom へ移行しようと思います。まずは必要な blosxom プラグインの移植からですね。
</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/05/23/288/">Plagger/Plugin/Aggregator/Simple の Media Rss サポート</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2006-05-23T22:31:00+09:00" pubdate>May 23<span>rd</span>, 2006</time>
        
         | <a href="/blog/2006/05/23/288/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="entryBody">
Google Video は Media RSS を吐くので、<a href="http://trac.mizzy.org/public/browser/plagger/trunk/lib/Plagger/Plugin/Aggregator/Simple.pm" target="_blank">Aggregator::Simple を Media RSS に対応させてみた</a>。<a href="http://trac.mizzy.org/public/changeset/124" target="_blank">diff はこちら</a>。
</p>




<p class="entryBody">
でも、つくってから気づいたんだけど、Google Video の RSS にはちゃんと enclosure も入ってるので、別に Media RSS 対応させる必要なかった…。といっても、enclosure に入っているのは iPod 用の mpeg4 だけで、media:content 要素には他に flv, wmv, PSP 用の mpeg4 も含まれてるので、対応しておいても損ではないかな、と。
</p>




<p class="entryBody">
これで <a href="http://trac.mizzy.org/public/browser/plagger/trunk/lib/Plagger/Plugin/CustomFeed/GoogleVideo.pm" target="_blank">CustomFeed::GoogleVideo</a> はもう必要ないですね。
</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/05/22/318/">Plagger/Plugin/Custom Feed/I Tms #1</a></h1>
    
    
      <p class="meta">
        




  

<time datetime="2006-05-22T21:38:00+09:00" pubdate>May 22<span>nd</span>, 2006</time>
        
         | <a href="/blog/2006/05/22/318/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p class="entryBody">
<a href="http://trac.mizzy.org/public/browser/plagger/trunk/lib/Plagger/Plugin/CustomFeed/iTMS.pm" target="_blank">CustomFeed::iTMS</a> は内部で <a href="http://search.cpan.org/~billh/LWP-UserAgent-iTMS_Client/" target="_blank">LWP::UserAgent::iTMS_Client</a> を利用しているのですが、コンストラクタで国名を指定してもちゃんとハンドリングしてくれないので、パッチ書いた。ついでにモジュール作者にパッチ送っておいた。
</p>




<pre class="code">
--- iTMS_Client.pm.org  2006-05-22 16:06:46.000000000 +0900
+++ iTMS_Client.pm      2006-05-22 16:11:27.000000000 +0900
@@ -466,7 +466,7 @@
         'X-Apple-Tz'          => msec_since_epoch(),
         'X-Apple-Validation'  => $self->compute_validator( $url, $agent_name ),
         'Accept-Encoding'     => "gzip, x-aes-cbc",
-        'X-Apple-Store-Front' => $self->store_front,
+        'X-Apple-Store-Front' => $self->store_front($self->{protocol}->{country}),
     );
     $hdr->header( 'X-Token' => $self->{protocol}->{password_token} )
       if $self->{protocol}->{password_token};       
</pre>




<p class="entryBody">
<a href="http://trac.mizzy.org/public/browser/plagger/trunk/lib/Plagger/Plugin/CustomFeed/iTMS.pm" target="_blank">CustomFeed::iTMS</a> も修正して、国を指定できるようにし、pod も追加しました。これで日本の iTMS からも検索できます。query も UTF-8 であれば日本語も大丈夫。
</p>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/27/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/25/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/03/07/image-with-exif-tag-plugin/">Image with EXIF tag plugin</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/07/exif-tag-plugin/">EXIF tag plugin</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/04/rakuten-tag-plugin/">Rakuten tag plugin for Jekyll</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/29/paperboys-engineer-evaluation-system/">Paperboy&#8217;s engineer evaluation system</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/17/paperboy-is-hiring/">paperboy is hiring</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Coderwall</h1>
  <p>
  <script type="text/javascript">
    function display_coderwall(args) {
        var badges = args["data"]["badges"];
        for ( var i = 0; i < badges.length; i++ ) {
            document.write('<img src="'+ badges[i]["badge"] + '" width="48" height="48" />');
        }
    }
  </script>
  <script src="http://coderwall.com/mizzy.json?callback=display_coderwall"></script>
  </p>
  <p style="text-align: right;"><a href="http://coderwall.com/mizzy">Powered by coderwall.com</a></p>
</section>


<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/mizzy">@mizzy</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'mizzy',
            count: 30,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>




  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Gosuke Miyashita -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mizzyorg';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
